<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MAXI JDC MARKET ‚Äî Commande</title>

  <style>
    :root{
      --bg0:#061217;
      --bg1:#071a21;

      /* + lisible */
      --card:#0f2a33;
      --card2:#12313b;

      --line:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.94);
      --muted:rgba(255,255,255,.72);

      --accent:#2fbd9a;
      --accent2:#22c55e;
      --danger:#ff6b6b;
      --warn:#fbbf24;
      --pill:rgba(255,255,255,.07);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(47,189,154,.12), transparent 55%),
        radial-gradient(900px 700px at 80% 20%, rgba(34,197,94,.10), transparent 55%),
        radial-gradient(1000px 900px at 50% 100%, rgba(47,189,154,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    .wrap{
      max-width: 1280px;
      margin: 24px auto 70px;
      padding: 0 18px;
    }

    .top{
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius: 22px;
      padding: 18px 18px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .topRow{
      display:flex;
      align-items:center;
      gap:14px;
      flex-wrap: wrap;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 260px;
    }
    .logo{
      width:54px; height:54px; border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .logo img{width:100%; height:100%; object-fit:cover}
    .titleBlock .t1{
      font-weight: 900;
      letter-spacing:.4px;
      font-size: 20px;
      line-height: 1.05;
    }
    .titleBlock .t2{
      margin-top:2px;
      color: var(--muted);
      font-size: 12.5px;
    }

    .search{
      flex:1;
      min-width: 320px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .search input{
      flex:1;
      min-width: 260px;
      padding: 12px 14px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
    }
    .search input::placeholder{color: rgba(255,255,255,.55)}
    .btn{
      padding: 10px 14px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      cursor:pointer;
      font-weight:800;
      transition:.15s;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.08); }
    .btn.green{
      background: rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.40);
    }
    .btn.green:hover{ background: rgba(34,197,94,.25); }

    .pills{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
      margin-top: 10px;
    }
    .pill{
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: var(--pill);
      color: var(--text);
      font-size: 12.5px;
      display:flex;
      gap:8px;
      align-items:center;
      user-select:none;
    }

    /* panier pill */
    .cartPill{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.07);
      font-weight:900;
    }
    .cartPill:hover{ background:rgba(255,255,255,.10); }
    #cartTopCount{
      margin-left:8px;
      display:inline-block;
      min-width:26px;
      padding:2px 9px;
      border-radius:999px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      font-weight:900;
      text-align:center;
    }

    .noteBar{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: 12.5px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
    }
    .noteBar .ok{
      color: rgba(34,197,94,.95);
      font-weight: 900;
    }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 14px;
    }

    .panel{
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .panelHeader{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .panelHeader h3{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .sub{
      color: var(--muted);
      font-size: 12px;
    }

    .cats{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 8px;
    }
    .catBtn{
      text-align:left;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      transition: .15s;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .catBtn:hover{ background: rgba(255,255,255,.07) }
    .catBtn.active{
      background: rgba(47,189,154,.12);
      border-color: rgba(47,189,154,.45);
    }
    .catName{ font-weight: 900; }
    .catMeta{ color: var(--muted); font-size: 12px; margin-top:2px; }
    .badge{
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.20);
      font-weight: 900;
      font-size: 12px;
      white-space: nowrap;
    }

    .contentHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .contentHeader .leftInfo{
      min-width: 260px;
    }
    .contentHeader .h1{
      font-weight: 900;
      font-size: 14px;
      margin: 0;
    }
    .contentHeader .h2{
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
    }
    .pager{
      display:flex;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-size: 12px;
    }
    .circleBtn{
      width: 32px; height: 32px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      font-weight: 900;
    }
    .circleBtn:hover{ background: rgba(255,255,255,.08) }

    .cards{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    @media(max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
      .cards{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .pills{ justify-content:flex-start; }
      .brand{ min-width: 220px; }
    }
    @media(max-width: 650px){
      .cards{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.10));
      padding: 12px;
      position:relative;
      overflow:hidden;
    }
    .pname{
      font-weight: 950;
      letter-spacing:.2px;
      font-size: 13.5px;
      line-height: 1.15;
      margin:0 0 6px 0;
      color: rgba(255,255,255,.96);
    }
    .metaLine{
      color: rgba(255,255,255,.78);
      font-size: 12px;
      margin: 2px 0;
      word-break: break-word;
    }

    .pricePill{
      position:absolute;
      top: 10px;
      right: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(47,189,154,.16);
      border: 1px solid rgba(47,189,154,.35);
      font-weight: 950;
      font-size: 12px;
      color: rgba(255,255,255,.96);
    }

    .actions{
      margin-top: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .qtyBox{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      padding: 6px 10px;
      border-radius: 999px;
    }
    .miniBtn{
      width: 30px; height: 30px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-weight: 950;
    }
    .miniBtn:hover{ background: rgba(255,255,255,.10); }
    .qtyNum{ min-width: 26px; text-align:center; font-weight: 950; }

    /* drawer */
    .drawerOverlay{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 50;
    }
    .drawer{
      position: fixed;
      top:0; right:0;
      width: min(520px, 92vw);
      height: 100vh;
      background: rgba(10,20,26,.92);
      border-left: 1px solid var(--line);
      box-shadow: var(--shadow);
      transform: translateX(110%);
      transition: .18s ease;
      z-index: 60;
      display:flex;
      flex-direction:column;
      backdrop-filter: blur(10px);
    }
    .drawer.open{ transform: translateX(0); }
    .drawerOverlay.open{ display:block; }

    .drawerHead{
      padding: 16px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .drawerHead .h{
      font-weight: 950;
      letter-spacing:.2px;
    }
    .drawerBody{
      padding: 14px 16px;
      overflow:auto;
      flex:1;
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }
    .field input, .field textarea{
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 10px 12px;
      outline:none;
      resize: vertical;
      min-height: 40px;
    }
    .field textarea{ min-height: 64px; grid-column: 1 / -1; }

    .rowBtns{
      margin-top: 10px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
    }

    .hr{
      border-top:1px solid var(--line);
      margin: 14px 0;
    }

    .cartList{ display:flex; flex-direction:column; gap:10px; }
    .cartItem{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .cartItem .l{
      flex:1;
      min-width: 220px;
    }
    .cartItem .nm{
      font-weight: 950;
      font-size: 13px;
      margin:0 0 4px 0;
    }
    .cartItem .sm{
      color: var(--muted);
      font-size: 12px;
    }
    .cartItem .r{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
    }
    .cartItem .lineTotal{
      font-weight: 950;
    }

    .summaryBox{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .sumRow{
      display:flex;
      justify-content:space-between;
      color: var(--muted);
      font-size: 12.5px;
    }
    .sumRow b{ color: var(--text); }

    .drawerFoot{
      padding: 14px 16px;
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:space-between;
    }

    .table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .table th, .table td{
      border-bottom: 1px solid rgba(255,255,255,.10);
      padding: 8px 6px;
      text-align:left;
      color: var(--muted);
      vertical-align: top;
    }
    .table th{ color: rgba(255,255,255,.85); font-weight: 950; }
    .tag{
      display:inline-block;
      padding: 3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      font-weight: 900;
      font-size: 11px;
      margin-left: 6px;
    }

    .adminBar{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.20);
      color: var(--muted);
      font-size: 12px;
      display:none;
    }
    .adminBar.show{ display:block; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

  </style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div class="topRow">
        <div class="brand">
          <div class="logo">
            <img src="logo-maxi-jdc-market.jpg" alt="MAXI JDC MARKET"/>
          </div>
          <div class="titleBlock">
            <div class="t1">MAXI JDC MARKET</div>
            <div class="t2">Des prix mini ‚Äî Un MAXI choix</div>
          </div>
        </div>

        <div class="search" id="searchBox">
          <input id="q" type="text" placeholder="Rechercher un produit (nom, cat√©gorie, code)..." />
          <button class="btn" id="clearBtn">Effacer</button>
          <button class="btn green" id="globalBtn">Recherche globale</button>
        </div>

        <div class="pills" style="margin-left:auto">
          <div class="pill">üìç Jardins de Carthage, derri√®re mosqu√©e Essalem</div>
          <div class="pill">üïò 7h ‚Äì 1h</div>
          <div class="pill">üí¨ WhatsApp: <b>00216 25 600 978</b></div>

          <!-- Panier -->
          <div class="pill cartPill" id="cartTopBtn" title="Ouvrir le panier">
            üõí Panier <span id="cartTopCount">0</span>
          </div>
        </div>
      </div>

      <div class="noteBar">
        <span class="ok">‚úÖ</span>
        <span id="loadStatus">Chargement‚Ä¶</span>
        <span style="margin-left:auto" class="sub">
          Conditions : minimum livraison <b>15 dt</b> ¬∑ Livraison gratuite si total ‚â• <b>30 dt</b> ¬∑ Sinon frais <b>5 dt</b> ¬∑ Retrait magasin possible
        </span>
      </div>

      <div class="adminBar" id="adminHint">
        Admin: <b>Ctrl + Shift + A</b> (ou ajoute <span class="mono">?admin=1</span> dans l‚ÄôURL)
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <div class="panelHeader">
          <h3>Cat√©gories</h3>
          <div class="sub" id="catStatus">OK</div>
        </div>
        <div class="cats" id="cats"></div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="contentHeader">
          <div class="leftInfo">
            <div class="h1" id="activeLabel">Produits</div>
            <div class="h2" id="activeSub">S√©lectionne une cat√©gorie.</div>
          </div>
          <div class="pager">
            <div class="circleBtn" id="prevPage">‚Äπ</div>
            <div id="pageInfo">Page 1/1</div>
            <div class="circleBtn" id="nextPage">‚Ä∫</div>
            <span class="tag" id="countInfo">0 article(s)</span>
          </div>
        </div>

        <div class="cards" id="cards"></div>

        <!-- ADMIN PANEL -->
        <div class="hr"></div>
        <div id="adminPanel" style="display:none">
          <div class="panelHeader">
            <h3>üîß Admin</h3>
            <div class="sub">Commandes enregistr√©es (localStorage)</div>
          </div>

          <div class="rowBtns">
            <button class="btn" id="exportOrders">Exporter JSON</button>
            <button class="btn" id="clearOrders" style="border-color: rgba(255,107,107,.45); background: rgba(255,107,107,.12)">Vider commandes</button>
            <button class="btn" id="closeAdmin">Fermer admin</button>
          </div>

          <div class="hr"></div>

          <table class="table" id="ordersTable"></table>
        </div>

      </div>
    </div>

  </div>

  <!-- CART DRAWER -->
  <div class="drawerOverlay" id="overlay"></div>
  <div class="drawer" id="drawer">
    <div class="drawerHead">
      <div class="h">üõí Panier & Fiche client</div>
      <button class="btn" id="closeDrawer">Fermer</button>
    </div>

    <div class="drawerBody">
      <!-- CLIENT FORM -->
      <div class="panel" style="box-shadow:none; background: rgba(255,255,255,.02)">
        <div class="panelHeader" style="margin-bottom:6px">
          <h3 style="margin:0;font-size:13px">üë§ Fiche client (1 seule fois)</h3>
          <div class="sub" id="clientLockHint">‚Äî</div>
        </div>

        <div class="formGrid">
          <div class="field">
            <label>Nom</label>
            <input id="cName" placeholder="Nom et pr√©nom" />
          </div>
          <div class="field">
            <label>T√©l√©phone</label>
            <input id="cTel" placeholder="Ex: 25xxxxxx" />
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Adresse</label>
            <textarea id="cAddr" placeholder="Adresse + rep√®re‚Ä¶"></textarea>
          </div>

          <div class="field">
            <label>GPS (lat)</label>
            <input id="cLat" placeholder="36.xxxxx" />
          </div>
          <div class="field">
            <label>GPS (lng)</label>
            <input id="cLng" placeholder="10.xxxxx" />
          </div>
        </div>

        <div class="rowBtns">
          <button class="btn" id="gpsBtn">üìç Utiliser ma position</button>
          <button class="btn green" id="saveClientBtn">Enregistrer fiche</button>
          <button class="btn" id="editClientBtn" style="display:none">Modifier</button>
        </div>

        <div class="sub" style="margin-top:8px">
          Astuce: apr√®s enregistrement, la fiche est verrouill√©e (tu peux cliquer ‚ÄúModifier‚Äù si besoin).
        </div>
      </div>

      <div class="hr"></div>

      <!-- HISTORIQUE CLIENT (DANS PANIER) -->
      <div class="panel" style="box-shadow:none;background:rgba(255,255,255,.02); margin-bottom:12px">
        <div class="panelHeader" style="margin-bottom:6px">
          <h3 style="margin:0;font-size:13px">üßæ Historique client</h3>
          <div class="sub" id="histHint">Tape le t√©l√©phone pour voir l‚Äôhistorique</div>
        </div>
        <table class="table" id="clientHistoryTable"></table>
      </div>

      <!-- CART LIST -->
      <div class="cartList" id="cartList"></div>

      <div class="hr"></div>

      <!-- SUMMARY -->
      <div class="summaryBox">
        <div class="sumRow"><span>Sous-total</span><b id="subTotal">0,00 dt</b></div>
        <div class="sumRow"><span>Frais livraison</span><b id="shipFee">‚Äî</b></div>
        <div class="sumRow"><span>Total</span><b id="cartTotal">0,00 dt</b></div>
        <div class="sub" id="minHint" style="margin-top:6px">
          Minimum commande: 15 dt ‚Äî Livraison gratuite √† partir de 30 dt.
        </div>
      </div>
    </div>

    <div class="drawerFoot">
      <button class="btn" id="clearCartBtn">Vider panier</button>
      <button class="btn green" id="sendBtn">Envoyer</button>
    </div>
  </div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const WHATSAPP_NUMBER = "0021625600978"; // gard√© si un jour tu veux
    const MIN_ORDER = 15;
    const FREE_SHIPPING = 30;
    const SHIPPING_FEE = 5;

    const CATEGORIES = [
      { key:"fruits_legumes", label:"Fruits & L√©gumes", file:"data/fruits_legumes.csv" },
      { key:"lait_oeufs_produits_frais", label:"Lait, ≈íufs & Produits frais", file:"data/lait_oeufs_produits_frais.csv" },
      { key:"fromage_charcuterie", label:"Fromage & Charcuterie", file:"data/fromage_charcuterie.csv" },
      { key:"boulangerie_patisserie", label:"Boulangerie & P√¢tisserie", file:"data/boulangerie_patisserie.csv" },
      { key:"epicerie_salee", label:"√âpicerie Sal√©e", file:"data/epicerie_salee.csv" },
      { key:"epicerie_sucree", label:"√âpicerie Sucr√©e", file:"data/epicerie_sucree.csv" },
      { key:"pates", label:"P√¢tes", file:"data/pates.csv" },
      { key:"conserves", label:"Conserves", file:"data/conserves.csv" },
    ];

    /***********************
     * STATE + STORAGE
     ***********************/
    const state = {
      activeCat: CATEGORIES[0].key,
      global: false,
      page: 1,
      pageSize: 9,
      dataByCat: new Map(),
      cart: loadJSON("maxi_cart_v2", {}),
      admin: false
    };

    function $(id){ return document.getElementById(id); }
    function loadJSON(k, def){
      try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; }catch(e){ return def; }
    }
    function saveJSON(k, obj){ localStorage.setItem(k, JSON.stringify(obj)); }

    function fmtDT(n){
      const x = Number(n||0);
      return x.toFixed(2).replace('.', ',') + " dt";
    }

    /***********************
     * CSV PARSER
     ***********************/
    function parseCSV(text){
      // accepte s√©parateur ; ou , ou tab
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const items = [];
      for(const line of lines){
        const parts = line.split(/\t|;|,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.trim().replace(/^"|"$/g,''));
        // formats possibles:
        // code, name, price
        // ou code \t name \t price
        if(parts.length < 2) continue;
        const code = parts[0];
        const name = parts[1] || "";
        let price = parts[2] ?? parts[parts.length-1];
        price = String(price??"").replace(",",".");
        const p = Number(price);
        items.push({
          code,
          name,
          price: isFinite(p) ? p : 0
        });
      }
      return items;
    }

    async function loadAll(){
      $("loadStatus").textContent = "Chargement des CSV‚Ä¶";
      let okCount = 0;

      for(const c of CATEGORIES){
        try{
          const r = await fetch(c.file, { cache:"no-store" });
          if(!r.ok) throw new Error("HTTP " + r.status);
          const t = await r.text();
          const items = parseCSV(t).map(x => ({...x, catKey:c.key, catLabel:c.label}));
          state.dataByCat.set(c.key, items);
          okCount++;
        }catch(e){
          state.dataByCat.set(c.key, []);
          console.warn("Erreur CSV", c.file, e);
        }
      }

      $("loadStatus").innerHTML = `‚úÖ Donn√©es charg√©es depuis <b>/data/*.csv</b> ‚Äî une cat√©gorie = un fichier CSV.`;
      $("catStatus").textContent = (okCount === CATEGORIES.length) ? "OK" : ("Partiel");
      buildCats();
      render();
    }

    /***********************
     * CART LOGIC
     ***********************/
    function saveCart(){ saveJSON("maxi_cart_v2", state.cart); }
    function cartCount(){
      return Object.values(state.cart).reduce((a,b)=>a + (b.qty||0), 0);
    }
    function cartSubTotal(){
      return Object.values(state.cart).reduce((a,it)=>a + (Number(it.price)||0)*(it.qty||0), 0);
    }
    function shippingFee(){
      const total = cartSubTotal();
      if(total < MIN_ORDER) return null;
      if(total >= FREE_SHIPPING) return 0;
      return SHIPPING_FEE;
    }
    function grandTotal(){
      const fee = shippingFee();
      if(fee === null) return null;
      return cartSubTotal() + fee;
    }

    function addToCart(prod, delta){
      const key = prod.code || (prod.catKey + ":" + prod.name);
      const cur = state.cart[key] || { code: prod.code, name: prod.name, price: prod.price, cat: prod.catLabel, qty:0 };
      cur.price = Number(prod.price)||0;
      cur.name = prod.name;
      cur.code = prod.code;
      cur.cat = prod.catLabel;

      cur.qty = Math.max(0, (cur.qty||0) + delta);
      if(cur.qty === 0) delete state.cart[key];
      else state.cart[key] = cur;

      saveCart();
      refreshCartUI();
      renderTopCart();
      render(); // pour mettre √† jour les quantit√©s sur les cartes
    }

    function renderTopCart(){
      $("cartTopCount").textContent = cartCount();
    }

    /***********************
     * CLIENT (1ere fois)
     ***********************/
    function loadClient(){
      return loadJSON("maxi_client_v1", null);
    }
    function saveClient(obj){
      saveJSON("maxi_client_v1", obj);
    }
    function setClientLock(locked){
      const ids = ["cName","cTel","cAddr","cLat","cLng"];
      ids.forEach(id => $(id).disabled = locked);
      $("saveClientBtn").style.display = locked ? "none" : "";
      $("editClientBtn").style.display = locked ? "" : "none";
      $("clientLockHint").textContent = locked ? "Fiche enregistr√©e (verrouill√©e)" : "Remplis puis Enregistrer";
    }
    function fillClientForm(obj){
      $("cName").value = obj?.name || "";
      $("cTel").value = obj?.tel || "";
      $("cAddr").value = obj?.addr || "";
      $("cLat").value = obj?.gps?.lat || "";
      $("cLng").value = obj?.gps?.lng || "";
    }
    function readClientForm(){
      return {
        name: $("cName").value.trim(),
        tel: $("cTel").value.trim(),
        addr: $("cAddr").value.trim(),
        gps: { lat: $("cLat").value.trim(), lng: $("cLng").value.trim() }
      };
    }

    /***********************
     * ORDERS + HISTORIQUE
     ***********************/
    function loadOrders(){ return loadJSON("maxi_orders_v1", []); }
    function saveOrders(arr){ saveJSON("maxi_orders_v1", arr); }

    function buildOrderMessage(order){
      const c = order.customer || {};
      const lines = [];
      lines.push("üõí *Commande MAXI JDC MARKET*");
      lines.push(`üë§ Nom: ${c.name || "-"}`);
      lines.push(`üìû Tel: ${c.tel || "-"}`);
      lines.push(`üìç Adresse: ${c.addr || "-"}`);
      if(c.gps?.lat || c.gps?.lng) lines.push(`üß≠ GPS: ${c.gps.lat || ""} , ${c.gps.lng || ""}`);
      lines.push("");
      lines.push("*Articles:*");
      for(const it of order.items){
        const lt = (Number(it.price)||0) * (it.qty||0);
        lines.push(`‚Ä¢ ${it.qty} √ó ${it.name} (${it.code || "-"}) ‚Äî ${fmtDT(lt)}`);
      }
      lines.push("");
      lines.push(`Sous-total: ${fmtDT(order.subTotal)}`);
      lines.push(`Frais: ${order.fee === null ? "‚Äî" : fmtDT(order.fee)}`);
      lines.push(`‚úÖ Total: *${fmtDT(order.total)}*`);
      lines.push(`üïí ${new Date(order.id).toLocaleString()}`);
      return lines.join("\n");
    }

    function saveOrder(){
      const fee = shippingFee();
      if(fee === null) return null;

      // client: si pas encore enregistr√© -> on force
      let client = loadClient();
      if(!client){
        client = readClientForm();
        saveClient(client);
        setClientLock(true);
      }

      const items = Object.values(state.cart).map(it => ({
        code: it.code || "",
        name: it.name || "",
        price: Number(it.price)||0,
        qty: it.qty||0,
        cat: it.cat || ""
      }));

      const subTotal = cartSubTotal();
      const total = subTotal + fee;

      const order = {
        id: new Date().toISOString(),
        customer: client,
        items,
        subTotal,
        fee,
        total
      };

      const orders = loadOrders();
      orders.unshift(order);
      saveOrders(orders);
      return order;
    }

    function ordersOfPhone(tel){
      const t = (tel||"").replace(/\s+/g,"").trim();
      if(!t) return [];
      const orders = loadOrders();
      return orders.filter(o => ((o.customer?.tel||"").replace(/\s+/g,"").trim()) === t);
    }

    function renderClientHistory(){
      const tel = $("cTel").value.trim();
      const rows = ordersOfPhone(tel);
      const table = $("clientHistoryTable");

      if(!tel){
        $("histHint").textContent = "Tape le t√©l√©phone pour voir l‚Äôhistorique";
        table.innerHTML =
          `<tr><th>Date</th><th>Total</th><th>Articles</th></tr>
           <tr><td colspan="3" style="color:rgba(255,255,255,.55)">‚Äî</td></tr>`;
        return;
      }

      $("histHint").textContent = rows.length ? `Trouv√©: ${rows.length} commande(s)` : "Aucune commande trouv√©e";

      table.innerHTML = `<tr><th>Date</th><th>Total</th><th>Articles</th></tr>`;
      for(const o of rows.slice(0, 12)){
        const dt = new Date(o.id).toLocaleString();
        const itemsCount = (o.items||[]).reduce((a,x)=>a+(x.qty||0),0);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${dt}</td><td><b style="color:rgba(255,255,255,.92)">${fmtDT(o.total)}</b></td><td>${itemsCount}</td>`;
        table.appendChild(tr);
      }
    }

    /***********************
     * UI BUILD
     ***********************/
    function buildCats(){
      const box = $("cats");
      box.innerHTML = "";
      for(const c of CATEGORIES){
        const btn = document.createElement("div");
        btn.className = "catBtn" + (state.activeCat===c.key ? " active":"");
        const count = (state.dataByCat.get(c.key)||[]).length;
        btn.innerHTML = `
          <div>
            <div class="catName">${c.label}</div>
            <div class="catMeta">CSV: ${c.file.replace("data/","")}</div>
          </div>
          <div class="badge">${count} article(s)</div>
        `;
        btn.onclick = ()=>{
          state.activeCat = c.key;
          state.global = false;
          state.page = 1;
          buildCats();
          render();
        };
        box.appendChild(btn);
      }
    }

    function getFilteredItems(){
      const q = $("q").value.trim().toLowerCase();
      const all = [];

      if(state.global){
        for(const c of CATEGORIES){
          all.push(...(state.dataByCat.get(c.key)||[]));
        }
      }else{
        all.push(...(state.dataByCat.get(state.activeCat)||[]));
      }

      let items = all;

      if(q){
        items = items.filter(it =>
          (it.name||"").toLowerCase().includes(q) ||
          (it.code||"").toLowerCase().includes(q) ||
          (it.catLabel||"").toLowerCase().includes(q)
        );
      }

      return items;
    }

    function render(){
      // header
      const active = CATEGORIES.find(x=>x.key===state.activeCat);
      $("activeLabel").textContent = state.global ? "Recherche globale" : (active?.label || "Produits");
      $("activeSub").textContent = state.global
        ? "Recherche sur toutes les cat√©gories"
        : `Source: /${active?.file || ""} ¬∑ Mise √† jour rapide (prix + nouveaux articles)`;

      const items = getFilteredItems();

      const totalPages = Math.max(1, Math.ceil(items.length / state.pageSize));
      state.page = Math.min(state.page, totalPages);

      $("pageInfo").textContent = `Page ${state.page}/${totalPages}`;
      $("countInfo").textContent = `${items.length} article(s)`;

      const start = (state.page-1)*state.pageSize;
      const pageItems = items.slice(start, start + state.pageSize);

      const cards = $("cards");
      cards.innerHTML = "";

      for(const p of pageItems){
        const key = p.code || (p.catKey + ":" + p.name);
        const inCartQty = state.cart[key]?.qty || 0;

        const card = document.createElement("div");
        card.className = "card";

        const priceTxt = fmtDT(p.price);

        card.innerHTML = `
          <div class="pricePill">${priceTxt}</div>
          <p class="pname">${escapeHtml(p.name || "")}</p>
          <div class="metaLine">Code: <b>${escapeHtml(p.code || "-")}</b> ¬∑ ${escapeHtml(p.catLabel || "")}</div>

          <div class="actions">
            <div class="qtyBox" title="Quantit√© dans le panier">
              <button class="miniBtn" data-act="minus">‚àí</button>
              <div class="qtyNum" id="qty_${cssSafe(key)}">${inCartQty}</div>
              <button class="miniBtn" data-act="plus">+</button>
            </div>
            <button class="btn" data-act="add">Ajouter</button>
          </div>
        `;

        card.querySelector('[data-act="minus"]').onclick = ()=> addToCart(p, -1);
        card.querySelector('[data-act="plus"]').onclick = ()=> addToCart(p, +1);
        card.querySelector('[data-act="add"]').onclick = ()=> addToCart(p, +1);

        cards.appendChild(card);
      }

      if(!pageItems.length){
        cards.innerHTML = `<div class="sub">Aucun article trouv√©.</div>`;
      }

      refreshCartUI();
      renderTopCart();
    }

    function refreshCartUI(){
      // counts
      $("cartTopCount").textContent = cartCount();

      // list
      const list = $("cartList");
      list.innerHTML = "";

      const keys = Object.keys(state.cart);

      if(!keys.length){
        const e = document.createElement("div");
        e.className = "sub";
        e.textContent = "Panier vide. Ajoute des articles üôÇ";
        list.appendChild(e);
      } else {
        for(const k of keys){
          const it = state.cart[k];
          const lineTotal = (Number(it.price)||0) * (it.qty||0);

          const row = document.createElement("div");
          row.className = "cartItem";
          row.innerHTML = `
            <div class="l">
              <div class="nm">${escapeHtml(it.name || "")}</div>
              <div class="sm">Code: ${escapeHtml(it.code || "-")} ¬∑ ${escapeHtml(it.cat || "")}</div>
              <div class="sm">Prix: <b>${fmtDT(it.price)}</b></div>
            </div>
            <div class="r">
              <div class="qtyBox">
                <button class="miniBtn" data-a="-">‚àí</button>
                <div class="qtyNum">${it.qty || 0}</div>
                <button class="miniBtn" data-a="+">+</button>
              </div>
              <div class="lineTotal">${fmtDT(lineTotal)}</div>
            </div>
          `;
          row.querySelector('[data-a="-"]').onclick = ()=> addToCart({code:it.code,name:it.name,price:it.price,catLabel:it.cat,catKey:""}, -1);
          row.querySelector('[data-a="+"]').onclick = ()=> addToCart({code:it.code,name:it.name,price:it.price,catLabel:it.cat,catKey:""}, +1);
          list.appendChild(row);
        }
      }

      const sub = cartSubTotal();
      $("subTotal").textContent = fmtDT(sub);

      const fee = shippingFee();
      if(fee === null){
        $("shipFee").textContent = "‚Äî";
        $("cartTotal").textContent = "Minimum commande 15 dt";
        $("cartTotal").style.color = "var(--danger)";
      }else{
        $("shipFee").textContent = (fee === 0 ? "0,00 dt (gratuit)" : fmtDT(fee));
        $("cartTotal").textContent = fmtDT(sub + fee);
        $("cartTotal").style.color = "";
      }

      renderClientHistory();
    }

    /***********************
     * ADMIN
     ***********************/
    function openAdmin(){
      state.admin = true;
      $("adminPanel").style.display = "";
      $("adminHint").classList.add("show");
      renderAdmin();
    }
    function closeAdmin(){
      state.admin = false;
      $("adminPanel").style.display = "none";
      $("adminHint").classList.remove("show");
    }
    function renderAdmin(){
      const orders = loadOrders();
      const t = $("ordersTable");
      t.innerHTML = `<tr><th>Date</th><th>T√©l</th><th>Total</th><th>Articles</th></tr>`;

      if(!orders.length){
        t.innerHTML += `<tr><td colspan="4" style="color:rgba(255,255,255,.55)">Aucune commande enregistr√©e.</td></tr>`;
        return;
      }

      for(const o of orders.slice(0, 50)){
        const dt = new Date(o.id).toLocaleString();
        const tel = (o.customer?.tel || "-");
        const cnt = (o.items||[]).reduce((a,x)=>a+(x.qty||0),0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${dt}</td>
          <td><b style="color:rgba(255,255,255,.9)">${escapeHtml(tel)}</b></td>
          <td><b style="color:rgba(255,255,255,.9)">${fmtDT(o.total)}</b></td>
          <td>${cnt}</td>
        `;
        t.appendChild(tr);
      }
    }

    /***********************
     * DRAWER
     ***********************/
    function openDrawer(){
      $("overlay").classList.add("open");
      $("drawer").classList.add("open");
      refreshCartUI();
    }
    function closeDrawer(){
      $("overlay").classList.remove("open");
      $("drawer").classList.remove("open");
    }

    /***********************
     * HELPERS
     ***********************/
    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function cssSafe(s){
      return String(s).replace(/[^a-zA-Z0-9_-]/g, "_");
    }

    /***********************
     * INIT EVENTS
     ***********************/
    function init(){
      renderTopCart();

      // restore client (1ere fois)
      const client = loadClient();
      if(client){
        fillClientForm(client);
        setClientLock(true);
      }else{
        setClientLock(false);
      }

      $("cTel").addEventListener("input", renderClientHistory);

      $("gpsBtn").onclick = ()=>{
        if(!navigator.geolocation){
          alert("GPS non disponible sur ce navigateur.");
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos)=>{
            $("cLat").value = String(pos.coords.latitude.toFixed(6));
            $("cLng").value = String(pos.coords.longitude.toFixed(6));
          },
          ()=> alert("Impossible d‚Äôobtenir la position (autorisation refus√©e ?)"),
          { enableHighAccuracy:true, timeout:8000 }
        );
      };

      $("saveClientBtn").onclick = ()=>{
        const obj = readClientForm();
        if(!obj.tel){
          alert("T√©l√©phone obligatoire.");
          return;
        }
        saveClient(obj);
        setClientLock(true);
        renderClientHistory();
        alert("‚úÖ Fiche client enregistr√©e.");
      };

      $("editClientBtn").onclick = ()=>{
        setClientLock(false);
      };

      // search
      $("q").addEventListener("input", ()=>{ state.page=1; render(); });

      $("clearBtn").onclick = ()=>{
        $("q").value = "";
        state.page=1;
        state.global=false;
        buildCats();
        render();
      };

      $("globalBtn").onclick = ()=>{
        state.global = !state.global;
        state.page = 1;
        $("globalBtn").textContent = state.global ? "Recherche globale ‚úì" : "Recherche globale";
        render();
      };

      // pager
      $("prevPage").onclick = ()=>{
        state.page = Math.max(1, state.page-1);
        render();
      };
      $("nextPage").onclick = ()=>{
        const items = getFilteredItems();
        const totalPages = Math.max(1, Math.ceil(items.length/state.pageSize));
        state.page = Math.min(totalPages, state.page+1);
        render();
      };

      // drawer events
      $("cartTopBtn").onclick = openDrawer;
      $("overlay").onclick = closeDrawer;
      $("closeDrawer").onclick = closeDrawer;

      $("clearCartBtn").onclick = ()=>{
        state.cart = {};
        saveCart();
        refreshCartUI();
        renderTopCart();
        render();
      };

      // SEND (sans WhatsApp)
      $("sendBtn").onclick = async ()=>{
        if(!Object.keys(state.cart).length){
          alert("Panier vide.");
          return;
        }
        const fee = shippingFee();
        if(fee === null){
          alert("Minimum commande 15 dt.");
          return;
        }

        // si fiche pas enregistr√©e -> on force enregistrer
        if(!loadClient()){
          const obj = readClientForm();
          if(!obj.tel){
            alert("T√©l√©phone obligatoire (fiche client).");
            return;
          }
          saveClient(obj);
          setClientLock(true);
        }

        const order = saveOrder();
        if(!order){
          alert("Minimum commande 15 dt.");
          return;
        }

        const msg = buildOrderMessage(order);

        try{
          await navigator.clipboard.writeText(msg);
          alert("‚úÖ Commande enregistr√©e + r√©sum√© COPI√â. Colle-le o√π tu veux.");
        }catch(e){
          alert("‚úÖ Commande enregistr√©e. (Copie manuelle possible)");
          console.log(msg);
        }

        // vider panier apr√®s envoi
        state.cart = {};
        saveCart();
        refreshCartUI();
        renderTopCart();
        render();

        // admin refresh
        if(state.admin) renderAdmin();
      };

      // ADMIN shortcuts
      const url = new URL(location.href);
      if(url.searchParams.get("admin") === "1") openAdmin();

      document.addEventListener("keydown", (e)=>{
        if(e.ctrlKey && e.shiftKey && (e.key==="A" || e.key==="a")){
          e.preventDefault();
          state.admin ? closeAdmin() : openAdmin();
        }
      });

      $("exportOrders").onclick = ()=>{
        const orders = loadOrders();
        const blob = new Blob([JSON.stringify(orders,null,2)], {type:"application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "maxi_orders.json";
        a.click();
        URL.revokeObjectURL(a.href);
      };

      $("clearOrders").onclick = ()=>{
        if(confirm("Vider toutes les commandes enregistr√©es ?")){
          saveOrders([]);
          renderAdmin();
          renderClientHistory();
        }
      };

      $("closeAdmin").onclick = closeAdmin;
    }

    /***********************
     * START
     ***********************/
    init();
    loadAll();
  </script>
</body>
</html>
