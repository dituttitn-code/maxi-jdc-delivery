<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAXI JDC MARKET</title>
  <style>
    :root{
      --bg:#071628;
      --panel:#0c2137;
      --panel2:#0a1b2f;
      --text:#e8f0ff;
      --muted:#a9b6cc;
      --accent:#00e38a;
      --line:rgba(255,255,255,.08);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1100px 600px at 50% -200px, rgba(0,227,138,.25), transparent 60%),
                  radial-gradient(900px 500px at 0% 30%, rgba(0,150,255,.18), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .topbar{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }

    .brandrow{
      display:flex;
      gap:14px;
      align-items:center;
      flex-wrap:wrap;
    }
    .logo{
      width:46px;height:46px;border-radius:14px;
      border:1px solid rgba(0,227,138,.45);
      display:grid;place-items:center;
      background: rgba(0,0,0,.12);
      overflow:hidden;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .brand{
      display:flex;flex-direction:column;gap:2px;
      min-width:220px;
    }
    .brand b{font-size:20px;letter-spacing:.3px;color:var(--accent)}
    .brand span{font-size:12px;color:var(--muted)}
    .search{
      flex:1;
      display:flex;
      gap:10px;
      min-width:260px;
      align-items:center;
    }
    .search input{
      width:100%;
      height:44px;
      background: rgba(0,0,0,.22);
      border:1px solid var(--line);
      border-radius: 14px;
      color:var(--text);
      padding:0 14px;
      outline:none;
    }
    .btn{
      height:44px;
      padding:0 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      white-space:nowrap;
    }
    .btn.primary{
      border-color: rgba(0,227,138,.55);
      box-shadow: 0 0 0 2px rgba(0,227,138,.12) inset;
      color: var(--accent);
      font-weight:700;
    }

    .infrow{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .pill{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      color:var(--text);
      font-size:13px;
    }
    .pill small{color:var(--muted)}
    .right-tools{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    /* QR */
    .qr{
      display:flex;align-items:center;gap:10px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
    }
    .qr img{
      width:44px;height:44px;border-radius:12px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      object-fit:contain;
      padding:6px;
    }
    .qr .meta{display:flex;flex-direction:column;line-height:1.1}
    .qr .meta b{font-size:13px}
    .qr .meta span{font-size:11px;color:var(--muted)}
    .qr button{cursor:pointer}

    /* MAIN LAYOUT */
    .main{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }

    /* Categories horizontal bar */
    .cats{
      position:sticky;
      top:10px;
      z-index:5;
      background: linear-gradient(180deg, rgba(12,33,55,.92), rgba(12,33,55,.70));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:10px 10px;
      backdrop-filter: blur(8px);
    }
    .cat-scroll{
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:4px;
      scrollbar-width: thin;
    }
    .cat-scroll::-webkit-scrollbar{height:8px}
    .cat-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}
    .cat-btn{
      flex:0 0 auto;
      display:flex;align-items:center;gap:10px;
      padding:10px 14px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      transition: .15s ease;
    }
    .cat-btn:hover{border-color: rgba(0,227,138,.35)}
    .cat-btn.active{
      border-color: rgba(0,227,138,.65);
      box-shadow: 0 0 0 2px rgba(0,227,138,.12) inset;
      color: var(--accent);
      font-weight:700;
    }
    .cat-count{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(0,227,138,.35);
      color: var(--accent);
      font-size:12px;
      background: rgba(0,227,138,.08);
    }

    /* Products grid */
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      min-height: 240px;
    }
    .panel-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .panel-head h2{margin:0;font-size:16px}
    .panel-head small{color:var(--muted)}
    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width:1100px){ .grid{grid-template-columns: repeat(3, 1fr);} }
    @media (max-width:820px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width:520px){ .grid{grid-template-columns: 1fr;} }

    .card{
      border:1px solid var(--line);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(0,0,0,.18);
      display:flex;
      flex-direction:column;
      min-height: 340px;
    }

    /* ‚úÖ Photos non coup√©es */
    .card-media{
      height: 170px;
      background: rgba(255,255,255,.04);
      border-bottom: 1px solid var(--line);
      display:grid;
      place-items:center;
      padding:10px;
    }
    .card-media img{
      width:100%;
      height:100%;
      object-fit: contain;   /* <- IMPORTANT: ne coupe plus */
      border-radius: 14px;
      background: rgba(0,0,0,.15);
    }

    .card-body{padding:12px;display:flex;flex-direction:column;gap:8px;flex:1}
    .title-row{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .title-row b{font-size:14px;line-height:1.25}
    .price{
      border:1px solid rgba(0,227,138,.45);
      color:var(--accent);
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      background: rgba(0,227,138,.06);
    }
    .meta{color:var(--muted);font-size:12px}

    .actions{
      margin-top:auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .qty{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 8px;
      background: rgba(255,255,255,.04);
    }
    .qty button{
      width:28px;height:28px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
    }
    .qty span{min-width:18px;text-align:center;font-weight:700}

    .add{
      flex:1;
      height:36px;
      border-radius:999px;
      border:1px solid rgba(0,227,138,.55);
      background: rgba(0,227,138,.08);
      color:var(--accent);
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }

    /* ‚úÖ Stock: NON modifiable par clic */
    .stockline{
      display:flex;align-items:center;gap:10px;
      border-top:1px solid var(--line);
      padding:10px 12px;
      background: rgba(0,0,0,.12);
      font-size:13px;
    }
    .stock-badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-weight:800;
      pointer-events: none; /* <- m√™me si clic, √ßa ne fait rien */
      user-select:none;
    }
    .stock-badge.ok{
      border-color: rgba(0,227,138,.45);
      color: var(--accent);
      background: rgba(0,227,138,.08);
    }
    .stock-badge.no{
      border-color: rgba(255,90,90,.45);
      color: #ffb3b3;
      background: rgba(255,90,90,.08);
    }

    .empty{
      padding:18px;
      color:var(--muted);
      border:1px dashed rgba(255,255,255,.18);
      border-radius: 16px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- HEADER -->
    <div class="topbar">
      <div class="brandrow">
        <div class="logo">
          <!-- Remplace par ton logo -->
          <img src="assets/logo.png" alt="Logo" onerror="this.style.display='none'; this.parentElement.textContent='M';" />
        </div>

        <div class="brand">
          <b>MAXI JDC MARKET</b>
          <span>Des prix mini ‚Äî Un MAXI choix</span>
        </div>

        <div class="search">
          <input id="searchInput" placeholder="Rechercher un produit (nom, cat√©gorie, code)..." />
          <button class="btn" id="clearBtn">Effacer</button>
          <button class="btn primary" id="globalBtn">Recherche globale</button>
        </div>
      </div>

      <div class="infrow">
        <div class="pill">üìç <span>Jardins de Carthage, derri√®re mosqu√©e Essalem</span></div>
        <div class="right-tools">
          <div class="pill">üïí <span>7h ‚Äì 1h</span></div>
          <div class="pill">üí¨ <b style="color:var(--accent)">WhatsApp:</b> <span>00216 25 600 978</span></div>

          <!-- ‚úÖ QR code ajout√© -->
          <div class="qr">
            <img src="assets/qr-code.png" alt="QR Code" onerror="this.style.opacity=.35" />
            <div class="meta">
              <b>Scannez</b>
              <span>ouvrir le site</span>
            </div>
            <button class="btn" id="openQrBtn">Ouvrir</button>
          </div>

          <div class="pill">üõí <b>Panier:</b> <span id="cartCount">0</span></div>
          <div class="pill">‚úÖ <b id="loadedCount">0</b> <small>articles charg√©s</small></div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">

      <!-- ‚úÖ Categories horizontales en haut -->
      <div class="cats">
        <div class="cat-scroll" id="catBar"></div>
      </div>

      <!-- Produits -->
      <div class="panel">
        <div class="panel-head">
          <div>
            <h2 id="panelTitle">Tous les articles</h2>
            <small id="panelSub">Affichage clair et lisible (photos non coup√©es + cat√©gories en haut)</small>
          </div>
          <small id="resultCount"></small>
        </div>

        <div class="grid" id="grid"></div>
        <div id="empty" class="empty" style="display:none;">Aucun article trouv√©.</div>
      </div>

    </div>
  </div>

  <script>
    /**
     * ‚úÖ IMPORTANT: Stock NON modifiable
     * -> on l‚Äôaffiche uniquement depuis les donn√©es (admin/csv/json),
     * -> aucun clic ne le change.
     */

    // --- CONFIG CATEGORIES ---
    // Mets ici tes cat√©gories + fichiers (comme dans ton site actuel)
    const CATEGORIES = [
      { id:"all", name:"Tous", file:null },
      { id:"conserves", name:"Conserves", file:"data/conserves.csv" },
      { id:"cuisine_monde", name:"Cuisine du Monde", file:"data/cuisine_monde.csv" },
      { id:"eaux", name:"Eaux", file:"data/eaux.csv" },
      { id:"epicerie_salee", name:"√âpicerie Sal√©e", file:"data/epicerie_salee.csv" },
      { id:"epicerie_sucree", name:"√âpicerie Sucr√©e", file:"data/epicerie_sucree.csv" },
      { id:"fromage_charcuterie", name:"Fromage & Charcuterie", file:"data/fromage_charcuterie.csv" },
      { id:"fruits_legumes", name:"Fruits et L√©gumes", file:"data/fruits_legumes.csv" },
    ];

    // Format attendu CSV (flexible) : name|title, price, code, image, stock, category
    // stock: "en stock" / "rupture" / "out"
    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(l => l.trim().length);
      if (!lines.length) return [];
      const header = lines[0].split(",").map(s=>s.trim().toLowerCase());
      const rows = [];

      for (let i=1;i<lines.length;i++){
        const cols = splitCSVLine(lines[i]);
        const obj = {};
        header.forEach((h, idx)=> obj[h] = (cols[idx] ?? "").trim());

        const name = obj.name || obj.title || obj.produit || obj.nom || "Produit";
        const price = obj.price || obj.prix || "";
        const code  = obj.code || obj.sku || "";
        const image = obj.image || obj.img || obj.photo || "";
        const stock = (obj.stock || obj.etat || obj.disponibilite || "en stock").toLowerCase();

        rows.push({
          name,
          price,
          code,
          image,
          stock
        });
      }
      return rows;
    }

    // Split CSV line with basic quote support
    function splitCSVLine(line){
      const out = [];
      let cur = "";
      let inQ = false;
      for (let i=0;i<line.length;i++){
        const ch = line[i];
        if (ch === '"' ) { inQ = !inQ; continue; }
        if (ch === ',' && !inQ) { out.push(cur); cur=""; continue; }
        cur += ch;
      }
      out.push(cur);
      return out;
    }

    // --- STATE ---
    let allItems = [];      // toutes cat√©gories charg√©es
    let viewItems = [];     // items filtr√©s
    let activeCat = "all";
    let cart = new Map();   // id -> qty

    // --- UI refs ---
    const catBar = document.getElementById("catBar");
    const grid = document.getElementById("grid");
    const empty = document.getElementById("empty");
    const panelTitle = document.getElementById("panelTitle");
    const resultCount = document.getElementById("resultCount");
    const loadedCount = document.getElementById("loadedCount");
    const cartCount = document.getElementById("cartCount");
    const searchInput = document.getElementById("searchInput");
    const clearBtn = document.getElementById("clearBtn");
    const globalBtn = document.getElementById("globalBtn");

    // QR Open
    document.getElementById("openQrBtn").addEventListener("click", () => {
      // Mets ton URL ici (ou laisse)
      window.open(window.location.href, "_blank");
    });

    // --- INIT ---
    renderCatBar();
    loadAllCategories(); // charge tout d√®s le d√©but (comme ton compteur 1306)

    clearBtn.addEventListener("click", () => {
      searchInput.value = "";
      applyFilters();
    });

    globalBtn.addEventListener("click", () => {
      activeCat = "all";
      setActiveCatUI();
      applyFilters();
    });

    searchInput.addEventListener("input", () => applyFilters());

    // --- CATEGORIES BAR ---
    function renderCatBar(){
      catBar.innerHTML = "";
      for (const c of CATEGORIES){
        const btn = document.createElement("div");
        btn.className = "cat-btn" + (c.id === activeCat ? " active" : "");
        btn.dataset.cat = c.id;

        const name = document.createElement("span");
        name.textContent = c.name;

        const count = document.createElement("span");
        count.className = "cat-count";
        count.textContent = "‚Ä¶"; // mis √† jour apr√®s chargement

        btn.appendChild(name);
        btn.appendChild(count);

        btn.addEventListener("click", () => {
          activeCat = c.id;
          setActiveCatUI();
          applyFilters();
        });

        catBar.appendChild(btn);
      }
    }

    function setActiveCatUI(){
      [...catBar.querySelectorAll(".cat-btn")].forEach(b=>{
        b.classList.toggle("active", b.dataset.cat === activeCat);
      });
    }

    function setCatCount(catId, n){
      const el = catBar.querySelector(`.cat-btn[data-cat="${catId}"] .cat-count`);
      if (el) el.textContent = String(n);
    }

    // --- DATA LOADING ---
    async function loadAllCategories(){
      allItems = [];
      // Charge chaque cat√©gorie (sauf all)
      for (const c of CATEGORIES){
        if (!c.file) continue;
        try{
          const res = await fetch(c.file, { cache: "no-store" });
          const txt = await res.text();
          const items = parseCSV(txt).map((it, idx) => ({
            ...it,
            catId: c.id,
            catName: c.name,
            _id: `${c.id}-${idx}`
          }));
          allItems.push(...items);
          setCatCount(c.id, items.length);
        }catch(e){
          setCatCount(c.id, 0);
        }
      }
      setCatCount("all", allItems.length);
      loadedCount.textContent = allItems.length;
      applyFilters();
    }

    // --- FILTERING ---
    function applyFilters(){
      const q = (searchInput.value || "").trim().toLowerCase();

      let items = allItems;

      if (activeCat !== "all"){
        items = items.filter(x => x.catId === activeCat);
        const catName = CATEGORIES.find(c=>c.id===activeCat)?.name || "Cat√©gorie";
        panelTitle.textContent = catName;
      } else {
        panelTitle.textContent = "Tous les articles";
      }

      if (q){
        items = items.filter(x =>
          (x.name || "").toLowerCase().includes(q) ||
          (x.code || "").toLowerCase().includes(q) ||
          (x.catName || "").toLowerCase().includes(q)
        );
      }

      viewItems = items;
      renderGrid();
    }

    // --- RENDER PRODUCTS ---
    function renderGrid(){
      grid.innerHTML = "";
      empty.style.display = viewItems.length ? "none" : "block";
      resultCount.textContent = viewItems.length ? `${viewItems.length} r√©sultat(s)` : "";

      for (const p of viewItems){
        grid.appendChild(productCard(p));
      }
    }

    function productCard(p){
      const card = document.createElement("div");
      card.className = "card";

      const media = document.createElement("div");
      media.className = "card-media";
      const img = document.createElement("img");

      // Si image vide, fallback
      img.src = p.image || "assets/no-image.png";
      img.alt = p.name || "Produit";
      img.onerror = () => { img.src = "assets/no-image.png"; };

      media.appendChild(img);

      const body = document.createElement("div");
      body.className = "card-body";

      const titleRow = document.createElement("div");
      titleRow.className = "title-row";

      const title = document.createElement("b");
      title.textContent = (p.name || "").toUpperCase();

      const price = document.createElement("div");
      price.className = "price";
      price.textContent = p.price ? `${p.price}` : "‚Äî";

      titleRow.appendChild(title);
      titleRow.appendChild(price);

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `Code: ${p.code || "‚Äî"} ‚Ä¢ ${p.catName || ""}`;

      const actions = document.createElement("div");
      actions.className = "actions";

      const qty = document.createElement("div");
      qty.className = "qty";

      const minus = document.createElement("button");
      minus.textContent = "‚àí";
      const qtyVal = document.createElement("span");
      qtyVal.textContent = String(cart.get(p._id) || 0);
      const plus = document.createElement("button");
      plus.textContent = "+";

      minus.addEventListener("click", () => {
        const cur = cart.get(p._id) || 0;
        const next = Math.max(0, cur - 1);
        if (next === 0) cart.delete(p._id); else cart.set(p._id, next);
        qtyVal.textContent = String(cart.get(p._id) || 0);
        updateCartCount();
      });

      plus.addEventListener("click", () => {
        const cur = cart.get(p._id) || 0;
        cart.set(p._id, cur + 1);
        qtyVal.textContent = String(cart.get(p._id) || 0);
        updateCartCount();
      });

      qty.appendChild(minus);
      qty.appendChild(qtyVal);
      qty.appendChild(plus);

      const add = document.createElement("button");
      add.className = "add";
      add.textContent = "Ajouter";
      add.addEventListener("click", () => {
        const cur = cart.get(p._id) || 0;
        cart.set(p._id, cur + 1);
        qtyVal.textContent = String(cart.get(p._id) || 0);
        updateCartCount();
      });

      actions.appendChild(qty);
      actions.appendChild(add);

      // ‚úÖ Stock affich√© uniquement (non cliquable)
      const stockline = document.createElement("div");
      stockline.className = "stockline";
      const stockLabel = document.createElement("span");
      stockLabel.textContent = "üì¶ Stock:";
      const badge = document.createElement("span");
      badge.className = "stock-badge";

      const st = (p.stock || "en stock").toLowerCase();
      const isOk = st.includes("en stock") || st.includes("stock") || st === "ok" || st === "1" || st === "true";
      badge.textContent = isOk ? "En stock" : "Rupture";
      badge.classList.add(isOk ? "ok" : "no");

      // IMPORTANT : aucune action au clic
      badge.addEventListener("click", (e)=> e.preventDefault());

      stockline.appendChild(stockLabel);
      stockline.appendChild(badge);

      body.appendChild(titleRow);
      body.appendChild(meta);
      body.appendChild(actions);

      card.appendChild(media);
      card.appendChild(body);
      card.appendChild(stockline);

      return card;
    }

    function updateCartCount(){
      let total = 0;
      for (const v of cart.values()) total += v;
      cartCount.textContent = total;
    }
  </script>
</body>
</html>
