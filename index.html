<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#0a1929"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <title>MAXI JDC MARKET ‚Äî Commande</title>

  <style>
    :root{
      --bg0:#071525;
      --bg1:#0e2543;
      --card:#163557;
      --card2:#122a4a;
      --line:rgba(255,255,255,.14);
      --text:#f0f6fc;
      --muted:#9aa6b2;
      --accent:#00ff88;
      --accent2:#00d4ff;
      --danger:#ff6b6b;
      --shadow: 0 12px 45px rgba(0,0,0,.45);
      --radius:14px;
      --drawerW: 440px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 10% 10%, rgba(0,255,136,.10), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(0,212,255,.10), transparent 60%),
                  linear-gradient(135deg, var(--bg0) 0%, var(--bg1) 100%);
      min-height:100vh;
      line-height:1.55;
      overflow-x:hidden;
    }

    .wrap{
      max-width:1240px;
      margin:16px auto;
      padding:0 16px 40px;
      transition: padding-right .22s ease;
    }
    body.drawer-open .wrap{ padding-right: calc(var(--drawerW) + 18px); }

    /* TOP */
    .top{
      background: rgba(10,25,47,.88);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 8;
      backdrop-filter: blur(12px);
      margin-bottom: 14px; /* plus petit => plus d‚Äôespace pour les produits */
    }
    .topRow{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center;min-width:250px}
    .logo{
      width:54px;height:54px;border-radius:14px;border:2px solid var(--accent);
      overflow:hidden;display:grid;place-items:center;background:#071525;
      padding:6px;flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:contain;display:block}
    .brandText h1{
      font-size:22px;font-weight:900;letter-spacing:.2px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
    }
    .brandText p{margin-top:4px;color:var(--muted);font-size:13px}

    .search{flex:1 1 420px;display:flex;gap:10px;align-items:center;min-width:240px}
    .search input{
      flex:1;height:44px;border-radius:10px;border:2px solid var(--line);
      background: rgba(255,255,255,.08); color: var(--text);
      padding:0 14px; outline:none;font-size:14px;
      transition: all .15s ease; min-width: 200px;
    }
    .search input:focus{ border-color: var(--accent); background: rgba(255,255,255,.12); }
    .btn{
      height:44px;padding:0 16px;border-radius:10px;border:2px solid var(--line);
      background: rgba(255,255,255,.10); color: var(--text);
      cursor:pointer;font-weight:900;font-size:14px;
      transition: all .15s ease; white-space:nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.15); border-color: var(--accent); transform: translateY(-1px); }
    .btn.green{ background: rgba(0,255,136,.14); border-color: var(--accent); color: var(--accent); }
    .btn.green:hover{ background: rgba(0,255,136,.24); }

    .pills{
      margin-top:10px;
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      padding-top:10px;border-top:1px solid rgba(255,255,255,.08);
    }
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 14px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);font-size:13px;white-space:nowrap;
    }
    .pill strong{font-weight:900;color:var(--accent)}
    .pill.small{padding:6px 10px;font-size:12px;color:var(--muted)}
    .statusPill{
      border-color: rgba(0,255,136,.35);
      background: rgba(0,255,136,.06);
      color: rgba(210,255,235,.92);
      font-weight:800;
    }

    /* QR between WhatsApp and Panier */
    .qrPill{
      padding:6px 10px;
      gap:10px;
    }
    .qrWrap{
      width:34px;height:34px;border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      display:grid;place-items:center;overflow:hidden;
    }
    .qrWrap img{width:100%;height:100%;object-fit:cover;display:block}
    .qrText{display:flex;flex-direction:column;line-height:1.05}
    .qrText b{font-size:12px}
    .qrText span{font-size:11px;color:var(--muted)}

    .cartPill{
      margin-left:auto;cursor:pointer;border:2px solid var(--accent);
      background:rgba(0,255,136,.10);color:var(--accent);
      font-weight:900;
    }
    .cartPill:hover{ background:rgba(0,255,136,.18); transform: translateY(-1px); }
    #cartTopCount{
      margin-left:8px;display:inline-grid;place-items:center;
      min-width:26px;height:26px;padding:0 8px;border-radius:999px;
      background:rgba(0,0,0,.45);border:2px solid var(--accent);
      font-weight:900;color:var(--accent);
    }

    /* GRID */
    .grid{
      display:grid;
      grid-template-columns:300px 1fr;
      gap:14px;
      align-items:start;
    }
    .panel{
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: rgba(20,45,75,.72);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .panelHeader h3{font-size:15px;font-weight:900;color:var(--accent)}
    .panelHeader .sub{
      color:var(--muted);font-size:12px;
      background: rgba(255,255,255,.06);
      padding:4px 10px;border-radius:999px;
    }

    #cats{ padding:12px; display:flex; flex-direction:column; gap:10px; }
    .catBtn{
      width:100%;text-align:left;border-radius:12px;border:2px solid var(--line);
      background: rgba(255,255,255,.05); color: var(--text);
      padding:12px 12px; cursor:pointer;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      transition: all .15s ease;
    }
    .catBtn:hover{ background: rgba(255,255,255,.09); border-color: var(--accent2); transform: translateX(2px); }
    .catBtn.active{ border-color: var(--accent); background: rgba(0,255,136,.10); }
    .catLeft{display:flex;flex-direction:column;gap:3px;min-width:0;flex:1}
    .catTitle{ font-weight:900; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .catMeta{ color:var(--muted); font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .catCount{
      color:var(--accent); font-weight:900; font-size:12px;
      border:2px solid var(--accent); background: rgba(0,255,136,.10);
      border-radius:999px; padding:5px 10px; min-width: 86px; text-align:center;
      flex:0 0 auto;
    }

    .content{padding:16px}
    .contentHeader{
      display:flex;align-items:flex-end;justify-content:space-between;gap:12px;
      padding:0 0 14px 0;border-bottom:1px solid rgba(255,255,255,.10);
      margin-bottom: 14px;flex-wrap:wrap;
    }
    .contentHeader h2{font-size:18px;font-weight:900}
    .contentHeader .meta{margin-top:4px;color:var(--muted);font-size:12px}
    .pager{
      display:flex;gap:10px;align-items:center;justify-content:flex-end;
      color:var(--muted);font-size:13px;white-space:nowrap;
    }
    .iconBtn{
      width:40px;height:40px;border-radius:10px;border:2px solid var(--line);
      background: rgba(255,255,255,.08); cursor:pointer;color:var(--text);font-weight:900;
      display:flex;align-items:center;justify-content:center;transition: all .15s ease;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.14); border-color: var(--accent); transform: translateY(-1px); }

    /* PRODUCTS */
    #products{
      display:grid;
      grid-template-columns:repeat(3, minmax(0, 1fr));
      gap:14px;
    }

    .card{
      border-radius:14px;border:2px solid rgba(255,255,255,.12);
      background: rgba(17,38,70,.85);
      padding:12px;
      box-shadow: 0 10px 28px rgba(0,0,0,.22);
      display:flex;flex-direction:column;gap:10px;
      transition: all .15s ease;
      min-width:0;
    }
    .card:hover{ border-color: rgba(0,212,255,.55); transform: translateY(-2px); }

    /* Photo: propre + ne casse pas le titre */
    .imgWrap{
      width:100%;height:150px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:grid;place-items:center;overflow:hidden;position:relative;
    }
    .product-img{
      width:100%;height:100%;
      object-fit:contain;display:block;background:#ffffff;
    }
    .noPhoto{
      position:absolute;inset:0;display:none;place-items:center;
      color:rgba(255,255,255,.55);font-weight:900;font-size:13px;
      background: linear-gradient(135deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      text-align:center;padding:10px;
    }

    .namePrice{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;min-width:0}
    .name{
      font-weight:900;font-size:14px;line-height:1.35;min-width:0;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
    }
    .price{
      flex:0 0 auto;font-weight:900;padding:7px 12px;border-radius:999px;
      border:2px solid var(--accent);background: rgba(0,255,136,.10);
      color:var(--accent);font-size:13px;white-space:nowrap;
    }
    .meta2{color:var(--muted);font-size:12px;display:flex;flex-direction:column;gap:2px}

    /* Actions + Stock button under Ajouter */
    .actions{
      margin-top:auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:center;
    }
    .stepper{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:8px 10px;border-radius:999px;border:2px solid var(--line);
      background: rgba(0,0,0,.18);
      min-width:0;
    }
    .stepper button{
      width:32px;height:32px;border-radius:999px;border:2px solid var(--line);
      background: rgba(255,255,255,.10);color:var(--text);
      cursor:pointer;font-weight:900;display:flex;align-items:center;justify-content:center;
      transition: all .12s ease; flex:0 0 auto;
    }
    .stepper button:hover{ border-color: var(--accent); background: rgba(255,255,255,.18); }
    .stepper span{min-width:20px;text-align:center;font-weight:900}

    .addBtn{
      height:44px;border-radius:999px;border:2px solid var(--accent);
      background: rgba(0,255,136,.10);color:var(--accent);
      cursor:pointer;font-weight:900;font-size:13px;
      display:flex;align-items:center;justify-content:center;gap:8px;
      transition: all .12s ease; min-width:0;
    }
    .addBtn:hover{ background: rgba(0,255,136,.22); transform: translateY(-1px); }
    .addBtn:disabled{ opacity:.55; cursor:not-allowed; border-color: rgba(255,255,255,.18); color: rgba(255,255,255,.65); }

    .stockBtn{
      height:40px;border-radius:12px;border:2px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);color:var(--text);
      cursor:pointer;font-weight:900;font-size:12px;
      display:flex;align-items:center;justify-content:center;gap:8px;
      transition: all .12s ease; width:100%;
    }
    .stockBtn:hover{ border-color: rgba(0,212,255,.55); background: rgba(255,255,255,.10); }
    .stockTag{
      padding:3px 9px;border-radius:999px;font-size:11px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.22);font-weight:900;
    }
    .stockTag.ok{ border-color: rgba(0,255,136,.55); color: var(--accent); }
    .stockTag.no{ border-color: rgba(255,107,107,.70); color: var(--danger); }

    .hintAdmin{
      margin-top:12px;
      padding:12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size:11px;
      text-align:center;
    }

    /* DRAWER */
    .backdrop{
      position:fixed;inset:0;background: rgba(0,0,0,.55);
      opacity:0;pointer-events:none;transition: opacity .18s ease;
      z-index:19;
    }
    .backdrop.open{opacity:1;pointer-events:auto}

    .drawer{
      position:fixed;top:0;right:0;height:100%;
      width:var(--drawerW);max-width:95vw;
      background: rgba(8,20,38,.96);
      border-left:2px solid var(--accent);
      box-shadow:-22px 0 65px rgba(0,0,0,.65);
      transform: translateX(102%);
      transition: transform .22s ease;
      z-index:20;
      display:flex;flex-direction:column;
      backdrop-filter: blur(16px);
    }
    .drawer.open{transform:translateX(0)}
    .drawerHeader{
      padding:16px;border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,255,136,.05);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .drawerHeader h3{font-size:17px;font-weight:900;color:var(--accent);display:flex;gap:10px;align-items:center}
    .drawerBody{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
    .section{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(17,38,70,.78);
      border-radius:14px;padding:14px;
    }
    .section h4{
      margin:0 0 10px;
      font-size:13px;font-weight:900;color:var(--accent);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:800}
    .field input,.field textarea{
      width:100%;border-radius:12px;border:2px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color:var(--text);padding:12px;outline:none;font-size:13px;
      transition: all .12s ease;
    }
    .field input:focus,.field textarea:focus{border-color:var(--accent);background: rgba(255,255,255,.12)}
    .field textarea{min-height:74px;resize:vertical}

    .miniBtns{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .mini{
      height:40px;padding:0 16px;border-radius:999px;border:2px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.10);color:var(--text);
      cursor:pointer;font-weight:900;font-size:13px;transition: all .12s ease;
      display:inline-flex;align-items:center;justify-content:center;
    }
    .mini:hover{background: rgba(255,255,255,.18);transform: translateY(-1px)}
    .mini.green{background: rgba(0,255,136,.14);border-color:var(--accent);color:var(--accent)}
    .mini.green:hover{background: rgba(0,255,136,.24)}
    .mini.danger{background: rgba(255,107,107,.14);border-color:var(--danger);color:var(--danger)}
    .mini.danger:hover{background: rgba(255,107,107,.24)}

    .pinRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-top:10px;padding-top:10px;border-top:1px dashed rgba(255,255,255,.14);
      color:var(--muted);font-size:12px;
    }

    .cartList{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .cartItem{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius:14px;padding:12px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;
    }
    .cartItem .left{min-width:0;display:flex;flex-direction:column;gap:4px;flex:1}
    .cartItem .left .t{font-weight:900;font-size:13px;line-height:1.25;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .cartItem .left .s{color:var(--muted);font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .cartItem .right{display:flex;align-items:center;gap:10px;flex:0 0 auto}
    .lineTotal{font-weight:900;color:var(--accent);min-width:84px;text-align:right;white-space:nowrap}

    .totals{margin-top:10px;border-top:1px solid rgba(255,255,255,.10);padding-top:10px;display:flex;flex-direction:column;gap:8px}
    .totals .trow{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .totals .trow span{color:var(--muted)}
    .totals .trow strong{font-weight:900}

    .warn{
      margin-top:10px;padding:12px;border-radius:12px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color:var(--muted);font-size:12px;line-height:1.35;
    }
    .warn.bad{border-color: rgba(255,107,107,.45);color:#ffb9b9;background: rgba(255,107,107,.10)}
    .warn.good{border-color: rgba(0,255,136,.45);color:#b8ffd9;background: rgba(0,255,136,.08)}

    .drawerFooter{
      padding:14px;border-top:1px solid rgba(255,255,255,.10);
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      background: rgba(20,45,75,.75);
      flex-shrink:0;
    }

    /* Modal */
    .modalBack{
      position:fixed;inset:0;background: rgba(0,0,0,.7);
      display:none;align-items:center;justify-content:center;
      z-index:30;padding:18px;
    }
    .modalBack.open{display:flex}
    .modal{
      width:860px;max-width:95vw;
      border-radius: var(--radius);
      border:2px solid var(--accent);
      background: rgba(8,20,38,.96);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px;border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,255,136,.05);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .modalHead h3{font-size:16px;font-weight:900;color:var(--accent)}
    .modalBody{padding:14px}
    .modalBody textarea{
      width:100%;min-height:240px;border-radius:12px;border:2px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);color:var(--text);
      padding:12px;outline:none;font-size:13px;line-height:1.45;
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    .modalFoot{padding:14px;border-top:1px solid rgba(255,255,255,.10);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}

    /* Responsive */
    @media (max-width:1100px){
      .grid{grid-template-columns:1fr}
      #products{grid-template-columns:repeat(2,minmax(0,1fr))}
      body.drawer-open .wrap{ padding-right: 16px; } /* sur tablette: drawer overlay */
    }
    @media (max-width:768px){
      #products{grid-template-columns:1fr}
      .topRow{flex-direction:column;align-items:stretch}
      .search{width:100%}
      .drawer{width:100vw;max-width:100vw}
      .row2{grid-template-columns:1fr}
      .actions{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="topRow">
        <div class="brand">
          <div class="logo">
            <img src="logo-maxi-jdc-market.jpg" alt="MAXI JDC MARKET" onerror="this.style.display='none'">
          </div>
          <div class="brandText">
            <h1>MAXI JDC MARKET</h1>
            <p>Des prix mini ‚Äî Un MAXI choix</p>
          </div>
        </div>

        <div class="search">
          <input id="q" type="text" placeholder="üîç Rechercher un produit (nom, cat√©gorie, code)..." />
          <button class="btn" id="clearBtn">Effacer</button>
          <button class="btn green" id="globalBtn">Recherche globale</button>
        </div>
      </div>

      <div class="pills">
        <div class="pill">üìç Jardins de Carthage, derri√®re mosqu√©e Essalem</div>
        <div class="pill">üïí 7h ‚Äì 1h</div>
        <div class="pill"><strong>WhatsApp:</strong> 00216 25 600 978</div>

        <!-- QR (mets ton image QR dans le dossier du site) -->
        <div class="pill qrPill" title="Scannez pour ouvrir le site">
          <div class="qrWrap">
            <img src="qr.jpg" alt="QR" onerror="this.style.display='none'">
          </div>
          <div class="qrText">
            <b>Scannez</b>
            <span>ouvrir le site</span>
          </div>
        </div>

        <div class="pill cartPill" id="cartTopBtn" title="Ouvrir le panier">
          üõí Panier <span id="cartTopCount">0</span>
        </div>

        <div class="pill small statusPill" id="statusPill">Chargement‚Ä¶</div>
        <div class="pill small">Min 15 dt ‚Ä¢ Livraison gratuite ‚â• 30 dt ‚Ä¢ Sinon 5 dt</div>
      </div>
    </div>

    <!-- PRODUITS plus haut (noteBar supprim√©e) -->
    <div class="grid">
      <div class="panel">
        <div class="panelHeader">
          <h3>Cat√©gories</h3>
          <div class="sub" id="status">‚Ä¶</div>
        </div>
        <div id="cats"></div>
      </div>

      <div class="panel">
        <div class="content">
          <div class="contentHeader">
            <div>
              <h2 id="activeLabel">Produits</h2>
              <div class="meta" id="activeMeta">S√©lectionne une cat√©gorie.</div>
            </div>

            <div class="pager">
              <button class="iconBtn" id="prevBtn" title="Pr√©c√©dent">‚Äπ</button>
              <span id="pageInfo">Page 1/1</span>
              <button class="iconBtn" id="nextBtn" title="Suivant">‚Ä∫</button>
              <span id="countInfo">0 article(s)</span>
            </div>
          </div>

          <div id="products"></div>

          <div class="hintAdmin">
            ‚úÖ Le panier s‚Äôouvre automatiquement uniquement apr√®s ‚ÄúAjouter‚Äù, ou quand vous cliquez sur üõí Panier.
            Sur ordinateur, le panier ne cache pas les produits (il pousse l‚Äôinterface).
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="backdrop" id="backdrop" aria-hidden="true"></div>

  <aside class="drawer" id="drawer" aria-label="Panier">
    <div class="drawerHeader">
      <h3>üõí Panier & Client</h3>
      <button class="btn" id="closeDrawer">Fermer</button>
    </div>

    <div class="drawerBody">
      <!-- Client: 1√®re fois = fiche compl√®te, apr√®s = ŸÅŸÇÿ∑ t√©l√©phone => remplissage auto -->
      <div class="section" id="clientBox">
        <h4>
          <span>üë§ Client</span>
          <span class="sub" id="clientModeTxt"></span>
        </h4>

        <div class="field">
          <label>T√©l√©phone (obligatoire)</label>
          <input id="cTel" inputmode="tel" placeholder="Ex: 55xxxxxx" />
        </div>

        <div class="miniBtns">
          <button class="mini" id="findClientBtn">üîé Rechercher</button>
          <button class="mini" id="newClientBtn">‚ûï Nouveau</button>
        </div>

        <div id="clientDetails" style="margin-top:10px; display:none;">
          <div class="row2">
            <div class="field"><label>Nom</label><input id="cName" placeholder="Ex: Lotfi" /></div>
            <div class="field"><label>GPS (lat)</label><input id="cLat" placeholder="ex: 36.85" /></div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div class="field"><label>GPS (lng)</label><input id="cLng" placeholder="ex: 10.30" /></div>
            <div class="field"><label>‚Äî</label><button class="mini" id="gpsBtn" style="width:100%;">üìç Utiliser ma position</button></div>
          </div>

          <div class="field" style="margin-top:10px">
            <label>Adresse</label>
            <textarea id="cAddr" placeholder="Quartier, rue, rep√®re‚Ä¶"></textarea>
          </div>

          <div class="miniBtns">
            <button class="mini green" id="saveClientBtn">‚úÖ Enregistrer</button>
            <button class="mini" id="editClientBtn">‚úèÔ∏è Modifier</button>
          </div>

          <div class="warn" id="clientHint">
            üí° Premi√®re fois: remplissez la fiche puis Enregistrer. <br>
            Prochaine fois: entrez ŸÅŸÇÿ∑ t√©l√©phone ‚Üí la fiche se remplit automatiquement (sur cet appareil).
          </div>
        </div>

        <div class="pinRow">
          <label style="display:flex;gap:8px;align-items:center;cursor:pointer">
            <input type="checkbox" id="pinCart"> √âpingler le panier (laisser ouvert)
          </label>
          <span>üí° Pratique pour voir le total.</span>
        </div>
      </div>

      <div class="section">
        <h4><span>üß∫ Articles</span><span class="sub" id="cartMiniInfo">0 article(s)</span></h4>
        <div class="cartList" id="cartList"></div>

        <div class="totals">
          <div class="trow"><span>Sous-total</span><strong id="subTotal">0,00 dt</strong></div>
          <div class="trow"><span>Frais livraison</span><strong id="shipFee">0,00 dt</strong></div>
          <div class="trow"><span>Total</span><strong id="cartTotal">0,00 dt</strong></div>
        </div>

        <div class="warn" id="ruleBox"></div>
      </div>
    </div>

    <div class="drawerFooter">
      <button class="mini danger" id="clearCartBtn">Vider panier</button>
      <button class="mini green" id="sendBtn">üöÄ Envoyer</button>
    </div>
  </aside>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <h3>‚úÖ Commande ‚Äî R√©sum√©</h3>
        <button class="btn" id="closeModal">Fermer</button>
      </div>
      <div class="modalBody"><textarea id="orderText" readonly></textarea></div>
      <div class="modalFoot">
        <button class="mini" id="copyBtn">üìã Copier</button>
        <button class="mini" id="downloadBtn">üíæ T√©l√©charger (.txt)</button>
        <button class="mini green" id="whatsappBtn">üì± WhatsApp</button>
      </div>
    </div>
  </div>

<script>
/* ===================== PWA (Installable) ===================== */
/* ‚úÖ Un seul fichier HTML : manifest + service worker g√©n√©r√©s via Blob */
(function setupPWA(){
  try{
    const manifest = {
      name: "MAXI JDC MARKET",
      short_name: "MAXI JDC",
      start_url: "./",
      display: "standalone",
      background_color: "#0a1929",
      theme_color: "#0a1929",
      icons: [
        { src: "logo-maxi-jdc-market.jpg", sizes: "192x192", type: "image/jpeg" },
        { src: "logo-maxi-jdc-market.jpg", sizes: "512x512", type: "image/jpeg" }
      ]
    };
    const manifestBlob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
    const manifestURL = URL.createObjectURL(manifestBlob);
    const link = document.createElement("link");
    link.rel = "manifest";
    link.href = manifestURL;
    document.head.appendChild(link);

    if("serviceWorker" in navigator){
      const swCode = `
        const CACHE = "maxi-jdc-cache-v1";
        const CORE = [
          "./"
        ];
        self.addEventListener("install", (e)=>{
          e.waitUntil(caches.open(CACHE).then(c=>c.addAll(CORE)).then(()=>self.skipWaiting()));
        });
        self.addEventListener("activate", (e)=>{
          e.waitUntil(self.clients.claim());
        });

        // Network-first for CSV, cache-first for others
        self.addEventListener("fetch", (e)=>{
          const req = e.request;
          const url = new URL(req.url);
          if(url.pathname.endsWith(".csv")){
            e.respondWith(
              fetch(req).then(res=>{
                const copy = res.clone();
                caches.open(CACHE).then(c=>c.put(req, copy));
                return res;
              }).catch(()=>caches.match(req))
            );
            return;
          }
          e.respondWith(
            caches.match(req).then(cached=>{
              if(cached) return cached;
              return fetch(req).then(res=>{
                const copy = res.clone();
                caches.open(CACHE).then(c=>c.put(req, copy));
                return res;
              });
            })
          );
        });
      `;
      const swBlob = new Blob([swCode], {type:"text/javascript"});
      const swURL = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swURL).catch(()=>{});
    }
  }catch(e){}
})();

/* ===================== CONFIG ===================== */
const MIN_ORDER = 15;
const FREE_SHIPPING = 30;
const SHIPPING_FEE = 5;
const WHATSAPP_NUMBER = "21625600978";

/* Cat√©gories */
const CATEGORIES = [
  { key:"animaux_compagnie", label:"Animaux de Compagnie", file:"data/animaux_compagnie.csv" },
  { key:"bebe_maman", label:"B√©b√© et Maman", file:"data/bebe_maman.csv" },
  { key:"boulangerie_patisserie", label:"Boulangerie & P√¢tisserie", file:"data/boulangerie_patisserie.csv" },
  { key:"cafe", label:"Caf√©", file:"data/cafe.csv" },
  { key:"chips_snacks", label:"Chips et Snacks", file:"data/chips_snacks.csv" },
  { key:"chocolats_biscuits", label:"Chocolats et Biscuits", file:"data/chocolats_biscuits.csv" },
  { key:"conserves", label:"Conserves", file:"data/conserves.csv" },
  { key:"cuisine_monde", label:"Cuisine du Monde", file:"data/cuisine_monde.csv" },
  { key:"eaux", label:"Eaux", file:"data/eaux.csv" },
  { key:"epicerie_salee", label:"√âpicerie Sal√©e", file:"data/epicerie_salee.csv" },
  { key:"epicerie_sucree", label:"√âpicerie Sucr√©e", file:"data/epicerie_sucree.csv" },
  { key:"fromage_charcuterie", label:"Fromage & Charcuterie", file:"data/fromage_charcuterie.csv" },
  { key:"fruits_legumes", label:"Fruits et L√©gumes", file:"data/fruits_legumes.csv" },
  { key:"fruits_secs_noix", label:"Fruits Secs et Noix", file:"data/fruits_secs_noix.csv" },
  { key:"hygiene_entretien", label:"Hygi√®ne et Entretien", file:"data/hygiene_entretien.csv" },
  { key:"hygiene_soins", label:"Hygi√®ne & Soins", file:"data/hygiene_soins.csv" },
  { key:"jus_boissons", label:"Jus & Boissons", file:"data/jus_boissons.csv" },
  { key:"lait_oeufs_produits_frais", label:"Lait, ≈íufs & Produits frais", file:"data/lait_oeufs_produits_frais.csv" },
  { key:"pates", label:"P√¢tes", file:"data/pates.csv" },
  { key:"produits_surgeles", label:"Produits Surgel√©s", file:"data/produits_surgeles.csv" },
  { key:"vipa_selections", label:"VIPA S√©lections", file:"data/vipa_selections.csv" }
];

/* ===================== HELPERS ===================== */
const $ = (id)=>document.getElementById(id);
const fmtDT = (n)=>Number(n||0).toFixed(2).replace(".", ",") + " dt";
function safeKey(s){ return String(s||"").trim().toLowerCase().replace(/\s+/g,"_").replace(/[^\w\-]+/g,""); }
function dlText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}

/* ===================== STATE ===================== */
const state = {
  dataByCat: new Map(),
  activeCat: "cafe",
  global:false,
  q:"",
  page:1,
  perPage:9,
  qtyPick:{},
  cart:{},
  pinCart:false,
  stockByCode:{}, // { "2999": true/false }
  autoOpenOnAdd:true
};

/* ===================== STORAGE ===================== */
/* Clients DB: tel -> {name,tel,addr,lat,lng,updatedAt} */
function loadClientsDB(){
  try{ return JSON.parse(localStorage.getItem("maxi_clients_db_v1")||"{}") || {}; }catch(e){ return {}; }
}
function saveClientsDB(db){
  localStorage.setItem("maxi_clients_db_v1", JSON.stringify(db||{}));
}
function setClientInDB(client){
  const db = loadClientsDB();
  db[client.tel] = {...client, updatedAt: new Date().toISOString()};
  saveClientsDB(db);
}
function getClientFromDB(tel){
  const db = loadClientsDB();
  return db[tel] || null;
}

function loadLocal(){
  try{ state.cart = JSON.parse(localStorage.getItem("maxi_cart_v3")||"{}") || {}; }catch(e){ state.cart = {}; }
  try{ state.pinCart = localStorage.getItem("maxi_pin_cart_v3")==="1"; }catch(e){ state.pinCart=false; }
  try{ state.stockByCode = JSON.parse(localStorage.getItem("maxi_stock_v3")||"{}") || {}; }catch(e){ state.stockByCode={}; }
}
function saveCart(){ localStorage.setItem("maxi_cart_v3", JSON.stringify(state.cart)); }
function savePin(){ localStorage.setItem("maxi_pin_cart_v3", state.pinCart ? "1":"0"); }
function saveStock(){ localStorage.setItem("maxi_stock_v3", JSON.stringify(state.stockByCode||{})); }

/* ===================== CSV PARSER ===================== */
function parseCSV(text){
  const lines = String(text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const rows = [];
  for(const line0 of lines){
    const line = line0.trim();
    if(!line) continue;
    if(line.includes("CODE_ARTICLE") && line.includes("PRIX")) continue;
    if(line.startsWith(";") || line.startsWith("//")) continue;

    let parts = line.split("\t");
    if(parts.length < 3) parts = line.split(";");
    parts = parts.map(p=>String(p||"").trim());

    if(parts.length >= 3){
      const code = parts[0];
      const name = parts[1];
      let priceRaw = parts[2];
      priceRaw = priceRaw.replace(",", ".").replace(/[^0-9.]/g,"");
      const price = Number(priceRaw) || 0;
      if(code && name && price > 0){
        rows.push({ code:String(code).trim(), name:String(name).trim(), price });
      }
    }
  }
  return rows;
}

/* ===================== CART CALC ===================== */
function cartCount(){ return Object.values(state.cart).reduce((a,it)=>a+(it.qty||0),0); }
function cartTotal(){ return Object.values(state.cart).reduce((a,it)=>a+(Number(it.price)||0)*(it.qty||0),0); }
function shippingFee(){
  const total = cartTotal();
  if(total < MIN_ORDER) return null;
  if(total >= FREE_SHIPPING) return 0;
  return SHIPPING_FEE;
}
function grandTotal(){
  const fee = shippingFee();
  if(fee === null) return null;
  return cartTotal()+fee;
}

/* ===================== DRAWER ===================== */
function openDrawer(){
  $("drawer").classList.add("open");
  $("backdrop").classList.add("open");
  document.body.classList.add("drawer-open");
}
function closeDrawer(force=false){
  if(state.pinCart && !force) return;
  $("drawer").classList.remove("open");
  $("backdrop").classList.remove("open");
  document.body.classList.remove("drawer-open");
}

/* ===================== STOCK ===================== */
function isInStock(code){
  if(state.stockByCode[code] === undefined) return true;
  return !!state.stockByCode[code];
}
function toggleStock(code){
  state.stockByCode[code] = !isInStock(code);
  saveStock();
  render();
}

/* ===================== UI BUILD ===================== */
function buildCats(){
  const box = $("cats");
  box.innerHTML = "";
  for(const c of CATEGORIES){
    const btn = document.createElement("button");
    btn.className = "catBtn" + (state.activeCat===c.key ? " active" : "");
    btn.onclick = ()=>{
      state.activeCat = c.key;
      state.global = false;
      state.page = 1;
      buildCats();
      render();
    };

    const left = document.createElement("div");
    left.className = "catLeft";
    left.innerHTML = `<div class="catTitle">${c.label}</div><div class="catMeta">${c.file}</div>`;

    const count = document.createElement("div");
    count.className = "catCount";
    const items = state.dataByCat.get(c.key) || [];
    count.textContent = items.length + " article(s)";

    btn.appendChild(left);
    btn.appendChild(count);
    box.appendChild(btn);
  }
}
function getActiveCat(){ return CATEGORIES.find(x=>x.key===state.activeCat) || CATEGORIES[0]; }

function getVisibleItems(){
  let items = [];
  if(state.global){
    for(const c of CATEGORIES){
      const arr = state.dataByCat.get(c.key) || [];
      items.push(...arr.map(it=>({...it, catKey:c.key, catLabel:c.label})));
    }
  } else {
    const c = getActiveCat();
    const arr = state.dataByCat.get(c.key) || [];
    items = arr.map(it=>({...it, catKey:c.key, catLabel:c.label}));
  }

  const q = String(state.q||"").trim().toLowerCase();
  if(q){
    items = items.filter(it =>
      (it.name||"").toLowerCase().includes(q) ||
      (it.code||"").toLowerCase().includes(q) ||
      (it.catLabel||"").toLowerCase().includes(q)
    );
  }
  items.sort((a,b)=>String(a.name).localeCompare(String(b.name),"fr"));
  return items;
}

/* ===================== RENDER ===================== */
function render(){
  const active = getActiveCat();
  $("activeLabel").textContent = state.global ? "Recherche globale" : active.label;
  $("activeMeta").textContent = state.global ? "Toutes cat√©gories ‚Äî r√©sultats filtr√©s" : `${active.file}`;

  const items = getVisibleItems();
  const totalPages = Math.max(1, Math.ceil(items.length / state.perPage));
  if(state.page > totalPages) state.page = totalPages;

  const start = (state.page-1)*state.perPage;
  const pageItems = items.slice(start, start + state.perPage);

  $("pageInfo").textContent = `Page ${state.page}/${totalPages}`;
  $("countInfo").textContent = `${items.length} article(s)`;

  const box = $("products");
  box.innerHTML = "";

  if(pageItems.length === 0){
    box.innerHTML = `<div class="warn" style="grid-column:1/-1;text-align:center;padding:36px;">
      ${items.length === 0 ? 'Aucun article trouv√©' : 'Aucun article sur cette page'}
    </div>`;
  } else {
    for(const it of pageItems){
      const pid = safeKey(`${it.catKey}_${it.code}_${it.name}`);
      if(state.qtyPick[pid] == null) state.qtyPick[pid] = 0;

      const stockOk = isInStock(it.code);
      const imgSrc = `images/products/${it.code}.jpg`;

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="imgWrap">
          <img class="product-img" src="${imgSrc}" alt="${it.name}"
            onload="this.parentElement.querySelector('.noPhoto').style.display='none'; this.style.display='block';"
            onerror="this.style.display='none'; this.parentElement.querySelector('.noPhoto').style.display='grid';" />
          <div class="noPhoto">Aucune photo</div>
        </div>

        <div class="namePrice">
          <div class="name">${it.name}</div>
          <div class="price">${fmtDT(it.price)}</div>
        </div>

        <div class="meta2">
          <div>Code: ${it.code} ‚Ä¢ ${it.catLabel}</div>
        </div>

        <div class="actions">
          <div class="stepper">
            <button data-act="minus" title="Moins">‚àí</button>
            <span class="qv">${state.qtyPick[pid]||0}</span>
            <button data-act="plus" title="Plus">+</button>
          </div>
          <button class="addBtn" ${stockOk ? "" : "disabled"} title="${stockOk ? "Ajouter au panier" : "Rupture de stock"}">üß∫ Ajouter</button>
        </div>

        <button class="stockBtn" title="Changer √©tat stock (admin)">
          üì¶ Stock:
          <span class="stockTag ${stockOk ? "ok" : "no"}">${stockOk ? "En stock" : "Rupture"}</span>
        </button>
      `;

      // events
      card.querySelector('[data-act="minus"]').onclick = ()=>{
        state.qtyPick[pid] = Math.max(0, (state.qtyPick[pid]||0)-1);
        render();
      };
      card.querySelector('[data-act="plus"]').onclick = ()=>{
        state.qtyPick[pid] = (state.qtyPick[pid]||0)+1;
        render();
      };
      card.querySelector(".addBtn").onclick = ()=>{
        const q = state.qtyPick[pid]||0;
        if(q<=0) return;

        if(state.cart[pid]) state.cart[pid].qty += q;
        else state.cart[pid] = { pid, name:it.name, code:it.code, price:it.price, catLabel:it.catLabel, qty:q };

        state.qtyPick[pid] = 0;
        saveCart();
        refreshCartUI({ openAfterAdd:true });
        pulseCart();
      };

      // Stock button (si tu veux le garder uniquement admin, tu peux le d√©sactiver plus tard)
      card.querySelector(".stockBtn").onclick = ()=> toggleStock(it.code);

      box.appendChild(card);
    }
  }

  refreshCartUI({ openAfterAdd:false });
}

function pulseCart(){
  const cartBtn = $("cartTopBtn");
  cartBtn.animate(
    [{ transform:"scale(1)" }, { transform:"scale(1.06)" }, { transform:"scale(1)" }],
    { duration: 240, easing: "ease-out" }
  );
}

/* ===================== CART UI ===================== */
function refreshCartUI({ openAfterAdd }){
  $("cartTopCount").textContent = cartCount();
  $("cartMiniInfo").textContent = cartCount() + " article(s)";

  const list = $("cartList");
  list.innerHTML = "";
  const keys = Object.keys(state.cart);

  if(!keys.length){
    const e = document.createElement("div");
    e.className = "warn";
    e.textContent = "Panier vide. Ajoutez des articles üôÇ";
    list.appendChild(e);
  } else {
    for(const pid of keys){
      const it = state.cart[pid];

      const row = document.createElement("div");
      row.className = "cartItem";

      const left = document.createElement("div");
      left.className = "left";
      left.innerHTML = `<div class="t">${it.name}</div><div class="s">Code: ${it.code} ‚Ä¢ ${it.catLabel} ‚Ä¢ ${fmtDT(it.price)}</div>`;

      const right = document.createElement("div");
      right.className = "right";

      const step = document.createElement("div");
      step.className = "stepper";

      const minus = document.createElement("button");
      minus.textContent = "‚àí";
      minus.onclick = ()=>{
        it.qty = Math.max(0, (it.qty||0)-1);
        if(it.qty===0) delete state.cart[pid];
        saveCart();
        refreshCartUI({ openAfterAdd:false });
      };

      const val = document.createElement("span");
      val.textContent = it.qty||0;

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.onclick = ()=>{
        it.qty = (it.qty||0)+1;
        saveCart();
        refreshCartUI({ openAfterAdd:false });
      };

      step.appendChild(minus); step.appendChild(val); step.appendChild(plus);

      const lineTotal = document.createElement("div");
      lineTotal.className = "lineTotal";
      lineTotal.textContent = fmtDT((Number(it.price)||0) * (it.qty||0));

      right.appendChild(step);
      right.appendChild(lineTotal);

      row.appendChild(left);
      row.appendChild(right);
      list.appendChild(row);
    }
  }

  $("subTotal").textContent = fmtDT(cartTotal());
  const fee = shippingFee();
  $("shipFee").textContent = fee===null ? "‚Äî" : fmtDT(fee);

  const g = grandTotal();
  if(g===null){
    $("cartTotal").textContent = "Minimum commande 15 dt";
    $("cartTotal").style.color = "var(--danger)";
  } else {
    $("cartTotal").textContent = fmtDT(g);
    $("cartTotal").style.color = "var(--accent)";
  }

  const rule = $("ruleBox");
  const t = cartTotal();
  if(t <= 0){
    rule.className = "warn";
    rule.textContent = "Ajoutez des articles pour commencer.";
  } else if(t < MIN_ORDER){
    rule.className = "warn bad";
    rule.textContent = `‚ö†Ô∏è Minimum commande: ${MIN_ORDER} dt. Il manque ${fmtDT(MIN_ORDER - t)} (hors frais).`;
  } else if(t >= FREE_SHIPPING){
    rule.className = "warn good";
    rule.textContent = `‚úÖ Livraison gratuite (total ‚â• ${FREE_SHIPPING} dt).`;
  } else {
    rule.className = "warn";
    rule.textContent = `‚ÑπÔ∏è Frais livraison: ${SHIPPING_FEE} dt (gratuite √† partir de ${FREE_SHIPPING} dt).`;
  }

  // R√®gle d‚Äôouverture:
  if(state.pinCart) openDrawer();
  else if(openAfterAdd && state.autoOpenOnAdd) openDrawer();
}

/* ===================== CLIENT FLOW (tel => autofill) ===================== */
function setClientMode(txt){ $("clientModeTxt").textContent = txt || ""; }

function showClientDetails(show){
  $("clientDetails").style.display = show ? "block" : "none";
}

function lockClientDetails(locked){
  ["cName","cAddr","cLat","cLng"].forEach(id=>$(id).disabled = !!locked);
  $("gpsBtn").disabled = !!locked;
  $("saveClientBtn").disabled = !!locked;
}

function clearClientDetails(){
  $("cName").value = "";
  $("cAddr").value = "";
  $("cLat").value = "";
  $("cLng").value = "";
}

function fillClientDetailsFromObj(c){
  $("cName").value = c.name || "";
  $("cAddr").value = c.addr || "";
  $("cLat").value = c.lat || "";
  $("cLng").value = c.lng || "";
}

function findClientByTel(){
  const tel = $("cTel").value.trim();
  if(!tel){ alert("Entrez le num√©ro de t√©l√©phone."); return; }

  const c = getClientFromDB(tel);
  if(c){
    setClientMode("‚úÖ Client trouv√©");
    showClientDetails(true);
    fillClientDetailsFromObj(c);
    lockClientDetails(true);     // auto-fill + lock
  }else{
    setClientMode("‚ûï Nouveau client");
    showClientDetails(true);
    clearClientDetails();
    lockClientDetails(false);    // allow fill
    $("cName").focus();
  }
}

function newClient(){
  setClientMode("‚ûï Nouveau client");
  showClientDetails(true);
  clearClientDetails();
  lockClientDetails(false);
  $("cName").focus();
}

/* GPS (corrig√© / high accuracy) */
function useGPS(){
  if(!navigator.geolocation){
    alert("GPS non support√© sur cet appareil.");
    return;
  }
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      $("cLat").value = lat.toFixed(6);
      $("cLng").value = lng.toFixed(6);
    },
    ()=>{
      alert("Impossible d'obtenir la position (autorisation refus√©e ou GPS d√©sactiv√©).");
    },
    { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
  );
}

/* Save client */
function saveClient(){
  const tel = $("cTel").value.trim();
  const name = $("cName").value.trim();
  const addr = $("cAddr").value.trim();
  const lat  = $("cLat").value.trim();
  const lng  = $("cLng").value.trim();

  if(!tel){ alert("T√©l√©phone obligatoire."); return; }
  if(!name || !addr){
    alert("Veuillez remplir au moins Nom et Adresse.");
    return;
  }

  setClientInDB({ tel, name, addr, lat, lng });
  setClientMode("‚úÖ Enregistr√©");
  lockClientDetails(true);
  alert("‚úÖ Fiche client enregistr√©e !");
}

function editClient(){
  const tel = $("cTel").value.trim();
  if(!tel){ alert("Entrez le t√©l√©phone d‚Äôabord."); return; }
  const c = getClientFromDB(tel);
  if(!c){
    alert("Client non trouv√©. Cliquez 'Nouveau'.");
    return;
  }
  const ok = confirm("Modifier ce client ? (puis Enregistrer)");
  if(!ok) return;
  showClientDetails(true);
  fillClientDetailsFromObj(c);
  lockClientDetails(false);
}

/* ===================== LOAD DATA ===================== */
async function loadAll(){
  $("status").textContent = "Chargement‚Ä¶";
  $("statusPill").textContent = "Chargement‚Ä¶";
  let totalProducts = 0;

  for(const c of CATEGORIES){
    try{
      const r = await fetch(c.file, {cache:"no-store"});
      if(!r.ok){ state.dataByCat.set(c.key, []); continue; }
      const text = await r.text();
      const items = parseCSV(text);
      state.dataByCat.set(c.key, items);
      totalProducts += items.length;
    }catch(e){
      state.dataByCat.set(c.key, []);
    }
  }

  $("status").textContent = `${totalProducts} articles`;
  $("statusPill").textContent = `‚úÖ ${totalProducts} articles charg√©s`;
  buildCats();
  render();
}

/* ===================== EVENTS ===================== */
$("clearBtn").onclick = ()=>{ $("q").value=""; state.q=""; state.page=1; render(); };
$("globalBtn").onclick = ()=>{ state.global=true; state.page=1; render(); };
$("q").addEventListener("input", ()=>{ state.q=$("q").value; state.page=1; render(); });

$("prevBtn").onclick = ()=>{ state.page=Math.max(1,state.page-1); render(); };
$("nextBtn").onclick = ()=>{
  const total = getVisibleItems().length;
  const totalPages = Math.max(1, Math.ceil(total/state.perPage));
  state.page=Math.min(totalPages,state.page+1);
  render();
};

$("cartTopBtn").onclick = ()=> openDrawer();
$("closeDrawer").onclick = ()=> closeDrawer(false);
$("backdrop").onclick = ()=> closeDrawer(false);

$("pinCart").addEventListener("change", ()=>{
  state.pinCart = $("pinCart").checked;
  savePin();
  if(state.pinCart) openDrawer();
});

/* Client events */
$("findClientBtn").onclick = findClientByTel;
$("newClientBtn").onclick = newClient;
$("gpsBtn").onclick = useGPS;
$("saveClientBtn").onclick = saveClient;
$("editClientBtn").onclick = editClient;

// Auto search when user presses Enter in tel
$("cTel").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    findClientByTel();
  }
});

/* Cart */
$("clearCartBtn").onclick = ()=>{
  if(confirm("Vider tout le panier ?")){
    state.cart = {};
    saveCart();
    refreshCartUI({ openAfterAdd:false });
  }
};

/* Send */
$("sendBtn").onclick = ()=>{
  if(cartCount() === 0){ alert("Panier vide !"); return; }

  const tel = $("cTel").value.trim();
  if(!tel){ alert("Entrez votre t√©l√©phone (Client)."); openDrawer(); return; }

  const client = getClientFromDB(tel);
  if(!client){
    alert("Client non enregistr√©. Cliquez 'Nouveau' puis Enregistrer.");
    openDrawer();
    return;
  }

  const g = grandTotal();
  if(g === null){ alert(`Minimum commande: ${MIN_ORDER} dt`); return; }

  let summary = `=== COMMANDE MAXI JDC MARKET ===\n`;
  summary += `Date: ${new Date().toLocaleString('fr-FR')}\n`;
  summary += `Client: ${client.name}\n`;
  summary += `T√©l: ${client.tel}\n`;
  summary += `Adresse: ${client.addr}\n`;
  if(client.lat && client.lng) summary += `GPS: ${client.lat}, ${client.lng}\n`;
  summary += `\n=== ARTICLES ===\n`;

  Object.values(state.cart).forEach(item=>{
    summary += `‚Ä¢ ${item.name} (x${item.qty}) = ${fmtDT(item.price * item.qty)}\n`;
  });

  summary += `\n=== TOTAL ===\n`;
  summary += `Sous-total: ${fmtDT(cartTotal())}\n`;
  const fee = shippingFee();
  summary += `Livraison: ${fee === 0 ? 'GRATUITE' : fmtDT(fee)}\n`;
  summary += `TOTAL: ${fmtDT(g)}\n`;

  $("orderText").value = summary;
  $("modalBack").classList.add("open");
};

$("closeModal").onclick = ()=> $("modalBack").classList.remove("open");
$("copyBtn").onclick = ()=>{
  $("orderText").select();
  document.execCommand("copy");
  alert("‚úÖ Copi√© !");
};
$("downloadBtn").onclick = ()=>{
  const text = $("orderText").value;
  const date = new Date().toISOString().slice(0,10).replace(/-/g,'');
  const filename = `commande_${$("cTel").value.trim() || "client"}_${date}.txt`;
  dlText(filename, text);
};
$("whatsappBtn").onclick = ()=>{
  const text = encodeURIComponent($("orderText").value);
  window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${text}`, "_blank");
};

/* ===================== INIT ===================== */
loadLocal();
$("pinCart").checked = state.pinCart;
refreshCartUI({ openAfterAdd:false });
if(state.pinCart) openDrawer(); else closeDrawer(true);
loadAll();

// Client UI initial
setClientMode("Entrez Ÿáÿßÿ™ŸÅ ÿ´ŸÖ Rechercher");
showClientDetails(false);
</script>
</body>
</html>
