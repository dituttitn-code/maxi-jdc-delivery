<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAXI JDC MARKET ‚Äì Livraison</title>

  <style>
    :root{
      --bg:#0b0b0c;
      --panel:#121214;
      --panel2:#17171a;
      --soft:#1f1f24;
      --text:#f3f3f5;
      --muted:#a8a8b3;
      --border:rgba(255,255,255,.08);
      --accent:#00c853;
      --accent2:rgba(0,200,83,.25);
      --danger:#ff4d4d;
      --radius:18px;
      --radius-sm:14px;
      --shadow:0 10px 26px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% -10%, #1a1a1f 0%, var(--bg) 55%),
        linear-gradient(180deg, #0b0b0c 0%, #09090a 100%);
    }
    a{color:inherit}
    .wrap{max-width:1180px;margin:0 auto;padding:14px 12px 90px}

    /* Header sticky */
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(180deg, rgba(11,11,12,.96) 0%, rgba(11,11,12,.82) 70%, rgba(11,11,12,0) 100%);
      backdrop-filter: blur(10px);
      padding:10px 0 12px;
      border-bottom:1px solid rgba(255,255,255,.04);
    }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(18,18,20,.72);
      border-radius:22px;
      padding:10px 12px;
      box-shadow:var(--shadow);
    }

    .brand{display:flex;gap:10px;align-items:center;min-width:220px}
    .logo{
      width:42px;height:42px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:#111;overflow:hidden;
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{margin:0;font-size:15px;letter-spacing:.6px}
    .slogan{margin:2px 0 0;color:var(--muted);font-size:12px}

    .header-right{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;
    }
    .info{
      display:flex;flex-direction:column;gap:2px;
      font-size:12px;color:var(--muted);
      text-align:right;
    }
    .info strong{color:var(--text)}
    .qr-mini{
      width:44px;height:44px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;background:#fff;flex:0 0 auto;
    }
    .qr-mini img{width:100%;height:100%;object-fit:cover}

    .cart-pill{
      display:flex;align-items:center;gap:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(18,18,20,.85);
      padding:8px 10px;border-radius:999px;
      cursor:pointer;user-select:none;
      min-width:160px;justify-content:space-between;
    }
    .cart-pill .t{font-weight:800}
    .cart-pill .sub{font-size:12px;color:var(--muted)}
    .badge{
      min-width:26px;height:26px;border-radius:999px;
      background:var(--accent);color:#021a0c;
      display:grid;place-items:center;
      font-weight:900;font-size:12px;
    }

    /* Filters area */
    .section-title{
      margin:14px 0 8px;
      font-size:14px;
      color:var(--muted);
      letter-spacing:.3px;
      text-transform:uppercase;
    }

    .filters{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      margin:10px 0 10px;
    }

    .categories{
      display:flex;flex-wrap:wrap;gap:8px;
      margin:0;
      padding:0;
      list-style:none;
    }
    .cat{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(16,16,18,.72);
      color:var(--text);
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
    }
    .cat.active{
      background:var(--accent2);
      border-color:rgba(0,200,83,.45);
      color:#eafff2;
      font-weight:800;
    }

    .search{
      flex:1;min-width:240px;
      display:flex;gap:8px;align-items:center;
    }
    .search input{
      flex:1;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(18,18,20,.82);
      color:var(--text);
      outline:none;
    }
    .iconbtn{
      width:42px;height:42px;border-radius:999px;
      border:none;cursor:pointer;
      background:var(--accent);
      color:#021a0c;
      font-weight:900;
      display:grid;place-items:center;
    }

    .toolbar{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      margin:8px 0 12px;
      color:var(--muted);
      font-size:12px;
      justify-content:space-between;
    }
    .toolbar .left, .toolbar .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select{
      background:rgba(18,18,20,.82);
      color:var(--text);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:8px 10px;
      outline:none;
    }

    /* Grid */
    .grid{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width:1024px){ .grid{grid-template-columns:repeat(3, minmax(0,1fr));} }
    @media (max-width:820px){ .grid{grid-template-columns:repeat(2, minmax(0,1fr));} }
    @media (max-width:420px){ .grid{grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px;} }

    .card{
      border-radius:var(--radius-sm);
      border:1px solid var(--border);
      background:rgba(18,18,20,.92);
      box-shadow:0 10px 22px rgba(0,0,0,.22);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:300px;
    }

    /* ‚úÖ Image pro: m√™me zone, jamais √©tir√©e, jamais coup√©e */
    .imgbox{
      height:150px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border-bottom:1px solid rgba(255,255,255,.06);
      display:grid;place-items:center;
      padding:10px;
    }
    .imgbox img{
      width:100%;
      height:100%;
      object-fit:contain;
      object-position:center;
      display:block;
      filter:drop-shadow(0 6px 14px rgba(0,0,0,.35));
    }
    @media (max-width:420px){
      .imgbox{height:120px;padding:8px}
      .card{min-height:280px}
    }

    .body{
      padding:10px 10px 12px;
      display:flex;flex-direction:column;gap:8px;
      height:100%;
    }
    .name{
      font-weight:900;
      font-size:13px;
      line-height:1.15;
      min-height:34px;
    }
    .meta{
      font-size:12px;color:var(--muted);
      display:flex;justify-content:space-between;gap:10px;
    }
    .price{
      font-weight:900;
      font-size:14px;
      display:flex;justify-content:space-between;align-items:flex-end;
    }
    .price small{color:var(--muted);font-weight:700;font-size:12px}

    .actions{
      margin-top:auto;
      display:flex;gap:8px;align-items:center;
    }
    .qty{
      display:inline-flex;align-items:center;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;background:rgba(16,16,18,.80);
      height:40px;
    }
    .qty button{
      border:none;background:transparent;color:var(--text);
      width:40px;height:40px;
      font-size:18px;cursor:pointer;
    }
    .qty span{
      width:32px;text-align:center;font-weight:900;
    }
    .add{
      flex:1;height:40px;
      border:none;
      background:var(--accent);
      color:#021a0c;
      font-weight:900;
      border-radius:999px;
      cursor:pointer;
    }

    /* Pagination */
    .pager{
      margin:14px 0 0;
      display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;
      color:var(--muted);font-size:12px;
    }
    .pbtn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(18,18,20,.82);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      min-width:44px;
    }
    .pbtn.active{
      border-color:rgba(0,200,83,.45);
      background:var(--accent2);
      font-weight:900;
    }
    .pbtn:disabled{
      opacity:.45;cursor:not-allowed;
    }

    /* Cart drawer */
    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      z-index:1000;
    }
    .drawer{
      position:fixed;top:0;right:0;height:100%;width:min(420px, 92vw);
      background:rgba(18,18,20,.98);
      border-left:1px solid rgba(255,255,255,.10);
      box-shadow:-20px 0 40px rgba(0,0,0,.45);
      transform:translateX(100%);
      transition:.22s ease;
      z-index:1001;
      display:flex;flex-direction:column;
    }
    .drawer.open{transform:translateX(0)}
    .overlay.open{display:block}
    .dhead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .dhead h2{margin:0;font-size:16px}
    .close{
      width:40px;height:40px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      color:var(--text);cursor:pointer;font-size:18px;
    }
    .dcontent{padding:12px 14px;overflow:auto;flex:1}
    .item{
      display:grid;
      grid-template-columns:52px 1fr auto;
      gap:10px;
      padding:10px 0;
      border-bottom:1px solid rgba(255,255,255,.06);
      align-items:center;
    }
    .item img{
      width:52px;height:52px;border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:#0b0b0c;
      object-fit:contain;
      padding:6px;
    }
    .iname{font-weight:900;font-size:13px;line-height:1.1}
    .isub{color:var(--muted);font-size:12px;margin-top:4px}
    .iright{text-align:right}
    .iright .ip{font-weight:900}
    .row{
      display:flex;gap:8px;align-items:center;justify-content:space-between;
      margin-top:12px;color:var(--muted);
    }
    .total{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      display:flex;justify-content:space-between;align-items:center;
      font-weight:900;color:var(--text);
    }
    .dfoot{
      padding:12px 14px 16px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .btn{
      height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      padding:0 14px;
      cursor:pointer;
      flex:1;
      min-width:140px;
    }
    .btn.primary{
      background:var(--accent);
      color:#021a0c;
      border:none;
    }
    .btn.danger{
      background:rgba(255,77,77,.15);
      border:1px solid rgba(255,77,77,.35);
      color:#ffd9d9;
    }

    #loading{
      padding:12px;
      color:var(--muted);
      border:1px dashed rgba(255,255,255,.12);
      border-radius:14px;
      background:rgba(255,255,255,.02);
      text-align:center;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">
          <img src="logo-maxi-jdc-market.jpg" alt="MAXI JDC MARKET">
        </div>
        <div>
          <h1>MAXI JDC MARKET</h1>
          <div class="slogan">Des prix mini ‚Äì Un MAXI choix</div>
        </div>
      </div>

      <div class="header-right">
        <div class="info">
          <div>üìç Jardins de Carthage, derri√®re mosqu√©e Esselem</div>
          <div>‚è∞ 7h ‚Äì 1h du matin</div>
          <div>üì± WhatsApp : <strong>00216 25 600 978</strong></div>
        </div>

        <div class="qr-mini" title="QR site">
          <img src="qr-maxi-jdc-site.jpg" alt="QR MAXI JDC MARKET">
        </div>

        <div class="cart-pill" id="openCart">
          <div>
            <div class="t">üõí Panier</div>
            <div class="sub"><span id="cartTotalMini">0,000</span> dt</div>
          </div>
          <div class="badge" id="cartCountMini">0</div>
        </div>
      </div>
    </div>

    <div class="section-title">Cat√©gories</div>
    <ul class="categories" id="cats"></ul>

    <div class="filters">
      <div class="search">
        <input id="search" placeholder="Rechercher un produit‚Ä¶" />
        <button class="iconbtn" id="clearBtn" title="Effacer">‚úï</button>
      </div>
    </div>

    <div class="toolbar">
      <div class="left">
        <div><strong id="resultCount">0</strong> article(s)</div>
        <div>Cat√©gorie : <strong id="catLabel">Tout</strong></div>
      </div>
      <div class="right">
        <label>Par page&nbsp;
          <select id="perPage">
            <option value="12">12</option>
            <option value="18">18</option>
            <option value="24" selected>24</option>
            <option value="36">36</option>
          </select>
        </label>
      </div>
    </div>

    <div id="loading">Chargement des produits‚Ä¶</div>
    <div class="grid" id="grid"></div>

    <div class="pager" id="pager"></div>
  </div>
</header>

<!-- Cart drawer -->
<div class="overlay" id="overlay"></div>
<aside class="drawer" id="drawer">
  <div class="dhead">
    <h2>Votre panier</h2>
    <button class="close" id="closeCart">‚úï</button>
  </div>
  <div class="dcontent" id="cartList"></div>
  <div class="dcontent" style="padding-top:0">
    <div class="total">
      <span>Total</span>
      <span><span id="cartTotal">0,000</span> dt</span>
    </div>
    <div class="row">
      <span class="muted">Paiement</span>
      <span>√Ä la livraison</span>
    </div>
  </div>
  <div class="dfoot">
    <button class="btn danger" id="clearCart">Vider</button>
    <button class="btn primary" id="waOrder">Commander WhatsApp</button>
  </div>
</aside>

<script>
  // =========================
  // CONFIG
  // =========================
  const PRODUCTS_JSON_URL = "products.json";
  const PLACEHOLDER = "placeholder.jpg";
  const WHATSAPP_NUMBER = "21625600978"; // 00216 25 600 978 sans espaces
  const STORE_NAME = "MAXI JDC MARKET";
  const STORE_ADDRESS = "Jardins de Carthage, derri√®re mosqu√©e Esselem";
  const STORE_HOURS = "7h ‚Äì 1h du matin";

  // =========================
  // STATE
  // =========================
  let ALL = [];
  let CATS = [];
  let activeCat = "Tout";
  let searchTerm = "";
  let page = 1;
  let perPage = 24;

  // Cart in localStorage
  const CART_KEY = "maxi_jdc_cart_v1";
  let cart = loadCart();

  // =========================
  // HELPERS
  // =========================
  function fmtDt(n){
    const x = Number(n || 0);
    return x.toFixed(3).replace(".", ",");
  }
  function safeStr(v){ return String(v ?? "").trim(); }
  function normCat(v){
    const s = safeStr(v);
    return s || "Divers";
  }

  // ‚úÖ Image resolver (robuste)
  // R√®gle:
  // 1) si product.image contient "images/" -> on garde
  // 2) si product.image = "4731.jpg" (sans /) -> on suppose images/products/4731.jpg
  // 3) si placeholder -> on essaie images/<code>.jpg puis images/products/<code>.jpg
  //    sinon images/<id>.jpg puis images/products/<id>.jpg
  function resolveImage(product){
    const img = safeStr(product.image);
    const code = safeStr(product.code);
    const id = safeStr(product.id);

    // cas: chemin d√©j√† complet
    if (img && img.includes("/")) return img;

    // cas: juste un nom de fichier (ex: 4731.jpg)
    if (img && img !== PLACEHOLDER) return "images/products/" + img;

    // placeholder => auto par code/id
    if (code) return "images/" + code + ".jpg";     // 1er essai (tu as d√©j√† des images ici)
    if (id)   return "images/" + id + ".jpg";
    return "images/" + PLACEHOLDER;
  }

  // fallback: si images/<code>.jpg n'existe pas => images/products/<code>.jpg => placeholder
  function attachFallback(imgEl, product){
    const code = safeStr(product.code);
    const id = safeStr(product.id);
    let step = 0;

    imgEl.addEventListener("error", () => {
      step++;
      if (step === 1){
        if (code) { imgEl.src = "images/products/" + code + ".jpg"; return; }
        if (id)   { imgEl.src = "images/products/" + id + ".jpg"; return; }
        imgEl.src = "images/products/" + PLACEHOLDER; return;
      }
      imgEl.src = "images/products/" + PLACEHOLDER;
    });
  }

  function setHash(){
    const obj = new URLSearchParams();
    if (activeCat && activeCat !== "Tout") obj.set("cat", activeCat);
    if (searchTerm) obj.set("q", searchTerm);
    if (page > 1) obj.set("p", String(page));
    obj.set("pp", String(perPage));
    location.hash = obj.toString();
  }
  function loadHash(){
    const h = (location.hash || "").replace("#", "");
    const sp = new URLSearchParams(h);
    const cat = sp.get("cat");
    const q = sp.get("q");
    const p = Number(sp.get("p") || 1);
    const pp = Number(sp.get("pp") || 24);

    if (cat) activeCat = cat;
    if (q) searchTerm = q;
    if (Number.isFinite(p) && p >= 1) page = p;
    if ([12,18,24,36].includes(pp)) perPage = pp;
  }

  // =========================
  // CART
  // =========================
  function loadCart(){
    try{
      const raw = localStorage.getItem(CART_KEY);
      if (!raw) return {};
      return JSON.parse(raw) || {};
    }catch(e){ return {}; }
  }
  function saveCart(){
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
  }
  function cartCount(){
    return Object.values(cart).reduce((s,it)=> s + (it.qty||0), 0);
  }
  function cartTotal(){
    return Object.values(cart).reduce((s,it)=> s + (it.qty||0) * (it.price||0), 0);
  }
  function updateCartMini(){
    document.getElementById("cartCountMini").textContent = String(cartCount());
    document.getElementById("cartTotalMini").textContent = fmtDt(cartTotal());
  }
  function addToCart(product, qty){
    const key = safeStr(product.code) || safeStr(product.id);
    if (!key) return;
    if (!cart[key]){
      cart[key] = {
        key,
        code: safeStr(product.code),
        id: product.id,
        name: product.name,
        unit: product.unit || "pi√®ce",
        price: Number(product.price||0),
        image: product.image || PLACEHOLDER,
        qty: 0
      };
    }
    cart[key].qty += qty;
    if (cart[key].qty <= 0) delete cart[key];
    saveCart();
    updateCartMini();
    renderCartDrawer();
  }
  function clearCart(){
    cart = {};
    saveCart();
    updateCartMini();
    renderCartDrawer();
  }

  function renderCartDrawer(){
    const list = document.getElementById("cartList");
    list.innerHTML = "";
    const items = Object.values(cart);

    if (!items.length){
      list.innerHTML = `<div style="color:var(--muted);padding:8px 0">Votre panier est vide.</div>`;
    } else {
      items.forEach(it=>{
        const row = document.createElement("div");
        row.className = "item";

        const img = document.createElement("img");
        // on r√©utilise le resolver avec un objet produit compatible
        img.src = resolveImage({id:it.id, code:it.code, image:it.image});
        attachFallback(img, {id:it.id, code:it.code, image:it.image});

        const mid = document.createElement("div");
        const name = document.createElement("div");
        name.className = "iname";
        name.textContent = it.name;
        const sub = document.createElement("div");
        sub.className = "isub";
        sub.textContent = `${it.qty} √ó ${fmtDt(it.price)} dt / ${it.unit}`;
        mid.appendChild(name);
        mid.appendChild(sub);

        const right = document.createElement("div");
        right.className = "iright";
        const p = document.createElement("div");
        p.className = "ip";
        p.textContent = fmtDt((it.qty||0)*(it.price||0)) + " dt";

        const controls = document.createElement("div");
        controls.style.marginTop = "8px";
        controls.style.display = "flex";
        controls.style.justifyContent = "flex-end";
        controls.style.gap = "6px";

        const bMinus = document.createElement("button");
        bMinus.className = "pbtn";
        bMinus.textContent = "‚àí";
        bMinus.onclick = ()=> addToCart(it, -1);

        const bPlus = document.createElement("button");
        bPlus.className = "pbtn";
        bPlus.textContent = "+";
        bPlus.onclick = ()=> addToCart(it, +1);

        controls.appendChild(bMinus);
        controls.appendChild(bPlus);

        right.appendChild(p);
        right.appendChild(controls);

        row.appendChild(img);
        row.appendChild(mid);
        row.appendChild(right);
        list.appendChild(row);
      });
    }

    document.getElementById("cartTotal").textContent = fmtDt(cartTotal());
  }

  function buildWhatsAppMessage(){
    const items = Object.values(cart);
    const total = cartTotal();

    let msg = `üõí *Commande ${STORE_NAME}*\n`;
    msg += `üìç ${STORE_ADDRESS}\n`;
    msg += `‚è∞ ${STORE_HOURS}\n\n`;
    msg += `*Articles :*\n`;

    items.forEach(it=>{
      const lineTotal = (it.qty||0)*(it.price||0);
      const codePart = it.code ? ` (${it.code})` : "";
      msg += `- ${it.qty} √ó ${it.name}${codePart} = ${fmtDt(lineTotal)} dt\n`;
    });

    msg += `\n*Total :* ${fmtDt(total)} dt\n\n`;
    msg += `Nom & Adresse de livraison :\n`;
    msg += `T√©l√©phone :\n`;
    msg += `Remarque :\n`;

    return msg;
  }

  function openWhatsAppOrder(){
    if (!cartCount()){
      alert("Votre panier est vide.");
      return;
    }
    const text = encodeURIComponent(buildWhatsAppMessage());
    const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${text}`;
    window.open(url, "_blank");
  }

  // Drawer open/close
  function openDrawer(){
    document.getElementById("overlay").classList.add("open");
    document.getElementById("drawer").classList.add("open");
  }
  function closeDrawer(){
    document.getElementById("overlay").classList.remove("open");
    document.getElementById("drawer").classList.remove("open");
  }

  // =========================
  // FILTERING + PAGINATION
  // =========================
  function matches(p){
    const catOk = (activeCat === "Tout") || (p.category === activeCat);
    if (!catOk) return false;

    if (!searchTerm) return true;
    const q = searchTerm.toLowerCase().trim();
    const hay = (p.name + " " + p.category + " " + (p.code||"") + " " + (p.id||"")).toLowerCase();
    return hay.includes(q);
  }

  function getFiltered(){
    return ALL.filter(matches);
  }

  function clampPage(maxPage){
    if (page < 1) page = 1;
    if (page > maxPage) page = maxPage;
  }

  function renderCategories(){
    const ul = document.getElementById("cats");
    ul.innerHTML = "";

    const allCats = ["Tout", ...CATS];
    allCats.forEach(c=>{
      const li = document.createElement("li");
      const b = document.createElement("button");
      b.className = "cat" + (c === activeCat ? " active" : "");
      b.textContent = c;
      b.onclick = ()=>{
        activeCat = c;
        page = 1; // ‚úÖ pagination par cat√©gorie
        setHash();
        render();
      };
      li.appendChild(b);
      ul.appendChild(li);
    });
  }

  function renderGrid(list){
    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    list.forEach(p=>{
      const card = document.createElement("div");
      card.className = "card";

      const imgBox = document.createElement("div");
      imgBox.className = "imgbox";
      const img = document.createElement("img");
      img.alt = p.name || "Produit";
      img.src = resolveImage(p);
      attachFallback(img, p);
      imgBox.appendChild(img);

      const body = document.createElement("div");
      body.className = "body";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = p.name;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `<span>${p.category}</span><span>${p.code || p.id || ""}</span>`;

      const price = document.createElement("div");
      price.className = "price";
      price.innerHTML = `<span>${fmtDt(p.price)} dt</span><small>/ ${p.unit || "pi√®ce"}</small>`;

      const actions = document.createElement("div");
      actions.className = "actions";

      const qty = document.createElement("div");
      qty.className = "qty";
      const minus = document.createElement("button");
      minus.textContent = "‚àí";
      const q = document.createElement("span");
      q.textContent = "1";
      const plus = document.createElement("button");
      plus.textContent = "+";

      minus.onclick = ()=> q.textContent = String(Math.max(1, Number(q.textContent)-1));
      plus.onclick  = ()=> q.textContent = String(Number(q.textContent)+1);

      qty.appendChild(minus);
      qty.appendChild(q);
      qty.appendChild(plus);

      const add = document.createElement("button");
      add.className = "add";
      add.textContent = "Ajouter";
      add.onclick = ()=>{
        addToCart(p, Number(q.textContent));
      };

      actions.appendChild(qty);
      actions.appendChild(add);

      body.appendChild(name);
      body.appendChild(meta);
      body.appendChild(price);
      body.appendChild(actions);

      card.appendChild(imgBox);
      card.appendChild(body);
      grid.appendChild(card);
    });
  }

  function renderPager(totalItems){
    const pager = document.getElementById("pager");
    pager.innerHTML = "";
    const totalPages = Math.max(1, Math.ceil(totalItems / perPage));
    clampPage(totalPages);

    // Prev
    const prev = document.createElement("button");
    prev.className = "pbtn";
    prev.textContent = "‚Üê";
    prev.disabled = page <= 1;
    prev.onclick = ()=>{ page--; setHash(); render(); };
    pager.appendChild(prev);

    // Page numbers (compact)
    const show = 5;
    let start = Math.max(1, page - Math.floor(show/2));
    let end = Math.min(totalPages, start + show - 1);
    start = Math.max(1, end - show + 1);

    if (start > 1){
      const b1 = document.createElement("button");
      b1.className = "pbtn";
      b1.textContent = "1";
      b1.onclick = ()=>{ page=1; setHash(); render(); };
      pager.appendChild(b1);

      if (start > 2){
        const dots = document.createElement("span");
        dots.textContent = "‚Ä¶";
        pager.appendChild(dots);
      }
    }

    for (let i=start;i<=end;i++){
      const b = document.createElement("button");
      b.className = "pbtn" + (i===page ? " active" : "");
      b.textContent = String(i);
      b.onclick = ()=>{ page=i; setHash(); render(); };
      pager.appendChild(b);
    }

    if (end < totalPages){
      if (end < totalPages-1){
        const dots = document.createElement("span");
        dots.textContent = "‚Ä¶";
        pager.appendChild(dots);
      }
      const bl = document.createElement("button");
      bl.className = "pbtn";
      bl.textContent = String(totalPages);
      bl.onclick = ()=>{ page=totalPages; setHash(); render(); };
      pager.appendChild(bl);
    }

    // Next
    const next = document.createElement("button");
    next.className = "pbtn";
    next.textContent = "‚Üí";
    next.disabled = page >= totalPages;
    next.onclick = ()=>{ page++; setHash(); render(); };
    pager.appendChild(next);

    // info
    const info = document.createElement("span");
    info.style.marginLeft = "8px";
    info.textContent = `Page ${page}/${totalPages}`;
    pager.appendChild(info);
  }

  function render(){
    const filtered = getFiltered();

    document.getElementById("resultCount").textContent = String(filtered.length);
    document.getElementById("catLabel").textContent = activeCat;

    // paginate
    const totalPages = Math.max(1, Math.ceil(filtered.length / perPage));
    clampPage(totalPages);
    const start = (page-1) * perPage;
    const slice = filtered.slice(start, start + perPage);

    renderGrid(slice);
    renderPager(filtered.length);

    document.getElementById("loading").style.display = "none";
  }

  // =========================
  // LOAD DATA
  // =========================
  async function init(){
    loadHash();

    // UI initial
    document.getElementById("perPage").value = String(perPage);
    document.getElementById("search").value = searchTerm;

    const res = await fetch(PRODUCTS_JSON_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    const cats = Array.isArray(data.categories) ? data.categories : [];
    const items = Array.isArray(data.products) ? data.products : (Array.isArray(data) ? data : []);

    CATS = cats.map(normCat);
    ALL = items.map(r => ({
      id: r.id,
      code: safeStr(r.code),
      name: safeStr(r.name || r.DESIGNATION),
      category: normCat(r.category),
      price: Number(r.price || r.PRIX || r.PRX || 0),
      unit: safeStr(r.unit) || "pi√®ce",
      image: safeStr(r.image) || PLACEHOLDER
    })).filter(p => p.name);

    // if hash category not found -> reset
    if (activeCat !== "Tout" && !CATS.includes(activeCat)){
      activeCat = "Tout";
      page = 1;
    }

    renderCategories();
    updateCartMini();
    renderCartDrawer();
    render();
  }

  // =========================
  // EVENTS
  // =========================
  document.getElementById("search").addEventListener("input", (e)=>{
    searchTerm = e.target.value || "";
    page = 1;
    setHash();
    render();
  });

  document.getElementById("clearBtn").onclick = ()=>{
    document.getElementById("search").value = "";
    searchTerm = "";
    page = 1;
    setHash();
    render();
  };

  document.getElementById("perPage").addEventListener("change", (e)=>{
    perPage = Number(e.target.value || 24);
    page = 1;
    setHash();
    render();
  });

  document.getElementById("openCart").onclick = ()=>{
    renderCartDrawer();
    openDrawer();
  };
  document.getElementById("closeCart").onclick = closeDrawer;
  document.getElementById("overlay").onclick = closeDrawer;

  document.getElementById("clearCart").onclick = ()=>{
    if (confirm("Vider le panier ?")) clearCart();
  };
  document.getElementById("waOrder").onclick = openWhatsAppOrder;

  window.addEventListener("hashchange", ()=>{
    // si tu changes le lien/partage
    loadHash();
    document.getElementById("perPage").value = String(perPage);
    document.getElementById("search").value = searchTerm;
    render();
  });

  init().catch(err=>{
    console.error(err);
    document.getElementById("loading").textContent =
      "Erreur de chargement : v√©rifie products.json (nom, emplacement) et r√©essaie.";
  });
</script>
</body>
</html>
