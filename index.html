<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MAXI JDC MARKET â€” Commande</title>

  <style>
    :root{
      --bg0:#061116;
      --bg1:#071a22;
      --card:#0b1f27;
      --card2:#0f2630;
      --line:rgba(255,255,255,.10);
      --text:#e9f2f7;
      --muted:#a8c0cc;

      --accent:#26d6c8;       /* plus visible */
      --accent2:#28c07a;      /* boutons */
      --danger:#ff6b6b;
      --warn:#ffc857;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 20%, rgba(38,214,200,.16), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(40,192,122,.12), transparent 55%),
        radial-gradient(900px 600px at 70% 90%, rgba(38,214,200,.10), transparent 55%),
        linear-gradient(160deg, var(--bg0), var(--bg1));
      min-height:100vh;
      padding:24px 18px 44px;
    }

    .wrap{
      max-width: 1260px;
      margin: 0 auto;
    }

    .top{
      background: rgba(0,0,0,.18);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      border-radius: 24px;
      padding: 16px 16px 14px;
      backdrop-filter: blur(10px);
    }

    .topRow{
      display:flex;
      gap:14px;
      align-items:center;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 260px;
    }
    .logo{
      width:54px;
      height:54px;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:cover;display:block}
    .btxt .name{
      font-weight: 950;
      letter-spacing:.3px;
      font-size: 20px; /* plus grand */
      line-height: 1.1;
    }
    .btxt .sub{
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
    }

    .search{
      flex: 1 1 420px;
      display:flex;
      gap:10px;
      align-items:center;
      min-width: 300px;
    }
    .search input{
      width:100%;
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline: none;
    }
    .search input::placeholder{color: rgba(233,242,247,.55)}
    .btn{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-weight: 800;
      white-space:nowrap;
    }
    .btn:hover{background: rgba(255,255,255,.10)}
    .btn.green{
      background: rgba(40,192,122,.14);
      border-color: rgba(40,192,122,.35);
    }
    .btn.green:hover{background: rgba(40,192,122,.20)}

    .pills{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-left:auto;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 800;
      font-size: 12px;
    }
    .pill small{opacity:.8;font-weight:700}
    .pill .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(38,214,200,.12);
    }

    /* panier en haut Ã  droite */
    .cartPill{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      font-weight: 950;
    }
    .cartPill:hover{
      background: rgba(0,0,0,.32);
    }
    #cartTopCount{
      margin-left:10px;
      display:inline-block;
      min-width:28px;
      padding:3px 10px;
      border-radius:999px;
      background: rgba(38,214,200,.18);
      border:1px solid rgba(38,214,200,.35);
      font-weight: 950;
      text-align:center;
    }

    .noteBar{
      margin-top:12px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .noteBar .ok{color: var(--accent); font-weight: 950}
    .noteBar .sub{color: rgba(233,242,247,.70)}

    .grid{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
    }

    .panel{
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding: 14px 14px 10px;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .panelHeader h3{
      margin:0;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .panelHeader .sub{
      color: var(--muted);
      font-size: 12px;
    }

    .cats{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 70vh;
      overflow:auto;
    }
    .catBtn{
      text-align:left;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .catBtn:hover{background: rgba(255,255,255,.07)}
    .catBtn.active{
      border-color: rgba(38,214,200,.35);
      background: rgba(38,214,200,.10);
      box-shadow: 0 0 0 3px rgba(38,214,200,.08) inset;
    }
    .catMeta{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .catMeta .t{font-weight: 950; font-size: 13px}
    .catMeta .f{font-size: 11px; color: rgba(233,242,247,.60)}
    .count{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(233,242,247,.85);
      font-weight: 900;
      min-width: 66px;
      text-align:center;
    }

    .content{
      padding: 14px;
    }
    .contentHead{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom: 10px;
    }
    .contentHead .title{
      margin:0;
      font-weight: 950;
      font-size: 14px;
    }
    .contentHead .source{
      color: rgba(233,242,247,.62);
      font-size: 12px;
      margin-top: 2px;
    }

    .pager{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      margin-top: 4px;
    }
    .iconBtn{
      width:34px;height:34px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      display:grid;
      place-items:center;
      font-weight: 950;
    }
    .iconBtn:hover{background: rgba(255,255,255,.10)}
    .pageLabel{color: rgba(233,242,247,.75); font-size: 12px; font-weight: 900}

    .cards{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    @media(max-width: 1080px){
      .grid{grid-template-columns: 1fr}
      .cats{max-height: unset}
      .cards{grid-template-columns: repeat(2, minmax(0, 1fr))}
    }
    @media(max-width: 680px){
      .cards{grid-template-columns: 1fr}
      .brand{min-width:unset}
    }

    .card{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.12));
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      padding: 12px;
      position: relative;
      overflow:hidden;
    }
    /* Couleur plus visible sur les articles */
    .card::before{
      content:"";
      position:absolute;
      inset:-2px -2px auto -2px;
      height: 5px;
      background: linear-gradient(90deg, rgba(38,214,200,.85), rgba(40,192,122,.80), rgba(255,200,87,.70));
      opacity: .95;
    }

    .cTop{
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .cName{
      font-weight: 950;
      font-size: 12.5px;
      line-height: 1.25;
      letter-spacing:.2px;
      text-transform: uppercase;
      max-width: 70%;
    }
    .price{
      font-weight: 950;
      background: rgba(38,214,200,.16);
      border: 1px solid rgba(38,214,200,.35);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      white-space:nowrap;
      box-shadow: 0 0 0 3px rgba(38,214,200,.08) inset;
    }

    .cMeta{
      margin-top: 8px;
      font-size: 11px;
      color: rgba(233,242,247,.72);
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .tagLine{
      display:flex;gap:6px;flex-wrap:wrap;margin-top:6px
    }
    .tag{
      font-size: 10px;
      font-weight: 900;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(233,242,247,.85);
    }
    .tag.accent{
      border-color: rgba(255,200,87,.35);
      background: rgba(255,200,87,.10);
      color: rgba(255,231,190,.95);
    }

    .cBottom{
      margin-top: 10px;
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:10px;
    }

    .addBtn{
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 950;
      cursor:pointer;
      min-width: 110px;
    }
    .addBtn:hover{background: rgba(255,255,255,.10)}
    .addBtn:disabled{
      opacity:.5; cursor:not-allowed;
    }

    .qty{
      display:flex;
      align-items:center;
      border:1px solid rgba(38,214,200,.28);
      background: rgba(38,214,200,.08);
      border-radius: 999px;
      overflow:hidden;
      box-shadow: 0 0 0 3px rgba(38,214,200,.07) inset;
    }
    .qty button{
      border:0;
      background: transparent;
      color: var(--text);
      font-weight: 950;
      width: 40px;
      height: 36px;
      cursor:pointer;
    }
    .qty button:hover{background: rgba(255,255,255,.08)}
    .qty .n{
      min-width: 36px;
      text-align:center;
      font-weight: 950;
      color: rgba(233,242,247,.95);
    }

    /* MODAL PANIER */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modal{
      width: min(860px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.20));
      box-shadow: 0 30px 80px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modalHead .ttl{
      font-weight: 950;
      letter-spacing:.2px;
    }
    .close{
      width:36px;height:36px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-weight: 950;
    }
    .close:hover{background: rgba(255,255,255,.10)}
    .modalBody{
      padding: 14px 16px 18px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
    }
    @media(max-width: 860px){
      .modalBody{grid-template-columns: 1fr}
    }

    .cartList{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    .cartItem{
      padding: 10px 12px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .cartItem:last-child{border-bottom:0}
    .cartItem .l{
      display:flex;flex-direction:column;gap:2px;
      max-width: 70%;
    }
    .cartItem .l .nm{font-weight: 950; font-size: 12px}
    .cartItem .l .sm{color: rgba(233,242,247,.70); font-size: 11px}
    .cartItem .r{
      display:flex; align-items:center; gap:10px;
    }
    .lineTotal{
      font-weight: 950;
      color: rgba(233,242,247,.92);
      font-size: 12px;
      min-width: 84px;
      text-align:right;
    }

    .box{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom: 10px;
    }
    .field label{
      font-size: 11px;
      color: rgba(233,242,247,.70);
      font-weight: 900;
    }
    .field input, .field textarea{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
    }
    textarea{min-height: 80px; resize: vertical;}

    .totals{
      margin-top: 8px;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size: 12px;
      color: rgba(233,242,247,.86);
      font-weight: 900;
    }
    .totRow{display:flex;justify-content:space-between;gap:10px}
    .totRow strong{color: var(--text)}
    .mini{
      font-size: 11px;
      color: rgba(233,242,247,.70);
      font-weight: 800;
    }

    .actions{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .actions .btn{
      flex: 1 1 150px;
      justify-content:center;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight: 950;
    }
    .btn.primary{
      background: rgba(38,214,200,.18);
      border-color: rgba(38,214,200,.35);
    }
    .btn.primary:hover{background: rgba(38,214,200,.24)}

    .empty{
      padding: 16px;
      color: rgba(233,242,247,.70);
      font-weight: 900;
      font-size: 12px;
    }

    /* ADMIN */
    .adminWrap{
      display:none;
      margin-top: 16px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .adminHead{
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
      gap:10px;
      flex-wrap:wrap;
    }
    .adminHead .ttl{font-weight: 950}
    .adminBody{
      padding: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media(max-width: 980px){ .adminBody{grid-template-columns:1fr} }

    .table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .table th, .table td{
      padding: 8px 8px;
      border-bottom:1px solid rgba(255,255,255,.08);
      text-align:left;
      vertical-align:top;
    }
    .table th{
      color: rgba(233,242,247,.78);
      font-weight: 950;
      font-size: 11px;
      letter-spacing:.2px;
      text-transform: uppercase;
    }

    .adminBox{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 12px;
      overflow:auto;
    }

    .hint{
      margin-top: 10px;
      color: rgba(233,242,247,.55);
      font-size: 11px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- TOP -->
    <div class="top">
      <div class="topRow">
        <div class="brand">
          <div class="logo" title="MAXI JDC MARKET">
            <img src="logo-maxi-jdc-market.jpg" alt="Logo MAXI JDC MARKET" onerror="this.style.display='none'">
          </div>
          <div class="btxt">
            <div class="name">MAXI JDC MARKET</div>
            <div class="sub">Des prix mini â€” Un MAXI choix</div>
          </div>
        </div>

        <div class="search">
          <input id="q" type="text" placeholder="Rechercher un produit (nom, catÃ©gorie, code)..." />
          <button class="btn" id="clearBtn">Effacer</button>
          <button class="btn green" id="globalBtn">Recherche globale</button>
        </div>

        <div class="pills">
          <div class="pill"><span class="dot"></span><small>Jardins de Carthage</small>, derriÃ¨re mosquÃ©e Essalem</div>
          <div class="pill"><small>ðŸ•’</small> 7h â€“ 1h</div>
          <div class="pill"><small>ðŸ’¬</small> WhatsApp: <span id="waLabel">00216 25 600 978</span></div>

          <div class="pill cartPill" id="cartTopBtn" title="Ouvrir le panier">
            ðŸ›’ Panier <span id="cartTopCount">0</span>
          </div>
        </div>
      </div>

      <div class="noteBar">
        <span class="ok">âœ…</span>
        <span id="status">Chargementâ€¦</span>
        <span class="sub" style="margin-left:auto">
          Conditions : minimum livraison <b>15 dt</b> Â· Livraison gratuite si total â‰¥ <b>30 dt</b> Â· Sinon frais <b>5 dt</b> Â· Retrait magasin possible
        </span>
      </div>
    </div>

    <!-- ADMIN (affichÃ© si #admin ou Ctrl+Shift+A) -->
    <div class="adminWrap" id="adminWrap">
      <div class="adminHead">
        <div class="ttl">Admin â€” Clients & Historique</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" id="exportBtn">â¬‡ Export JSON</button>
          <button class="btn" id="clearHistoryBtn" style="border-color: rgba(255,107,107,.35);background: rgba(255,107,107,.10);">ðŸ—‘ Effacer historique</button>
          <button class="btn" id="closeAdminBtn">Fermer Admin</button>
        </div>
      </div>
      <div class="adminBody">
        <div class="adminBox">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div style="font-weight:950">Suivi clients</div>
            <input id="clientSearch" placeholder="Rechercher client (nom / tel)..." style="max-width:280px">
          </div>
          <div style="height:10px"></div>
          <table class="table" id="clientsTable"></table>
        </div>

        <div class="adminBox">
          <div style="font-weight:950">Historique des commandes</div>
          <div style="height:10px"></div>
          <table class="table" id="ordersTable"></table>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <div class="panelHeader">
          <h3>CatÃ©gories</h3>
          <div class="sub" id="catsInfo">â€”</div>
        </div>
        <div class="cats" id="cats"></div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="content">
          <div class="contentHead">
            <div>
              <div class="title" id="activeLabel">Produits</div>
              <div class="source" id="activeSource">SÃ©lectionne une catÃ©gorie.</div>
            </div>
            <div>
              <div class="pager">
                <button class="iconBtn" id="prevPage">â€¹</button>
                <div class="pageLabel" id="pageLabel">Page 1/1</div>
                <button class="iconBtn" id="nextPage">â€º</button>
              </div>
              <div class="mini" style="text-align:right;margin-top:6px" id="countLabel">0 article(s)</div>
            </div>
          </div>

          <div class="cards" id="cards"></div>
        </div>
      </div>
    </div>

    <div class="hint" id="hintLine">Admin : Ctrl + Shift + A (ou ajoute #admin Ã  lâ€™URL)</div>
  </div>

  <!-- PANIER MODAL -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modalHead">
        <div class="ttl">ðŸ›’ Panier</div>
        <button class="close" id="closeCart">âœ•</button>
      </div>

      <div class="modalBody">
        <div class="cartList" id="cartList"></div>

        <div class="box">
          <div class="field">
            <label>Nom</label>
            <input id="cName" placeholder="Ex: Lotfi" />
          </div>
          <div class="field">
            <label>TÃ©lÃ©phone</label>
            <input id="cTel" placeholder="Ex: 25 600 978" />
          </div>
          <div class="field">
            <label>Adresse</label>
            <input id="cAddr" placeholder="Jardins de Carthage..." />
          </div>
          <div class="field">
            <label>Note (optionnel)</label>
            <textarea id="cNote" placeholder="Ex: sonnette, Ã©tage, heure..."></textarea>
          </div>

          <div class="totals">
            <div class="totRow"><span>Sous-total</span><strong id="subTotal">0,00 dt</strong></div>
            <div class="totRow"><span>Frais livraison</span><strong id="shipFee">â€”</strong></div>
            <div class="totRow"><span>Total</span><strong id="cartTotal">0,00 dt</strong></div>
            <div class="mini" id="ruleMsg">Minimum commande: 15 dt</div>
          </div>

          <div class="actions">
            <button class="btn" id="clearCartBtn">ðŸ§¹ Vider</button>
            <button class="btn primary" id="sendBtn">ðŸ“² Envoyer WhatsApp</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const WHATSAPP_NUMBER = "0021625600978"; // sans espaces (ton numÃ©ro)
    document.getElementById("waLabel").textContent = "00216 25 600 978";

    const MIN_ORDER = 15;
    const FREE_SHIPPING = 30;
    const SHIPPING_FEE = 5;

    // DÃ©clare ici tes catÃ©gories (comme avant)
    const CATEGORIES = [
      { key:"fruits_legumes", label:"Fruits & LÃ©gumes", file:"/data/fruits_legumes.csv" },
      { key:"lait_oeufs_produits_frais", label:"Lait, Å’ufs & Produits frais", file:"/data/lait_oeufs_produits_frais.csv" },
      { key:"fromage_charcuterie", label:"Fromage & Charcuterie", file:"/data/fromage_charcuterie.csv" },
      { key:"boulangerie_patisserie", label:"Boulangerie & PÃ¢tisserie", file:"/data/boulangerie_patisserie.csv" },
      { key:"epicerie_salee", label:"Ã‰picerie SalÃ©e", file:"/data/epicerie_salee.csv" },
      { key:"epicerie_sucree", label:"Ã‰picerie SucrÃ©e", file:"/data/epicerie_sucree.csv" },
      { key:"pates", label:"PÃ¢tes", file:"/data/pates.csv" },
      { key:"conserves", label:"Conserves", file:"/data/conserves.csv" },
    ];

    const PAGE_SIZE = 9;

    /***********************
     * STATE
     ***********************/
    const state = {
      activeCat: CATEGORIES[0]?.key || null,
      global: false,
      page: 1,
      dataByCat: new Map(),    // key -> items[]
      cart: loadCart(),
      orders: loadOrders(),    // historique commandes
      clients: loadClients(),  // suivi clients
    };

    /***********************
     * HELPERS
     ***********************/
    const $ = (id)=>document.getElementById(id);

    function fmtDT(n){
      const x = Number(n || 0);
      return x.toFixed(2).replace('.', ',') + " dt";
    }

    function normalizeTel(t){
      return String(t||"").replace(/[^\d+]/g,'').replace(/^00/,'+');
    }

    function safeLower(s){ return String(s||"").toLowerCase(); }

    function detectSep(text){
      // dÃ©tecte sÃ©parateur (tab, ;, ,)
      const sample = text.split(/\r?\n/).slice(0,5).join("\n");
      const tab = (sample.match(/\t/g)||[]).length;
      const semi = (sample.match(/;/g)||[]).length;
      const comma = (sample.match(/,/g)||[]).length;
      if(tab >= semi && tab >= comma) return "\t";
      if(semi >= comma) return ";";
      return ",";
    }

    function parseCSV(text){
      const sep = detectSep(text);
      const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length);
      if(!lines.length) return [];

      // essaye de dÃ©tecter header
      const head = lines[0].split(sep).map(s=>s.trim());
      const hasHeader = head.some(h => /code|id|prix|price|nom|name|image|photo/i.test(h));

      let start = 0;
      let cols = {code:0, name:1, price:2, image:3};

      if(hasHeader){
        start = 1;
        const idx = (re)=> head.findIndex(h => re.test(h));
        cols.code  = Math.max(0, idx(/code|id/i));
        cols.name  = Math.max(0, idx(/nom|name|designation|libelle/i));
        cols.price = Math.max(0, idx(/prix|price/i));
        cols.image = idx(/image|photo|img/i);
      }

      const items = [];
      for(let i=start;i<lines.length;i++){
        const parts = lines[i].split(sep).map(s=>s.trim());
        if(parts.length < 2) continue;

        const code = parts[cols.code] ?? parts[0] ?? "";
        const name = parts[cols.name] ?? parts[1] ?? "";
        let priceRaw = parts[cols.price] ?? parts[2] ?? "";
        priceRaw = String(priceRaw).replace(',', '.').replace(/[^\d.]/g,'');
        const price = priceRaw ? Number(priceRaw) : null;

        const image = (cols.image>=0 ? parts[cols.image] : "") || "";

        if(!String(name).trim()) continue;

        items.push({
          code: String(code).trim(),
          name: String(name).trim(),
          price: (Number.isFinite(price) ? price : null),
          image: String(image).trim(),
        });
      }
      return items;
    }

    /***********************
     * CART LOGIC
     ***********************/
    function cartCount(){
      return Object.values(state.cart).reduce((a,b)=>a + (b.qty|0), 0);
    }
    function cartSubTotal(){
      return Object.values(state.cart).reduce((a,it)=> a + (Number(it.price)||0) * (it.qty|0), 0);
    }

    // Frais livraison selon exigence
    function shippingFee(){
      const total = cartSubTotal();
      if(total < MIN_ORDER) return null;              // commande non valide
      if(total >= FREE_SHIPPING) return 0;            // gratuit
      return SHIPPING_FEE;                            // 5 dt
    }

    function grandTotal(){
      const fee = shippingFee();
      if(fee === null) return null;
      return cartSubTotal() + fee;
    }

    function saveCart(){
      localStorage.setItem("maxi_cart_v2", JSON.stringify(state.cart));
    }
    function loadCart(){
      try{
        return JSON.parse(localStorage.getItem("maxi_cart_v2")||"{}") || {};
      }catch(e){ return {}; }
    }

    function addToCart(p){
      const key = String(p.code || p.name);
      if(!state.cart[key]){
        state.cart[key] = { code:p.code, name:p.name, price:p.price, qty:0 };
      }
      state.cart[key].qty = (state.cart[key].qty|0) + 1;
      saveCart();
      refreshCartUI();
      render();
    }

    function decItem(key){
      if(!state.cart[key]) return;
      state.cart[key].qty = (state.cart[key].qty|0) - 1;
      if(state.cart[key].qty <= 0) delete state.cart[key];
      saveCart();
      refreshCartUI();
      render();
    }

    function removeItem(key){
      if(!state.cart[key]) return;
      delete state.cart[key];
      saveCart();
      refreshCartUI();
      render();
    }

    function clearCart(){
      state.cart = {};
      saveCart();
      refreshCartUI();
      render();
    }

    /***********************
     * ADMIN STORAGE
     ***********************/
    function loadOrders(){
      try{ return JSON.parse(localStorage.getItem("maxi_orders_v2")||"[]") || []; }
      catch(e){ return []; }
    }
    function saveOrders(){
      localStorage.setItem("maxi_orders_v2", JSON.stringify(state.orders));
    }
    function loadClients(){
      try{ return JSON.parse(localStorage.getItem("maxi_clients_v2")||"{}") || {}; }
      catch(e){ return {}; }
    }
    function saveClients(){
      localStorage.setItem("maxi_clients_v2", JSON.stringify(state.clients));
    }

    function upsertClient({name,tel}){
      const t = normalizeTel(tel);
      const key = t || safeLower(name) || ("client_"+Date.now());
      if(!state.clients[key]){
        state.clients[key] = { name:name||"", tel:tel||"", orders:0, spent:0, last:"" };
      }else{
        if(name) state.clients[key].name = name;
        if(tel) state.clients[key].tel = tel;
      }
      return key;
    }

    function recordOrder(payload){
      const now = new Date();
      const stamp = now.toISOString();
      state.orders.unshift({ ...payload, stamp });
      if(state.orders.length > 500) state.orders.length = 500;
      saveOrders();

      const ck = upsertClient({name:payload.name, tel:payload.tel});
      state.clients[ck].orders += 1;
      state.clients[ck].spent += Number(payload.total||0);
      state.clients[ck].last = stamp;
      saveClients();
    }

    /***********************
     * UI BUILD
     ***********************/
    function buildCats(){
      const box = $("cats");
      box.innerHTML = "";
      for(const c of CATEGORIES){
        const btn = document.createElement("button");
        btn.className = "catBtn" + (state.activeCat===c.key && !state.global ? " active" : "");
        btn.onclick = ()=>{
          state.activeCat = c.key;
          state.global = false;
          state.page = 1;
          render();
        };

        const meta = document.createElement("div");
        meta.className = "catMeta";
        const t = document.createElement("div");
        t.className = "t";
        t.textContent = c.label;
        const f = document.createElement("div");
        f.className = "f";
        f.textContent = "CSV: " + c.file.split('/').pop();
        meta.appendChild(t);
        meta.appendChild(f);

        const count = document.createElement("div");
        count.className = "count";
        const items = state.dataByCat.get(c.key) || [];
        count.textContent = items.length + " article(s)";

        btn.appendChild(meta);
        btn.appendChild(count);
        box.appendChild(btn);
      }
      $("catsInfo").textContent = state.global ? "GLOBAL" : "OK";
    }

    function getActiveItems(){
      if(state.global){
        const all = [];
        for(const c of CATEGORIES){
          const arr = state.dataByCat.get(c.key) || [];
          for(const it of arr) all.push({...it, catKey:c.key, catLabel:c.label, catFile:c.file});
        }
        return all;
      }
      const c = CATEGORIES.find(x=>x.key===state.activeCat) || CATEGORIES[0];
      const arr = state.dataByCat.get(c.key) || [];
      return arr.map(it=>({...it, catKey:c.key, catLabel:c.label, catFile:c.file}));
    }

    function applySearch(items){
      const q = $("q").value.trim().toLowerCase();
      if(!q) return items;
      return items.filter(it=>{
        return (
          safeLower(it.name).includes(q) ||
          safeLower(it.code).includes(q) ||
          safeLower(it.catLabel).includes(q)
        );
      });
    }

    function render(){
      buildCats();

      const items0 = getActiveItems();
      const items = applySearch(items0);

      // header labels
      const active = state.global
        ? { label:"Recherche globale", file:"/data/*.csv" }
        : (CATEGORIES.find(x=>x.key===state.activeCat) || CATEGORIES[0]);

      $("activeLabel").textContent = active.label || "Produits";
      $("activeSource").textContent = state.global
        ? "Source: /data/*.csv Â· Mise Ã  jour rapide (prix + nouveaux articles)"
        : `Source: ${active.file} Â· Mise Ã  jour rapide (prix + nouveaux articles)`;

      $("countLabel").textContent = items.length + " article(s)";

      // pagination
      const totalPages = Math.max(1, Math.ceil(items.length / PAGE_SIZE));
      state.page = Math.min(state.page, totalPages);
      const start = (state.page-1)*PAGE_SIZE;
      const pageItems = items.slice(start, start+PAGE_SIZE);
      $("pageLabel").textContent = `Page ${state.page}/${totalPages}`;

      $("prevPage").disabled = state.page<=1;
      $("nextPage").disabled = state.page>=totalPages;

      // cards
      const box = $("cards");
      box.innerHTML = "";
      for(const p of pageItems){
        const card = document.createElement("div");
        card.className = "card";

        const top = document.createElement("div");
        top.className = "cTop";

        const nm = document.createElement("div");
        nm.className = "cName";
        nm.textContent = p.name;

        const pr = document.createElement("div");
        pr.className = "price";
        pr.textContent = (p.price==null ? "â€”" : String(p.price).replace('.', ',') + " dt");

        top.appendChild(nm);
        top.appendChild(pr);

        const meta = document.createElement("div");
        meta.className = "cMeta";
        const code = document.createElement("div");
        code.textContent = `Code: ${p.code || "â€”"} Â· ${p.catLabel}`;
        meta.appendChild(code);

        const tags = document.createElement("div");
        tags.className = "tagLine";
        const t1 = document.createElement("span");
        t1.className = "tag accent";
        t1.textContent = p.catLabel;
        tags.appendChild(t1);

        // si image existe (optionnel)
        if(p.image){
          const t2 = document.createElement("span");
          t2.className = "tag";
          t2.textContent = "ðŸ“· image";
          tags.appendChild(t2);
        }

        meta.appendChild(tags);

        const bottom = document.createElement("div");
        bottom.className = "cBottom";

        // + / - dynamique
        const key = String(p.code || p.name);
        if(state.cart[key]){
          const wrap = document.createElement("div");
          wrap.className = "qty";

          const minus = document.createElement("button");
          minus.textContent = "âˆ’";
          minus.onclick = ()=> decItem(key);

          const q = document.createElement("div");
          q.className = "n";
          q.textContent = state.cart[key].qty;

          const plus = document.createElement("button");
          plus.textContent = "+";
          plus.onclick = ()=> addToCart(p);

          wrap.appendChild(minus);
          wrap.appendChild(q);
          wrap.appendChild(plus);
          bottom.appendChild(wrap);
        } else {
          const add = document.createElement("button");
          add.className = "addBtn";
          add.textContent = "+ Ajouter";
          add.disabled = (p.price == null);
          add.onclick = ()=> addToCart(p);
          bottom.appendChild(add);
        }

        card.appendChild(top);
        card.appendChild(meta);
        card.appendChild(bottom);
        box.appendChild(card);
      }

      refreshCartUI();
      refreshAdminUI();
    }

    /***********************
     * PANIER UI
     ***********************/
    function refreshCartUI(){
      $("cartTopCount").textContent = cartCount();

      // list
      const list = $("cartList");
      list.innerHTML = "";
      const keys = Object.keys(state.cart);

      if(!keys.length){
        const e = document.createElement("div");
        e.className = "empty";
        e.textContent = "Panier vide. Ajoute des articles ðŸ™‚";
        list.appendChild(e);
      }else{
        for(const k of keys){
          const it = state.cart[k];

          const row = document.createElement("div");
          row.className = "cartItem";

          const l = document.createElement("div");
          l.className = "l";
          const nm = document.createElement("div");
          nm.className = "nm";
          nm.textContent = `${it.qty} Ã— ${it.name}`;
          const sm = document.createElement("div");
          sm.className = "sm";
          sm.textContent = `Code: ${it.code || "â€”"} Â· Prix: ${String(it.price).replace('.', ',')} dt`;
          l.appendChild(nm);
          l.appendChild(sm);

          const r = document.createElement("div");
          r.className = "r";

          const qWrap = document.createElement("div");
          qWrap.className = "qty";
          const minus = document.createElement("button");
          minus.textContent = "âˆ’";
          minus.onclick = ()=> decItem(k);
          const q = document.createElement("div");
          q.className = "n";
          q.textContent = it.qty;
          const plus = document.createElement("button");
          plus.textContent = "+";
          plus.onclick = ()=> addToCart({code:it.code, name:it.name, price:it.price});
          qWrap.appendChild(minus);
          qWrap.appendChild(q);
          qWrap.appendChild(plus);

          const lt = document.createElement("div");
          lt.className = "lineTotal";
          lt.textContent = fmtDT((Number(it.price)||0) * (it.qty|0));

          const del = document.createElement("button");
          del.className = "iconBtn";
          del.style.width="34px"; del.style.height="34px";
          del.textContent = "âœ•";
          del.onclick = ()=> removeItem(k);

          r.appendChild(qWrap);
          r.appendChild(lt);
          r.appendChild(del);

          row.appendChild(l);
          row.appendChild(r);
          list.appendChild(row);
        }
      }

      // totals
      const sub = cartSubTotal();
      $("subTotal").textContent = fmtDT(sub);

      const fee = shippingFee();
      if(fee === null){
        $("shipFee").textContent = "â€”";
        $("cartTotal").textContent = "Minimum commande 15 dt";
        $("cartTotal").style.color = "var(--danger)";
        $("ruleMsg").textContent = `Minimum commande: ${MIN_ORDER} dt`;
      }else{
        $("shipFee").textContent = (fee===0 ? "Gratuit" : fmtDT(fee));
        $("cartTotal").textContent = fmtDT(grandTotal());
        $("cartTotal").style.color = "";
        $("ruleMsg").textContent = (fee===0 ? `Livraison gratuite (â‰¥ ${FREE_SHIPPING} dt)` : `Frais livraison: ${SHIPPING_FEE} dt`);
      }
    }

    /***********************
     * ADMIN UI
     ***********************/
    function refreshAdminUI(){
      if($("adminWrap").style.display !== "block") return;

      // Clients table
      const q = $("clientSearch") ? $("clientSearch").value.trim().toLowerCase() : "";
      const rows = Object.entries(state.clients)
        .map(([k,v])=>({key:k, ...v}))
        .filter(c=>{
          if(!q) return true;
          return safeLower(c.name).includes(q) || safeLower(c.tel).includes(q) || safeLower(c.key).includes(q);
        })
        .sort((a,b)=> (b.spent||0)-(a.spent||0));

      let html = "<tr><th>Client</th><th>TÃ©lÃ©phone</th><th>Cmd</th><th>Total</th><th>DerniÃ¨re</th></tr>";
      for(const c of rows){
        const last = c.last ? new Date(c.last).toLocaleString() : "â€”";
        html += `<tr>
          <td><b>${escapeHtml(c.name||"â€”")}</b></td>
          <td>${escapeHtml(c.tel||"â€”")}</td>
          <td>${Number(c.orders||0)}</td>
          <td><b>${fmtDT(c.spent||0)}</b></td>
          <td>${escapeHtml(last)}</td>
        </tr>`;
      }
      $("clientsTable").innerHTML = html;

      // Orders table
      let ohtml = "<tr><th>Date</th><th>Client</th><th>Total</th><th>DÃ©tails</th></tr>";
      for(const o of state.orders.slice(0,80)){
        const dt = o.stamp ? new Date(o.stamp).toLocaleString() : "â€”";
        const det = (o.items||[]).map(x=>`${x.qty}Ã—${x.name}`).join(" Â· ");
        ohtml += `<tr>
          <td>${escapeHtml(dt)}</td>
          <td><b>${escapeHtml(o.name||"â€”")}</b><div style="color:rgba(233,242,247,.7);font-size:11px">${escapeHtml(o.tel||"")}</div></td>
          <td><b>${fmtDT(o.total||0)}</b></td>
          <td style="color:rgba(233,242,247,.8)">${escapeHtml(det)}</td>
        </tr>`;
      }
      $("ordersTable").innerHTML = ohtml;
    }

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    /***********************
     * EVENTS
     ***********************/
    $("prevPage").onclick = ()=>{ state.page = Math.max(1, state.page-1); render(); };
    $("nextPage").onclick = ()=>{ state.page += 1; render(); };

    $("globalBtn").onclick = ()=>{
      state.global = true;
      state.page = 1;
      render();
    };

    $("clearBtn").onclick = ()=>{
      $("q").value = "";
      state.page = 1;
      render();
    };

    $("q").addEventListener("input", ()=>{
      state.page = 1;
      render();
    });

    // ouvrir panier
    $("cartTopBtn").onclick = ()=> openCart();
    $("closeCart").onclick = ()=> closeCart();
    $("overlay").addEventListener("click", (e)=>{
      if(e.target.id === "overlay") closeCart();
    });

    $("clearCartBtn").onclick = ()=> clearCart();

    $("sendBtn").onclick = ()=>{
      const fee = shippingFee();
      if(fee === null){
        alert("âš ï¸ Minimum commande 15 dt");
        return;
      }
      const name = $("cName").value.trim();
      const tel  = $("cTel").value.trim();
      const addr = $("cAddr").value.trim();
      const note = $("cNote").value.trim();

      const keys = Object.keys(state.cart);
      if(!keys.length){
        alert("Panier vide.");
        return;
      }

      const items = keys.map(k=>{
        const it = state.cart[k];
        return { code: it.code, name: it.name, price: it.price, qty: it.qty };
      });

      const msgLines = [];
      msgLines.push("ðŸ›’ *Commande MAXI JDC MARKET*");
      msgLines.push("");
      msgLines.push("ðŸ‘¤ Nom: " + (name||"â€”"));
      msgLines.push("ðŸ“ž Tel: " + (tel||"â€”"));
      msgLines.push("ðŸ“ Adresse: " + (addr||"â€”"));
      if(note) msgLines.push("ðŸ“ Note: " + note);
      msgLines.push("");
      msgLines.push("*Articles:*");
      for(const it of items){
        const lt = (Number(it.price)||0) * (it.qty|0);
        msgLines.push(`â€¢ ${it.qty} Ã— ${it.name} (Code: ${it.code||"â€”"}) â€” ${fmtDT(lt)}`);
      }
      msgLines.push("");
      msgLines.push(`Sous-total: *${fmtDT(cartSubTotal())}*`);
      msgLines.push(`Frais: *${fee===0 ? "Gratuit" : fmtDT(fee)}*`);
      msgLines.push(`âœ… Total: *${fmtDT(grandTotal())}*`);

      // ENREGISTREMENT HISTORIQUE
      recordOrder({
        name, tel, addr, note,
        items,
        subtotal: cartSubTotal(),
        fee,
        total: grandTotal()
      });

      // OUVERTURE WHATSAPP
      const text = encodeURIComponent(msgLines.join("\n"));
      const url = `https://wa.me/${WHATSAPP_NUMBER.replace(/[^\d]/g,'')}?text=${text}`;
      window.open(url, "_blank");
    };

    function openCart(){
      $("overlay").style.display = "flex";
      refreshCartUI();
    }
    function closeCart(){
      $("overlay").style.display = "none";
    }

    // ADMIN ouvrir/fermer (Ctrl+Shift+A) ou #admin
    function showAdmin(){
      $("adminWrap").style.display = "block";
      $("hintLine").textContent = "Admin ouvert âœ”";
      refreshAdminUI();
      window.location.hash = "admin";
      window.scrollTo({top:0, behavior:"smooth"});
    }
    function hideAdmin(){
      $("adminWrap").style.display = "none";
      $("hintLine").textContent = "Admin : Ctrl + Shift + A (ou ajoute #admin Ã  lâ€™URL)";
      if(window.location.hash === "#admin") history.replaceState(null,"", window.location.pathname);
    }

    document.addEventListener("keydown", (e)=>{
      if(e.ctrlKey && e.shiftKey && (e.key==="A" || e.key==="a")){
        e.preventDefault();
        const isOpen = $("adminWrap").style.display === "block";
        if(isOpen) hideAdmin(); else showAdmin();
      }
      if(e.key === "Escape"){
        closeCart();
      }
    });

    $("closeAdminBtn").onclick = ()=> hideAdmin();

    $("exportBtn").onclick = ()=>{
      const data = {
        clients: state.clients,
        orders: state.orders,
        exportedAt: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "maxi-admin-export.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    };

    $("clearHistoryBtn").onclick = ()=>{
      if(!confirm("Effacer historique + clients ?")) return;
      state.orders = [];
      state.clients = {};
      saveOrders();
      saveClients();
      refreshAdminUI();
      alert("Historique effacÃ©.");
    };

    if($("clientSearch")){
      $("clientSearch").addEventListener("input", ()=> refreshAdminUI());
    }

    // Hash admin
    window.addEventListener("hashchange", ()=>{
      if(window.location.hash === "#admin") showAdmin();
      else hideAdmin();
    });

    /***********************
     * LOAD DATA
     ***********************/
    async function loadAll(){
      $("status").textContent = "Chargement des catÃ©goriesâ€¦";
      for(const c of CATEGORIES){
        try{
          const r = await fetch(c.file, {cache:"no-store"});
          if(!r.ok) throw new Error("HTTP "+r.status);
          const text = await r.text();
          const items = parseCSV(text).map(it=>({
            ...it,
            catKey: c.key,
            catLabel: c.label,
            catFile: c.file
          }));
          state.dataByCat.set(c.key, items);
        }catch(e){
          console.warn("Erreur CSV", c.file, e);
          state.dataByCat.set(c.key, []);
        }
      }
      $("status").innerHTML = `âœ… DonnÃ©es chargÃ©es depuis <b>/data/*.csv</b> â€” une catÃ©gorie = un fichier CSV.`;
      render();
    }

    // INIT
    if(window.location.hash === "#admin") showAdmin();
    loadAll();
    refreshCartUI();
  </script>
</body>
</html>
