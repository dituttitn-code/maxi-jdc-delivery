<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAXI JDC MARKET ‚Äì Livraison</title>

  <style>
    :root{
      --bg:#0b0b0c;
      --card:#121214;
      --soft:#1b1b1e;
      --text:#f3f3f5;
      --muted:#a8a8b3;
      --accent:#00c853;
      --accent-soft:rgba(0,200,83,.25);
      --border:#2a2a2f;
      --radius:18px;
      --radius-sm:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 800px at 10% -10%, #1a1a1f 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px 12px 60px}
    header{
      position:sticky;top:0;z-index:20;
      background:linear-gradient(180deg, rgba(11,11,12,.95) 0%, rgba(11,11,12,.78) 75%, rgba(11,11,12,.0) 100%);
      backdrop-filter: blur(8px);
      padding:10px 0 14px;
    }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(18,18,20,.72);
      border-radius:22px;
      padding:10px 12px;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:42px;height:42px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:#111;overflow:hidden;display:grid;place-items:center;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{margin:0;font-size:15px;letter-spacing:.6px}
    .slogan{margin:2px 0 0;color:var(--muted);font-size:12px}

    .header-actions{display:flex;align-items:center;gap:10px}
    .header-info{display:flex;flex-direction:column;gap:3px;font-size:12px;color:var(--muted)}
    .header-info strong{color:var(--text)}
    .qr-mini{
      width:44px;height:44px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;background:#fff;
    }
    .qr-mini img{width:100%;height:100%;object-fit:cover}

    .section-title{margin:18px 0 10px;font-size:16px;color:var(--text)}

    .categories-list{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .category-pill{
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(16,16,18,.7);
      color:var(--text);font-size:12px;cursor:pointer;white-space:nowrap;
    }
    .category-pill.active{
      background:var(--accent-soft);
      border-color:rgba(0,200,83,.45);
      color:#eafff2;font-weight:800;
    }

    .row-tools{
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;
      margin:10px 0 10px;
    }
    .search{
      flex:1;min-width:220px;
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(18,18,20,.8);
      color:var(--text);outline:none;
    }
    .btn{
      border:none;background:rgba(255,255,255,.10);
      color:var(--text);padding:10px 12px;border-radius:999px;
      cursor:pointer;font-weight:700;
    }
    .btn-accent{background:var(--accent);color:#021a0c;font-weight:900}
    .select{
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(18,18,20,.8);
      color:var(--text);
      outline:none;
    }
    .info-line{color:var(--muted);font-size:12px;margin:6px 0 0}

    .products-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(190px, 1fr));
      gap:10px;
    }
    .product-card{
      border-radius:var(--radius-sm);
      border:1px solid rgba(255,255,255,.08);
      background:rgba(18,18,20,.92);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:330px;
    }

    /* ‚úÖ Image: m√™me zone, jamais coup√©e */
    .media{
      width:100%;
      height:150px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:#0b0b0c;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px;
      overflow:hidden;
    }
    .media img{
      width:100%;
      height:100%;
      object-fit:contain;
      object-position:center;
      display:block;
    }

    .product-header{display:flex;justify-content:space-between;gap:8px;align-items:flex-start}
    .product-name{font-weight:900;font-size:13px;line-height:1.15}
    .product-meta{font-size:12px;color:var(--muted);margin-top:2px}
    .product-price{font-weight:900;font-size:14px;text-align:right;white-space:nowrap}
    .small-text{font-size:12px;color:var(--muted)}

    .product-actions{margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .qty-control{
      display:inline-flex;align-items:center;
      border-radius:999px;border:1px solid rgba(255,255,255,.10);
      overflow:hidden;background:rgba(16,16,18,.75);
    }
    .qty-control button{
      border:none;background:transparent;color:var(--text);
      padding:6px 10px;font-size:16px;cursor:pointer;
    }
    .qty-control span{padding:0 10px;color:var(--text);min-width:22px;text-align:center}

    .btn-add{
      flex:1;border:none;background:var(--accent);color:#021a0c;
      font-weight:900;padding:10px 10px;border-radius:999px;cursor:pointer;line-height:1.1;
    }

    /* ‚úÖ Pagination */
    .pager{
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;
      margin:16px 0 0;
    }
    .page-btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(18,18,20,.8);
      color:var(--text);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      min-width:44px;
      text-align:center;
    }
    .page-btn.active{
      background:var(--accent-soft);
      border-color:rgba(0,200,83,.45);
      color:#eafff2;
    }
    .page-btn:disabled{
      opacity:.45;cursor:not-allowed;
    }

    #loading{padding:12px;color:var(--muted)}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo"><img src="logo-maxi-jdc-market.jpg" alt="MAXI JDC MARKET"></div>
          <div>
            <h1>MAXI JDC MARKET</h1>
            <div class="slogan">Des prix mini ‚Äì Un MAXI choix</div>
          </div>
        </div>

        <div class="header-actions">
          <div class="header-info">
            <div>üìç Jardins de Carthage, derri√®re mosqu√©e Esselem</div>
            <div>‚è∞ 7h ‚Äì 1h du matin</div>
            <div>üì± WhatsApp : <strong>00216 25 600 978</strong></div>
          </div>

          <div class="qr-mini" title="QR site">
            <img src="qr-maxi-jdc-site.jpg" alt="QR MAXI JDC MARKET">
          </div>
        </div>
      </div>

      <h3 class="section-title">Cat√©gories</h3>
      <div class="categories-list" id="categories-container"></div>

      <div class="row-tools">
        <input id="search" class="search" placeholder="Rechercher un produit‚Ä¶" />
        <button id="clear-search" class="btn" type="button">Effacer</button>

        <select id="per-page" class="select" title="Articles par page">
          <option value="24">24 / page</option>
          <option value="48">48 / page</option>
          <option value="72" selected>72 / page</option>
          <option value="120">120 / page</option>
        </select>
      </div>

      <div class="info-line" id="info-line"></div>

      <h3 class="section-title">Produits</h3>
      <div id="loading">Chargement des produits‚Ä¶</div>
      <div class="products-grid" id="products-container"></div>

      <div class="pager" id="pager"></div>
    </div>
  </header>

  <script>
    const PRODUCTS_JSON_URL = "products.json";
    const PLACEHOLDER_FILE = "placeholder.jpg"; // mets bien ce fichier dans images/products/

    // ‚úÖ Corrections par code (tes exemples)
    const CATEGORY_OVERRIDES_BY_CODE = {
      "2481": "Hygi√®ne et entretien",
      "3143": "Hygi√®ne et entretien",
      "2482": "Hygi√®ne et entretien",
      "4497": "Hygi√®ne et entretien",
      "4484": "√âpicerie sal√©e",
      "4485": "√âpicerie sal√©e",
      "2999": "Surgel√©s",
      "2639": "Surgel√©s",
      "1335": "Fruits secs & Graines",
      "4322": "Boissons"
    };

    function smartCategoryFix(name, currentCat){
      const n = (name || "").toUpperCase();

      if (/(JUDY|LILAS|LESSIVE|LAVANT|SOL|SURFACES|JEL LAVANT|LIQUIDE VAISSELLE)/.test(n)) return "Hygi√®ne et entretien";
      if (/(SALADE|MECHWIA|HARISSA|THONA|MAKROUNA|CONSERVE|SAUCE|TOMATE)/.test(n)) return "√âpicerie sal√©e";
      if (/(GLACE|BOUZA|LONDON DAIRY|ICE|CORNET)/.test(n)) return "Surgel√©s";

      return currentCat;
    }

    function normalizeCategory(c){
      const s = String(c || "Divers").trim();
      return s ? s : "Divers";
    }

    // ‚úÖ Image auto: si "image" est vide/placeholder => images/products/<CODE>.jpg
    function resolveImagePath(product){
      const code = String(product.code || product.CODE_ARTICLE || product.id || "").trim();
      const raw = String(product.image || product.imageUrl || product.IMAGE_URL || "").trim();

      if (raw && raw !== PLACEHOLDER_FILE && raw !== ("images/products/" + PLACEHOLDER_FILE)){
        if (!raw.includes("/")) return "images/products/" + raw; // ex: "4731.jpg"
        return raw;
      }
      if (code) return "images/products/" + code + ".jpg";
      return "images/products/" + PLACEHOLDER_FILE;
    }

    // ‚úÖ fallback: .jpg -> .jpeg -> .png -> placeholder
    function attachImageFallback(imgEl, product){
      const code = String(product.code || product.CODE_ARTICLE || product.id || "").trim();
      const tries = [];
      if (code){
        tries.push("images/products/" + code + ".jpg");
        tries.push("images/products/" + code + ".jpeg");
        tries.push("images/products/" + code + ".png");
        tries.push("images/" + code + ".jpg");
        tries.push("images/" + code + ".jpeg");
        tries.push("images/" + code + ".png");
      }
      tries.push("images/products/" + PLACEHOLDER_FILE);

      let i = 0;
      imgEl.addEventListener("error", () => {
        i++;
        imgEl.src = tries[Math.min(i, tries.length - 1)];
      }, { once:false });
    }

    function fmtDt(n){
      const x = Number(n || 0);
      return x.toFixed(3).replace(".", ",");
    }

    // ===== STATE =====
    let ALL = [];
    let activeCategory = "Tout";
    let searchTerm = "";
    let page = 1;
    let perPage = 72;

    function buildCategories(products){
      const set = new Set(["Tout"]);
      products.forEach(p => set.add(normalizeCategory(p.category)));
      return Array.from(set);
    }

    function renderCategories(cats){
      const wrap = document.getElementById("categories-container");
      wrap.innerHTML = "";
      cats.forEach(cat => {
        const b = document.createElement("button");
        b.className = "category-pill" + (cat === activeCategory ? " active" : "");
        b.textContent = cat;
        b.onclick = () => {
          activeCategory = cat;
          page = 1;
          render();
        };
        wrap.appendChild(b);
      });
    }

    function productMatches(p){
      const catOk = (activeCategory === "Tout") || (p.category === activeCategory);
      if (!catOk) return false;

      if (!searchTerm) return true;
      const q = searchTerm.toLowerCase().trim();
      const hay = (p.name + " " + p.category + " " + (p.code||"")).toLowerCase();
      return hay.includes(q);
    }

    function renderPager(totalItems){
      const pager = document.getElementById("pager");
      pager.innerHTML = "";

      const totalPages = Math.max(1, Math.ceil(totalItems / perPage));
      if (page > totalPages) page = totalPages;

      const prev = document.createElement("button");
      prev.className = "page-btn";
      prev.textContent = "‚óÄ";
      prev.disabled = (page === 1);
      prev.onclick = () => { page--; render(); };
      pager.appendChild(prev);

      // afficher pages autour de la page courante (max 7 boutons)
      const windowSize = 7;
      let start = Math.max(1, page - Math.floor(windowSize/2));
      let end = Math.min(totalPages, start + windowSize - 1);
      start = Math.max(1, end - windowSize + 1);

      if (start > 1){
        const b1 = document.createElement("button");
        b1.className = "page-btn";
        b1.textContent = "1";
        b1.onclick = () => { page = 1; render(); };
        pager.appendChild(b1);

        const dots = document.createElement("span");
        dots.style.color = "var(--muted)";
        dots.style.padding = "0 6px";
        dots.textContent = "‚Ä¶";
        pager.appendChild(dots);
      }

      for (let p = start; p <= end; p++){
        const b = document.createElement("button");
        b.className = "page-btn" + (p === page ? " active" : "");
        b.textContent = String(p);
        b.onclick = () => { page = p; render(); };
        pager.appendChild(b);
      }

      if (end < totalPages){
        const dots = document.createElement("span");
        dots.style.color = "var(--muted)";
        dots.style.padding = "0 6px";
        dots.textContent = "‚Ä¶";
        pager.appendChild(dots);

        const blast = document.createElement("button");
        blast.className = "page-btn";
        blast.textContent = String(totalPages);
        blast.onclick = () => { page = totalPages; render(); };
        pager.appendChild(blast);
      }

      const next = document.createElement("button");
      next.className = "page-btn";
      next.textContent = "‚ñ∂";
      next.disabled = (page === totalPages);
      next.onclick = () => { page++; render(); };
      pager.appendChild(next);
    }

    function render(){
      // categories
      renderCategories(buildCategories(ALL));

      const filtered = ALL.filter(productMatches);
      const total = filtered.length;

      const totalPages = Math.max(1, Math.ceil(total / perPage));
      const start = (page - 1) * perPage;
      const end = start + perPage;
      const slice = filtered.slice(start, end);

      document.getElementById("info-line").textContent =
        `Affichage ${Math.min(start+1,total)}‚Äì${Math.min(end,total)} sur ${total} produit(s) ‚Ä¢ Page ${page}/${totalPages}`;

      const grid = document.getElementById("products-container");
      grid.innerHTML = "";

      slice.forEach(p => {
        const card = document.createElement("div");
        card.className = "product-card";

        const media = document.createElement("div");
        media.className = "media";
        const img = document.createElement("img");
        img.alt = p.name || "Produit";
        img.src = resolveImagePath(p);
        attachImageFallback(img, p);
        media.appendChild(img);

        const header = document.createElement("div");
        header.className = "product-header";

        const left = document.createElement("div");
        const name = document.createElement("div");
        name.className = "product-name";
        name.textContent = p.name;

        const meta = document.createElement("div");
        meta.className = "product-meta";
        meta.textContent = `${p.category} ‚Ä¢ ${p.code || ""}`.trim();

        left.appendChild(name);
        left.appendChild(meta);

        const price = document.createElement("div");
        price.className = "product-price";
        price.innerHTML = `${fmtDt(p.price)} dt<br/><span class="small-text">/ ${p.unit || "pi√®ce"}</span>`;

        header.appendChild(left);
        header.appendChild(price);

        const actions = document.createElement("div");
        actions.className = "product-actions";

        const qty = document.createElement("div");
        qty.className = "qty-control";
        const minus = document.createElement("button");
        minus.textContent = "‚àí";
        const qspan = document.createElement("span");
        qspan.textContent = "1";
        const plus = document.createElement("button");
        plus.textContent = "+";
        minus.onclick = () => qspan.textContent = String(Math.max(1, Number(qspan.textContent)-1));
        plus.onclick  = () => qspan.textContent = String(Number(qspan.textContent)+1);
        qty.appendChild(minus); qty.appendChild(qspan); qty.appendChild(plus);

        const add = document.createElement("button");
        add.className = "btn-add";
        add.textContent = "Ajouter au panier";
        add.onclick = () => alert(`‚úÖ Ajout√© : ${p.name} (x${qspan.textContent})`);

        actions.appendChild(qty);
        actions.appendChild(add);

        card.appendChild(media);
        card.appendChild(header);
        card.appendChild(actions);

        grid.appendChild(card);
      });

      renderPager(total);
      document.getElementById("loading").style.display = "none";
    }

    async function init(){
      const res = await fetch(PRODUCTS_JSON_URL, { cache:"no-store" });
      const data = await res.json();

      const items = Array.isArray(data) ? data : (data.products || []);

      ALL = items.map((r) => {
        const code = String(r.code || r.CODE_ARTICLE || r.id || r.ID || "").trim();
        const name = String(r.name || r.DESIGNATION || r.designation || "").trim();
        let category = normalizeCategory(r.category || r.CATEGORIE || "Divers");

        if (CATEGORY_OVERRIDES_BY_CODE[code]) category = CATEGORY_OVERRIDES_BY_CODE[code];
        category = smartCategoryFix(name, category);

        const price = Number(
          r.price ?? r.PRIX ?? r.PRX ?? r.prix ?? 0
        );

        const unit = String(
          r.unit ?? r.UNITE ?? r.unite ?? "pi√®ce"
        ).trim() || "pi√®ce";

        const image = String(r.image ?? r.IMAGE ?? r.imageUrl ?? PLACEHOLDER_FILE).trim() || PLACEHOLDER_FILE;

        return { code, name, category, price, unit, image };
      });

      render();
    }

    // UI events
    document.getElementById("search").addEventListener("input", (e)=>{
      searchTerm = e.target.value || "";
      page = 1;
      render();
    });
    document.getElementById("clear-search").onclick = ()=>{
      document.getElementById("search").value = "";
      searchTerm = "";
      page = 1;
      render();
    };
    document.getElementById("per-page").addEventListener("change", (e)=>{
      perPage = Number(e.target.value || 72);
      page = 1;
      render();
    });

    init().catch(err=>{
      console.error(err);
      document.getElementById("loading").textContent = "Erreur de chargement (products.json).";
    });
  </script>
</body>
</html>
