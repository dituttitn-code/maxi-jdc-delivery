<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MAXI JDC MARKET">
  <meta name="theme-color" content="#0a1929">
  <title>MAXI JDC MARKET ‚Äî Application Mobile</title>
  
  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  
  <style>
    /* Tous vos styles CSS restent identiques jusqu'√† la fin */
    /* ... Votre CSS complet reste inchang√© ... */
  </style>
  
  <!-- Leaflet CSS pour les cartes -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
   integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
   crossorigin=""/>
</head>

<body>
  <!-- HTML structure reste identique -->
  <!-- ... Votre HTML complet reste inchang√© jusqu'√† la fin ... -->

<script>
// ===================== CONFIGURATION =====================
const CONFIG = {
  minOrder: 15,
  freeShipping: 100,
  shippingFee: 3,
  whatsappNumber: "21625600978",
  itemsPerPage: 24,
  localStorageKey: 'maxi_jdc_market_app_v18',
  imagesBasePath: 'maxi-jdc-market/images/products/',
  historyRetentionYears: 2,
  dynamicTextKey: 'maxi_jdc_dynamic_text',
  adminPasswordKey: 'maxi_jdc_admin_password',
  // NOUVEAU: Cl√©s pour le stockage Firebase simul√©
  firebasePromotionsKey: 'maxi_jdc_firebase_promotions',
  firebaseStockKey: 'maxi_jdc_firebase_stock',
  firebaseStatsKey: 'maxi_jdc_firebase_stats'
};

// ===================== √âTAT GLOBAL =====================
const state = {
  user: null,
  products: new Map(),
  cart: {},
  searchQuery: '',
  activeCategory: 'promotions',
  showAllCategories: false,
  currentPage: 1,
  currentModalProduct: null,
  quantityPicks: {},
  filteredProducts: [],
  currentImageIndex: 0,
  productImages: {},
  orderHistory: [],
  promotions: [],
  tempMapCoords: null,
  
  // NOUVEAU: Stock centralis√© via localStorage partag√©
  globalStock: {},
  dynamicText: "",
  
  // NOUVEAU: Promotions centralis√©es
  globalPromotions: {},
  
  // NOUVEAU: Statistiques de vente
  salesStats: {
    totalSales: 0,
    totalRevenue: 0,
    todaySales: 0,
    todayRevenue: 0,
    topProducts: [],
    monthlyStats: {}
  },
  
  productGroups: {},
  isAdmin: false,
  adminPassword: "admin123",
  showPromoSection: true,
  
  // NOUVEAU: Cache pour images manquantes
  missingImages: new Set(),
  
  // NOUVEAU: Timer pour synchronisation
  syncInterval: null
};

// ===================== SYST√àME DE SYNCHRONISATION FIREBASE SIMUL√â =====================
// Ce syst√®me utilise localStorage comme base de donn√©es partag√©e entre tous les clients

// Fonction pour charger les promotions centralis√©es
function loadGlobalPromotions() {
  try {
    const savedPromotions = localStorage.getItem(CONFIG.firebasePromotionsKey);
    if (savedPromotions) {
      state.globalPromotions = JSON.parse(savedPromotions);
      console.log('Promotions centralis√©es charg√©es:', Object.keys(state.globalPromotions).length);
      
      // Appliquer les promotions aux produits
      applyGlobalPromotions();
    } else {
      // Promotions par d√©faut
      state.globalPromotions = {
        '4350': { discount: 50, newPrice: 0.5, oldPrice: 1, active: true },
        '4349': { discount: 50, newPrice: 0.5, oldPrice: 1, active: true }
      };
      saveGlobalPromotions();
    }
  } catch (error) {
    console.error('Erreur chargement promotions centralis√©es:', error);
  }
}

// Fonction pour sauvegarder les promotions centralis√©es
function saveGlobalPromotions() {
  localStorage.setItem(CONFIG.firebasePromotionsKey, JSON.stringify(state.globalPromotions));
  
  // Notifier tous les clients ouverts (simulation de WebSocket)
  if (typeof BroadcastChannel !== 'undefined') {
    try {
      const channel = new BroadcastChannel('maxi_jdc_updates');
      channel.postMessage({ type: 'promotions_updated', timestamp: Date.now() });
    } catch (e) {
      console.log('BroadcastChannel non support√©');
    }
  }
}

// Fonction pour appliquer les promotions globales aux produits
function applyGlobalPromotions() {
  for (const [categoryKey, products] of state.products.entries()) {
    for (const product of products) {
      const promo = state.globalPromotions[product.code];
      if (promo && promo.active) {
        product.oldPrice = promo.oldPrice || product.price;
        product.price = promo.newPrice || product.price;
        product.isPromotion = true;
        product.discountPercent = promo.discount;
      }
    }
  }
  
  // Re-rendre les produits si n√©cessaire
  if (state.activeCategory === 'promotions' || state.showAllCategories) {
    renderProducts();
  }
}

// NOUVEAU: Syst√®me de stock centralis√©
function loadGlobalStock() {
  try {
    const savedStock = localStorage.getItem(CONFIG.firebaseStockKey);
    if (savedStock) {
      state.globalStock = JSON.parse(savedStock);
      console.log('Stock centralis√© charg√©:', Object.keys(state.globalStock).length, 'produits');
    } else {
      // Stock par d√©faut
      state.globalStock = {
        'CAF001': { inStock: true, quantity: 50, lastUpdated: Date.now() },
        'CAF002': { inStock: true, quantity: 30, lastUpdated: Date.now() },
        'CAF003': { inStock: false, quantity: 0, lastUpdated: Date.now() },
        'CHO001': { inStock: true, quantity: 25, lastUpdated: Date.now() },
        'CHO002': { inStock: true, quantity: 40, lastUpdated: Date.now() },
        'BIS001': { inStock: true, quantity: 60, lastUpdated: Date.now() },
        'BIS002': { inStock: false, quantity: 0, lastUpdated: Date.now() },
        'EAU001': { inStock: true, quantity: 100, lastUpdated: Date.now() },
        'EAU002': { inStock: true, quantity: 80, lastUpdated: Date.now() },
        'JUS001': { inStock: true, quantity: 45, lastUpdated: Date.now() },
        'JUS002': { inStock: true, quantity: 35, lastUpdated: Date.now() },
        'LAI001': { inStock: true, quantity: 20, lastUpdated: Date.now() },
        'LAI002': { inStock: false, quantity: 0, lastUpdated: Date.now() },
        'FRI001': { inStock: true, quantity: 70, lastUpdated: Date.now() },
        'FRI002': { inStock: true, quantity: 55, lastUpdated: Date.now() },
        '4350': { inStock: true, quantity: 40, lastUpdated: Date.now() },
        '4349': { inStock: true, quantity: 35, lastUpdated: Date.now() }
      };
      saveGlobalStock();
    }
  } catch (error) {
    console.error('Erreur chargement stock global:', error);
    state.globalStock = {};
  }
}

function saveGlobalStock() {
  localStorage.setItem(CONFIG.firebaseStockKey, JSON.stringify(state.globalStock));
  
  // Notifier les autres clients
  if (typeof BroadcastChannel !== 'undefined') {
    try {
      const channel = new BroadcastChannel('maxi_jdc_updates');
      channel.postMessage({ type: 'stock_updated', timestamp: Date.now() });
    } catch (e) {
      console.log('BroadcastChannel non support√©');
    }
  }
}

// NOUVEAU: Syst√®me de statistiques
function loadSalesStats() {
  try {
    const savedStats = localStorage.getItem(CONFIG.firebaseStatsKey);
    if (savedStats) {
      state.salesStats = JSON.parse(savedStats);
    }
  } catch (error) {
    console.error('Erreur chargement statistiques:', error);
  }
}

function saveSalesStats() {
  localStorage.setItem(CONFIG.firebaseStatsKey, JSON.stringify(state.salesStats));
}

// NOUVEAU: Ajouter une vente aux statistiques
function addSaleToStats(orderData) {
  const today = new Date().toDateString();
  const month = new Date().toLocaleDateString('fr-FR', { year: 'numeric', month: 'numeric' });
  
  // Mettre √† jour les totaux
  state.salesStats.totalSales += orderData.itemCount;
  state.salesStats.totalRevenue += orderData.total;
  
  // Mettre √† jour les stats du jour
  state.salesStats.todaySales += orderData.itemCount;
  state.salesStats.todayRevenue += orderData.total;
  
  // Mettre √† jour les stats mensuelles
  if (!state.salesStats.monthlyStats[month]) {
    state.salesStats.monthlyStats[month] = {
      sales: 0,
      revenue: 0,
      orders: 0
    };
  }
  state.salesStats.monthlyStats[month].sales += orderData.itemCount;
  state.salesStats.monthlyStats[month].revenue += orderData.total;
  state.salesStats.monthlyStats[month].orders += 1;
  
  // Mettre √† jour les produits les plus vendus
  orderData.items.forEach(item => {
    const existingProduct = state.salesStats.topProducts.find(p => p.code === item.code);
    if (existingProduct) {
      existingProduct.quantitySold += item.quantity;
      existingProduct.revenue += item.price * item.quantity;
    } else {
      state.salesStats.topProducts.push({
        code: item.code,
        name: item.name,
        quantitySold: item.quantity,
        revenue: item.price * item.quantity
      });
    }
  });
  
  // Trier les produits les plus vendus
  state.salesStats.topProducts.sort((a, b) => b.quantitySold - a.quantitySold);
  state.salesStats.topProducts = state.salesStats.topProducts.slice(0, 10);
  
  saveSalesStats();
}

// ===================== GESTION DES IMAGES =====================
// NOUVELLE FONCTION: Gestion intelligente des images
function getProductImageSrc(productCode, productName) {
  const imgSrc = `${CONFIG.imagesBasePath}${productCode}.jpg`;
  
  // V√©rifier si l'image est manquante en cache
  if (state.missingImages.has(productCode)) {
    return null;
  }
  
  return imgSrc;
}

// NOUVELLE FONCTION: Pr√©tester les images
async function preloadMissingImages() {
  const products = [...state.products.values()].flat();
  const testPromises = [];
  
  // Tester les 20 premi√®res images
  const productsToTest = products.slice(0, 20);
  
  for (const product of productsToTest) {
    const imgSrc = `${CONFIG.imagesBasePath}${product.code}.jpg`;
    testPromises.push(
      new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve({ code: product.code, exists: true });
        img.onerror = () => {
          state.missingImages.add(product.code);
          resolve({ code: product.code, exists: false });
        };
        img.src = imgSrc;
      })
    );
  }
  
  const results = await Promise.all(testPromises);
  console.log('Images test√©es:', results.filter(r => !r.exists).length, 'manquantes');
}

// ===================== ADMIN - GESTION DES PROMOTIONS =====================
// NOUVELLE FONCTION: Modal de gestion des promotions
function openPromoManagementModal() {
  if (!state.isAdmin) {
    toggleAdminMode();
    return;
  }
  
  const modalHTML = `
    <div class="edit-text-modal-overlay" id="promoManagementModal">
      <div class="edit-text-modal" style="max-width: 600px;">
        <div class="edit-text-header">
          <h3>üìä Gestion des Promotions</h3>
        </div>
        
        <div class="edit-text-body">
          <div style="margin-bottom: 20px;">
            <h4 style="color: var(--accent); margin-bottom: 10px;">Promotions actives</h4>
            <div id="activePromotionsList" style="max-height: 300px; overflow-y: auto; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px;">
              <!-- Les promotions seront ajout√©es ici -->
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h4 style="color: var(--accent); margin-bottom: 10px;">Ajouter une promotion</h4>
            <div class="form-field">
              <label for="promoProductCode">Code produit</label>
              <input type="text" id="promoProductCode" placeholder="ex: 4350" style="width: 100%;">
            </div>
            
            <div class="form-row">
              <div class="form-field">
                <label for="promoDiscount">Rabais (%)</label>
                <input type="number" id="promoDiscount" min="1" max="100" value="50" style="width: 100%;">
              </div>
              
              <div class="form-field">
                <label for="promoDuration">Dur√©e (jours)</label>
                <select id="promoDuration" style="width: 100%; height: 40px; background: rgba(255,255,255,0.08); color: var(--text); border: 1px solid var(--line); border-radius: 8px; padding: 0 10px;">
                  <option value="7">7 jours</option>
                  <option value="14">14 jours</option>
                  <option value="30">30 jours</option>
                  <option value="9999">Illimit√©</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <div class="edit-text-footer">
          <button class="form-btn" id="cancelPromoManagementBtn">
            Annuler
          </button>
          <button class="form-btn primary" id="savePromoBtn">
            üíæ Appliquer la promotion
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Ajouter le modal au DOM
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // Remplir la liste des promotions actives
  renderActivePromotionsList();
  
  // Ouvrir le modal
  setTimeout(() => {
    document.getElementById('promoManagementModal').classList.add('open');
    document.body.style.overflow = 'hidden';
    
    // Ajouter les √©v√©nements
    document.getElementById('cancelPromoManagementBtn').onclick = closePromoManagementModal;
    document.getElementById('savePromoBtn').onclick = savePromotion;
  }, 10);
}

function renderActivePromotionsList() {
  const container = document.getElementById('activePromotionsList');
  if (!container) return;
  
  container.innerHTML = '';
  
  const activePromos = Object.entries(state.globalPromotions)
    .filter(([code, promo]) => promo.active)
    .slice(0, 10); // Limiter √† 10 pour la performance
  
  if (activePromos.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 20px;">Aucune promotion active</p>';
    return;
  }
  
  activePromos.forEach(([code, promo]) => {
    const promoElement = document.createElement('div');
    promoElement.className = 'promo-item';
    promoElement.style.cssText = `
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px; background: rgba(255,107,0,0.1); border-radius: 8px;
      margin-bottom: 8px; border: 1px solid rgba(255,107,0,0.3);
    `;
    
    promoElement.innerHTML = `
      <div>
        <strong style="color: var(--accent);">${code}</strong>
        <div style="font-size: 12px; color: var(--text);">-${promo.discount}% | Prix: ${promo.newPrice} dt</div>
      </div>
      <button class="remove-promo-btn" data-code="${code}" style="
        background: rgba(255,107,107,0.2); border: 1px solid var(--danger); color: var(--danger);
        padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;
      ">Supprimer</button>
    `;
    
    container.appendChild(promoElement);
  });
  
  // Ajouter les √©v√©nements pour les boutons de suppression
  container.querySelectorAll('.remove-promo-btn').forEach(btn => {
    btn.onclick = function() {
      const code = this.getAttribute('data-code');
      removePromotion(code);
    };
  });
}

function savePromotion() {
  const code = document.getElementById('promoProductCode').value.trim();
  const discount = parseInt(document.getElementById('promoDiscount').value);
  const duration = parseInt(document.getElementById('promoDuration').value);
  
  if (!code || !discount || discount < 1 || discount > 100) {
    showToast('‚ùå Veuillez entrer des donn√©es valides', 'error');
    return;
  }
  
  // Trouver le produit pour obtenir son prix original
  let originalPrice = null;
  for (const [categoryKey, products] of state.products.entries()) {
    const product = products.find(p => p.code === code);
    if (product) {
      originalPrice = product.price;
      break;
    }
  }
  
  if (!originalPrice) {
    showToast('‚ùå Produit non trouv√©', 'error');
    return;
  }
  
  const newPrice = originalPrice * (1 - discount / 100);
  const expiryDate = duration === 9999 ? null : Date.now() + (duration * 24 * 60 * 60 * 1000);
  
  // Sauvegarder la promotion
  state.globalPromotions[code] = {
    discount: discount,
    newPrice: parseFloat(newPrice.toFixed(2)),
    oldPrice: originalPrice,
    active: true,
    createdAt: Date.now(),
    expiresAt: expiryDate
  };
  
  saveGlobalPromotions();
  applyGlobalPromotions();
  closePromoManagementModal();
  
  showToast(`‚úÖ Promotion de ${discount}% appliqu√©e au produit ${code}`);
}

function removePromotion(code) {
  if (confirm(`Supprimer la promotion pour le produit ${code} ?`)) {
    delete state.globalPromotions[code];
    saveGlobalPromotions();
    applyGlobalPromotions();
    renderActivePromotionsList();
    showToast(`Promotion supprim√©e pour ${code}`, 'warning');
  }
}

function closePromoManagementModal() {
  const modal = document.getElementById('promoManagementModal');
  if (modal) {
    modal.classList.remove('open');
    setTimeout(() => modal.remove(), 300);
  }
  document.body.style.overflow = '';
}

// ===================== ADMIN - STATISTIQUES =====================
function openStatsModal() {
  if (!state.isAdmin) {
    toggleAdminMode();
    return;
  }
  
  const today = new Date().toLocaleDateString('fr-FR');
  const totalRevenue = state.salesStats.totalRevenue.toFixed(2);
  const todayRevenue = state.salesStats.todayRevenue.toFixed(2);
  
  const modalHTML = `
    <div class="edit-text-modal-overlay" id="statsModal">
      <div class="edit-text-modal" style="max-width: 700px;">
        <div class="edit-text-header">
          <h3>üìà Tableau de Bord - Statistiques de Vente</h3>
        </div>
        
        <div class="edit-text-body">
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: linear-gradient(135deg, var(--accent), var(--accent2)); padding: 15px; border-radius: 10px;">
              <div style="font-size: 12px; opacity: 0.9;">Chiffre d'affaires total</div>
              <div style="font-size: 24px; font-weight: 900;">${totalRevenue} dt</div>
            </div>
            
            <div style="background: linear-gradient(135deg, #ff6b6b, #ffa726); padding: 15px; border-radius: 10px;">
              <div style="font-size: 12px; opacity: 0.9;">Ventes aujourd'hui (${today})</div>
              <div style="font-size: 24px; font-weight: 900;">${todayRevenue} dt</div>
            </div>
            
            <div style="background: linear-gradient(135deg, #00d4ff, #4cc9ff); padding: 15px; border-radius: 10px;">
              <div style="font-size: 12px; opacity: 0.9;">Total articles vendus</div>
              <div style="font-size: 24px; font-weight: 900;">${state.salesStats.totalSales}</div>
            </div>
            
            <div style="background: linear-gradient(135deg, #9d4edd, #c77dff); padding: 15px; border-radius: 10px;">
              <div style="font-size: 12px; opacity: 0.9;">Articles vendus aujourd'hui</div>
              <div style="font-size: 24px; font-weight: 900;">${state.salesStats.todaySales}</div>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h4 style="color: var(--accent); margin-bottom: 10px;">üì¶ Top 10 des produits</h4>
            <div id="topProductsList" style="max-height: 200px; overflow-y: auto; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px;">
              <!-- Les produits seront ajout√©s ici -->
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h4 style="color: var(--accent); margin-bottom: 10px;">üìÖ Statistiques mensuelles</h4>
            <div id="monthlyStats" style="max-height: 200px; overflow-y: auto; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px;">
              <!-- Les stats mensuelles seront ajout√©es ici -->
            </div>
          </div>
        </div>
        
        <div class="edit-text-footer">
          <button class="form-btn" id="closeStatsModalBtn">
            ‚úï Fermer
          </button>
          <button class="form-btn primary" id="exportStatsBtn">
            üì§ Exporter les donn√©es
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // Remplir les statistiques
  renderTopProductsList();
  renderMonthlyStats();
  
  // Ouvrir le modal
  setTimeout(() => {
    document.getElementById('statsModal').classList.add('open');
    document.body.style.overflow = 'hidden';
    
    // Ajouter les √©v√©nements
    document.getElementById('closeStatsModalBtn').onclick = closeStatsModal;
    document.getElementById('exportStatsBtn').onclick = exportStatsData;
  }, 10);
}

function renderTopProductsList() {
  const container = document.getElementById('topProductsList');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (state.salesStats.topProducts.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 20px;">Aucune donn√©e de vente</p>';
    return;
  }
  
  state.salesStats.topProducts.slice(0, 10).forEach((product, index) => {
    const productElement = document.createElement('div');
    productElement.style.cssText = `
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;
      margin-bottom: 6px; border: 1px solid rgba(255,255,255,0.1);
    `;
    
    productElement.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="background: var(--accent); color: var(--bg0); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 12px;">
          ${index + 1}
        </span>
        <div>
          <div style="font-weight: 700; font-size: 12px;">${product.name}</div>
          <div style="font-size: 10px; color: var(--muted);">Code: ${product.code}</div>
        </div>
      </div>
      <div style="text-align: right;">
        <div style="font-weight: 900; color: var(--accent);">${product.quantitySold} unit√©s</div>
        <div style="font-size: 10px; color: var(--muted);">${product.revenue.toFixed(2)} dt</div>
      </div>
    `;
    
    container.appendChild(productElement);
  });
}

function renderMonthlyStats() {
  const container = document.getElementById('monthlyStats');
  if (!container) return;
  
  container.innerHTML = '';
  
  const months = Object.keys(state.salesStats.monthlyStats).sort().reverse().slice(0, 6);
  
  if (months.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 20px;">Aucune donn√©e mensuelle</p>';
    return;
  }
  
  months.forEach(month => {
    const stats = state.salesStats.monthlyStats[month];
    const monthElement = document.createElement('div');
    monthElement.style.cssText = `
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
      padding: 10px; background: rgba(255,255,255,0.03); border-radius: 6px;
      margin-bottom: 6px; border: 1px solid rgba(255,255,255,0.1);
    `;
    
    monthElement.innerHTML = `
      <div>
        <div style="font-weight: 700; font-size: 12px;">${month}</div>
        <div style="font-size: 10px; color: var(--muted);">${stats.orders} commandes</div>
      </div>
      <div style="text-align: center;">
        <div style="font-weight: 900; color: var(--accent);">${stats.sales}</div>
        <div style="font-size: 10px; color: var(--muted);">articles</div>
      </div>
      <div style="text-align: right;">
        <div style="font-weight: 900; color: var(--accent2);">${stats.revenue.toFixed(2)}</div>
        <div style="font-size: 10px; color: var(--muted);">dt</div>
      </div>
    `;
    
    container.appendChild(monthElement);
  });
}

function exportStatsData() {
  const dataStr = JSON.stringify(state.salesStats, null, 2);
  const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
  const filename = `stats_maxi_jdc_${date}.json`;
  
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('‚úÖ Statistiques export√©es');
}

function closeStatsModal() {
  const modal = document.getElementById('statsModal');
  if (modal) {
    modal.classList.remove('open');
    setTimeout(() => modal.remove(), 300);
  }
  document.body.style.overflow = '';
}

// ===================== ADMIN - GESTION DU STOCK =====================
function openStockManagementModal() {
  if (!state.isAdmin) {
    toggleAdminMode();
    return;
  }
  
  const modalHTML = `
    <div class="edit-text-modal-overlay" id="stockManagementModal">
      <div class="edit-text-modal" style="max-width: 800px;">
        <div class="edit-text-header">
          <h3>üì¶ Gestion du Stock</h3>
        </div>
        
        <div class="edit-text-body">
          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="stockSearchInput" placeholder="üîç Rechercher un produit..." style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--line); background: rgba(255,255,255,0.08); color: var(--text);">
            <button id="addStockBtn" style="padding: 10px 20px; border-radius: 8px; border: 2px solid var(--accent); background: rgba(0,255,136,0.1); color: var(--accent); font-weight: 700; cursor: pointer;">
              + Ajouter
            </button>
          </div>
          
          <div id="stockList" style="max-height: 400px; overflow-y: auto; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px;">
            <!-- La liste des stocks sera ajout√©e ici -->
          </div>
          
          <div style="margin-top: 20px; padding: 15px; background: rgba(255,107,0,0.1); border-radius: 8px; border: 1px solid rgba(255,107,0,0.3);">
            <h4 style="color: #ff6b00; margin-bottom: 10px;">‚ö†Ô∏è Produits en rupture de stock</h4>
            <div id="outOfStockList">
              <!-- Les produits en rupture seront ajout√©s ici -->
            </div>
          </div>
        </div>
        
        <div class="edit-text-footer">
          <button class="form-btn" id="closeStockModalBtn">
            ‚úï Fermer
          </button>
          <button class="form-btn primary" id="saveAllStockBtn">
            üíæ Sauvegarder tous les changements
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // Remplir la liste des stocks
  renderStockList();
  
  // Ouvrir le modal
  setTimeout(() => {
    document.getElementById('stockManagementModal').classList.add('open');
    document.body.style.overflow = 'hidden';
    
    // Ajouter les √©v√©nements
    document.getElementById('closeStockModalBtn').onclick = closeStockManagementModal;
    document.getElementById('saveAllStockBtn').onclick = saveAllStockChanges;
    document.getElementById('addStockBtn').onclick = addNewStockItem;
    document.getElementById('stockSearchInput').oninput = filterStockList;
  }, 10);
}

function renderStockList(filter = '') {
  const container = document.getElementById('stockList');
  if (!container) return;
  
  container.innerHTML = '';
  
  const stockEntries = Object.entries(state.globalStock)
    .filter(([code, stock]) => 
      code.toLowerCase().includes(filter.toLowerCase()) ||
      (getProductNameByCode(code) || '').toLowerCase().includes(filter.toLowerCase())
    )
    .sort(([codeA], [codeB]) => codeA.localeCompare(codeB));
  
  if (stockEntries.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 20px;">Aucun produit en stock</p>';
    return;
  }
  
  stockEntries.forEach(([code, stock]) => {
    const productName = getProductNameByCode(code) || 'Produit inconnu';
    const stockElement = document.createElement('div');
    stockElement.className = 'stock-item';
    stockElement.style.cssText = `
      display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; align-items: center;
      padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;
      margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.1);
    `;
    
    stockElement.innerHTML = `
      <div>
        <div style="font-weight: 700; font-size: 12px;">${productName}</div>
        <div style="font-size: 10px; color: var(--muted);">Code: ${code}</div>
      </div>
      
      <div>
        <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">Quantit√©</div>
        <input type="number" min="0" value="${stock.quantity}" 
               data-code="${code}" data-field="quantity"
               style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid var(--line); background: rgba(255,255,255,0.1); color: var(--text);">
      </div>
      
      <div>
        <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">En stock</div>
        <select data-code="${code}" data-field="inStock"
                style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid var(--line); background: rgba(255,255,255,0.1); color: var(--text);">
          <option value="true" ${stock.inStock ? 'selected' : ''}>Oui</option>
          <option value="false" ${!stock.inStock ? 'selected' : ''}>Non</option>
        </select>
      </div>
      
      <div>
        <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">Actions</div>
        <button class="delete-stock-btn" data-code="${code}" style="
          padding: 6px 12px; border-radius: 6px; border: 1px solid var(--danger); 
          background: rgba(255,107,107,0.1); color: var(--danger); cursor: pointer; font-size: 11px; width: 100%;
        ">Supprimer</button>
      </div>
    `;
    
    container.appendChild(stockElement);
  });
  
  // Ajouter les √©v√©nements
  container.querySelectorAll('input[data-field="quantity"]').forEach(input => {
    input.onchange = function() {
      updateStockItem(this.getAttribute('data-code'), 'quantity', this.value);
    };
  });
  
  container.querySelectorAll('select[data-field="inStock"]').forEach(select => {
    select.onchange = function() {
      updateStockItem(this.getAttribute('data-code'), 'inStock', this.value === 'true');
    };
  });
  
  container.querySelectorAll('.delete-stock-btn').forEach(btn => {
    btn.onclick = function() {
      deleteStockItem(this.getAttribute('data-code'));
    };
  });
  
  // Afficher les produits en rupture
  renderOutOfStockList();
}

function getProductNameByCode(code) {
  for (const [categoryKey, products] of state.products.entries()) {
    const product = products.find(p => p.code === code);
    if (product) return product.name;
  }
  return null;
}

function updateStockItem(code, field, value) {
  if (!state.globalStock[code]) {
    state.globalStock[code] = { inStock: true, quantity: 0 };
  }
  
  if (field === 'quantity') {
    state.globalStock[code].quantity = parseInt(value) || 0;
    if (state.globalStock[code].quantity <= 0) {
      state.globalStock[code].inStock = false;
    }
  } else if (field === 'inStock') {
    state.globalStock[code].inStock = value;
  }
  
  state.globalStock[code].lastUpdated = Date.now();
  
  // Mettre √† jour l'affichage en temps r√©el
  const stockItem = document.querySelector(`[data-code="${code}"]`);
  if (stockItem) {
    if (field === 'inStock') {
      const select = stockItem.closest('.stock-item').querySelector('select[data-field="inStock"]');
      if (select) select.value = value;
    }
  }
  
  showToast(`‚úÖ Stock mis √† jour pour ${code}`, 'success');
}

function deleteStockItem(code) {
  if (confirm(`Supprimer le stock pour ${code} ?`)) {
    delete state.globalStock[code];
    renderStockList();
    showToast(`Stock supprim√© pour ${code}`, 'warning');
  }
}

function addNewStockItem() {
  const code = prompt('Entrez le code du produit:');
  if (!code) return;
  
  if (state.globalStock[code]) {
    showToast('‚ùå Ce produit existe d√©j√†', 'error');
    return;
  }
  
  const quantity = parseInt(prompt('Quantit√© initiale:', '10')) || 10;
  
  state.globalStock[code] = {
    inStock: quantity > 0,
    quantity: quantity,
    lastUpdated: Date.now()
  };
  
  renderStockList();
  showToast(`‚úÖ Produit ${code} ajout√© au stock`);
}

function filterStockList() {
  const filter = document.getElementById('stockSearchInput').value;
  renderStockList(filter);
}

function saveAllStockChanges() {
  saveGlobalStock();
  showToast('‚úÖ Tous les changements de stock sauvegard√©s');
  closeStockManagementModal();
}

function renderOutOfStockList() {
  const container = document.getElementById('outOfStockList');
  if (!container) return;
  
  const outOfStock = Object.entries(state.globalStock)
    .filter(([code, stock]) => !stock.inStock || stock.quantity <= 0)
    .slice(0, 5);
  
  container.innerHTML = '';
  
  if (outOfStock.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 10px;">Aucun produit en rupture</p>';
    return;
  }
  
  outOfStock.forEach(([code, stock]) => {
    const productName = getProductNameByCode(code) || 'Produit inconnu';
    const item = document.createElement('div');
    item.style.cssText = `
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px; background: rgba(255,107,107,0.1); border-radius: 6px;
      margin-bottom: 6px; border: 1px solid rgba(255,107,107,0.3);
    `;
    
    item.innerHTML = `
      <div style="font-weight: 700; font-size: 12px;">${productName}</div>
      <div style="font-size: 11px; color: var(--danger);">${stock.quantity} restants</div>
    `;
    
    container.appendChild(item);
  });
}

function closeStockManagementModal() {
  const modal = document.getElementById('stockManagementModal');
  if (modal) {
    modal.classList.remove('open');
    setTimeout(() => modal.remove(), 300);
  }
  document.body.style.overflow = '';
}

// ===================== AM√âLIORATION DES ARTICLES SIMILAIRES =====================
function categorizeProductByUsage(product) {
  const name = product.name.toLowerCase();
  const category = product.categoryKey.toLowerCase();
  
  // Groupes √©tendus pour meilleures recommandations
  const groups = {
    // Boissons
    'boissons_froides': ['eau', 'jus', 'soda', 'boisson gazeuse', 'limonade', 'cola', 'fanta', 'sprite', 'orangina', 'schweppes'],
    'boissons_chaudes': ['caf√©', 'th√©', 'infusion', 'chocolat chaud', 'cappuccino', 'expresso', 'nescaf√©', 'caf√© soluble', 'th√© vert'],
    'boissons_energisantes': ['red bull', 'monster', 'burn', 'energy drink', 'boisson √©nergisante', 'powerade'],
    
    // Snacks
    'snacks_sales': ['chips', 'cacahu√®tes', 'noix', 'amandes', 'biscuits sal√©s', 'crackers', 'pretzels', 'crunchies', 'bretzels', 'popcorn'],
    'snacks_sucres': ['chocolat', 'biscuit', 'g√¢teau', 'bonbon', 'sucre', 'chewing-gum', 'caramel', 'nougat', 'marshmallow', 'dragibus'],
    'glaces_desserts': ['glace', 'cr√®me glac√©e', 'yaourt', 'dessert', 'mousse', 'pudding', 'flan', 'tiramisu', 'cheesecake'],
    
    // Produits frais
    'produits_laitiers': ['lait', 'yaourt', 'fromage', 'beurre', 'cr√®me', 'yogourt', 'petit suisse', 'fromage blanc', 'cr√®me fra√Æche'],
    'viandes_charcuteries': ['jambon', 'saucisson', 'p√¢t√©', 'viande', 'poulet', 'b≈ìuf', 'charcuterie', 'salami', 'rosette', 'saucisse'],
    'fruits_legumes': ['pomme', 'banane', 'orange', 'fraise', 'salade', 'tomate', 'carotte', 'oignon', 'poivron', 'concombre', 'citron'],
    
    // √âpicerie
    'conserves': ['conserve', 'bo√Æte', 'haricots', 'ma√Øs', 'thon', 'sardine', 'p√¢t√©', 'ravioli', 'cassoulet', 'confiture'],
    'pates_riz': ['p√¢tes', 'spaghetti', 'riz', 'couscous', 'semoule', 'nouilles', 'lasagnes', 'macaroni', 'penne', 'tagliatelle'],
    'huiles_condiments': ['huile', 'vinaigre', 'sel', 'poivre', '√©pice', 'sauce', 'ketchup', 'mayonnaise', 'moutarde', 'soja', 'harissa'],
    
    // Hygi√®ne & Soins
    'hygiene_corporelle': ['savon', 'shampooing', 'dentifrice', 'd√©odorant', 'gel douche', 'rasoir', 'mousse √† raser', 'lotion'],
    'produits_menage': ['lessive', 'd√©tergent', 'nettoyant', 'javel', '√©ponge', 'sac poubelle', 'lave-vitre', 'd√©sodorisant'],
    'soins_beaute': ['cr√®me', 'parfum', 'maquillage', 'vernis', 'lotion', 'solaire', 'masque', 'shampooing', 'apr√®s-shampooing'],
    
    // B√©b√© & Animaux
    'produits_bebe': ['couche', 'lait b√©b√©', 'biberon', 't√©tine', 'jouet b√©b√©', 'bavoir', 'linge b√©b√©', 'cr√®me b√©b√©'],
    'animaux': ['croquette', 'chien', 'chat', 'nourriture animale', 'liti√®re', 'jouet animal', 'ciuffi', 'friandise', 'os √† m√¢cher'],
    
    // Sp√©cialit√©s
    'produits_du_monde': ['couscous', 'tajine', 'sushi', 'pizza', 'hamburger', 'kebab', 'tacos', 'burrito', 'nems', 'samossa'],
    'produits_sans_gluten': ['sans gluten', 'gluten free'],
    'produits_bio': ['bio', 'biologique', 'organic', 'naturel'],
    
    // Nouveaux groupes
    'petit_dejeuner': ['c√©r√©ales', 'muesli', 'biscottes', 'confiture', 'miel', 'nutella', 'p√¢te √† tartiner'],
    'ap√©ritif': ['cacahu√®tes', 'chips', 'biscuits ap√©ritif', 'olives', 'saucisson', 'fromage'],
    'cuisine_rapide': ['soupe', 'pur√©e', 'nouilles instantan√©es', 'hamburger', 'pizza', 'sandwich'],
    'sucreries': ['chocolat', 'bonbons', 'chewing-gum', 'barre chocolat√©e', 'biscuit', 'g√¢teau']
  };
  
  // Recherche par nom
  for (const [group, keywords] of Object.entries(groups)) {
    for (const keyword of keywords) {
      if (name.includes(keyword)) {
        return group;
      }
    }
  }
  
  // Recherche par cat√©gorie
  for (const [group, keywords] of Object.entries(groups)) {
    for (const keyword of keywords) {
      if (category.includes(keyword)) {
        return group;
      }
    }
  }
  
  // Si aucun groupe trouv√©, utiliser la cat√©gorie principale
  return category;
}

function getSimilarProductsByUsage(currentProduct) {
  if (!currentProduct) return [];
  
  const group = categorizeProductByUsage(currentProduct);
  const similarProducts = state.productGroups[group] || [];
  
  // Filtrer le produit actuel et ceux hors stock
  const filtered = similarProducts.filter(product => 
    !(product.code === currentProduct.code && product.categoryKey === currentProduct.categoryKey) &&
    isInStockGlobal(product.code)
  );
  
  // Trier par pertinence (m√™me cat√©gorie d'abord, puis prix similaire)
  filtered.sort((a, b) => {
    // M√™me cat√©gorie en premier
    if (a.categoryKey === currentProduct.categoryKey && b.categoryKey !== currentProduct.categoryKey) return -1;
    if (b.categoryKey === currentProduct.categoryKey && a.categoryKey !== currentProduct.categoryKey) return 1;
    
    // Prix similaire
    const priceDiffA = Math.abs(a.price - currentProduct.price);
    const priceDiffB = Math.abs(b.price - currentProduct.price);
    return priceDiffA - priceDiffB;
  });
  
  // Limiter √† 8 produits maximum
  return filtered.slice(0, 8);
}

// ===================== MODIFICATIONS DES FONCTIONS EXISTANTES =====================
// Modifier la fonction init() pour ajouter la synchronisation
function init() {
  loadState();
  
  // NOUVEAU: Charger les donn√©es centralis√©es
  loadGlobalPromotions();
  loadGlobalStock();
  loadSalesStats();
  
  checkAdminStatus();
  
  // Header
  $('cartTopBtn').onclick = openDrawer;
  
  // Recherche
  $('searchInput').addEventListener('input', (e) => {
    state.searchQuery = e.target.value;
    state.currentPage = 1;
    renderProducts();
  });
  
  $('searchEnterBtn').onclick = () => {
    state.currentPage = 1;
    renderProducts();
    $('searchInput').focus();
  };
  
  $('searchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      state.currentPage = 1;
      renderProducts();
    }
  });
  
  $('clearSearchBtn').onclick = () => {
    $('searchInput').value = '';
    state.searchQuery = '';
    state.currentPage = 1;
    renderProducts();
    $('searchInput').focus();
  };
  
  $('showAllBtn').onclick = () => {
    state.showAllCategories = true;
    state.currentPage = 1;
    renderProducts();
    updateCategoriesUI();
    updateDynamicTextVisibility();
  };
  
  // Texte dynamique
  $('togglePromoTextBtn').onclick = togglePromoText;
  $('hidePromoBtn').onclick = hidePromoSection;
  $('editDynamicTextBtn').onclick = openEditTextModal;
  $('clearDynamicTextBtn').onclick = clearDynamicText;
  $('saveEditTextBtn').onclick = saveDynamicText;
  $('cancelEditTextBtn').onclick = closeEditTextModal;
  
  // QR Code
  $('qrInfoBtn').onclick = openQrModal;
  $('qrDirectBtn').onclick = openQrModal;
  $('closeQrModalBtn').onclick = closeQrModal;
  
  // Promotions
  $('viewPromosBtn').onclick = () => {
    state.showAllCategories = false;
    state.activeCategory = 'promotions';
    state.currentPage = 1;
    renderProducts();
    updateCategoriesUI();
    updateDynamicTextVisibility();
    closeDrawer();
  };
  
  // Pagination
  $('prevPageBtn').onclick = navigateToPrevPage;
  $('nextPageBtn').onclick = navigateToNextPage;
  $('prevPageBottomBtn').onclick = navigateToPrevPage;
  $('nextPageBottomBtn').onclick = navigateToNextPage;
  
  // Drawer
  $('closeDrawerBtn').onclick = closeDrawer;
  $('drawerOverlay').onclick = closeDrawer;
  
  // Admin - MODIFI√â pour utiliser les nouvelles fonctions
  $('secretAdminBtn').onclick = toggleAdminMode;
  
  $('adminPromoBtn').onclick = openPromoManagementModal;
  
  $('adminStockBtn').onclick = openStockManagementModal;
  
  $('adminStatsBtn').onclick = openStatsModal;
  
  $('adminSettingsBtn').onclick = () => {
    if (!state.isAdmin) {
      toggleAdminMode();
      return;
    }
    showToast('‚öôÔ∏è Param√®tres - Fonctionnalit√© √† venir', 'warning');
  };
  
  // Compte utilisateur
  $('saveAccountBtn').onclick = saveUser;
  $('editAccountBtn').onclick = editUser;
  
  // Historique
  $('searchHistoryBtn').onclick = searchOrderHistory;
  
  // T√©l√©phone
  $('clientPhone').addEventListener('input', function(e) {
    let value = this.value;
    const cursorPos = this.selectionStart;
    
    let digits = value.replace(/\D/g, '');
    if (digits.length > 8) {
      digits = digits.substring(0, 8);
    }
    
    let formatted = '';
    for (let i = 0; i < digits.length; i++) {
      if (i === 2 || i === 5) {
        formatted += ' ';
      }
      formatted += digits[i];
    }
    
    this.value = formatted;
    const newCursorPos = cursorPos + (formatted.length - value.length);
    this.setSelectionRange(newCursorPos, newCursorPos);
    
    updatePhoneClearButton();
    validatePhoneInput(this);
  });
  
  function validatePhoneInput(input) {
    const digits = input.value.replace(/\D/g, '');
    if (digits.length === 8) {
      input.style.borderColor = 'var(--accent)';
      input.style.background = 'rgba(0,255,136,0.05)';
    } else if (digits.length > 0) {
      input.style.borderColor = 'var(--warning)';
      input.style.background = 'rgba(255,167,38,0.05)';
    } else {
      input.style.borderColor = 'var(--line)';
      input.style.background = 'rgba(255,255,255,0.08)';
    }
  }
  
  $('clientPhone').addEventListener('focus', function() {
    this.type = 'tel';
    this.setAttribute('inputmode', 'numeric');
    validatePhoneInput(this);
  });
  
  $('clientPhone').addEventListener('blur', function() {
    validatePhoneInput(this);
  });
  
  $('clearPhoneBtn').onclick = () => {
    $('clientPhone').value = '';
    $('clientPhone').style.borderColor = 'var(--line)';
    $('clientPhone').style.background = 'rgba(255,255,255,0.08)';
    $('clientPhone').focus();
    updatePhoneClearButton();
  };
  
  // M√™me traitement pour le champ de recherche d'historique
  $('searchHistoryPhone').addEventListener('input', function(e) {
    let value = this.value;
    let digits = value.replace(/\D/g, '');
    if (digits.length > 8) {
      digits = digits.substring(0, 8);
    }
    
    let formatted = '';
    for (let i = 0; i < digits.length; i++) {
      if (i === 2 || i === 5) {
        formatted += ' ';
      }
      formatted += digits[i];
    }
    
    this.value = formatted;
  });
  
  // Localisation
  $('getLocationBtn').onclick = openMapModal;
  $('mapPreview').onclick = openMapModal;
  $('closeMapModalBtn').onclick = closeMapModal;
  $('mapOkBtn').onclick = saveMapLocation;
  
  // Panier
  $('cartItemsList').addEventListener('click', (e) => {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;
    
    const action = btn.dataset.action;
    const id = btn.dataset.id;
    
    if (action === 'increase') {
      if (state.cart[id]) {
        const product = state.cart[id];
        const stockQuantity = getStockQuantity(product.code);
        
        if (state.cart[id].quantity + 1 > stockQuantity) {
          showToast(`‚ùå Stock insuffisant. Il reste ${stockQuantity} unit√©(s)`, 'error');
          return;
        }
        
        state.cart[id].quantity++;
        updateGlobalStock(product.code, 1);
        updateCartUI();
      }
    } else if (action === 'decrease') {
      removeFromCart(id, 1);
    }
  });
  
  $('clearCartBtn').onclick = clearCart;
  $('placeOrderBtn').onclick = openOrderModal;
  
  // Modal produit
  $('closeProductModalBtn').onclick = closeProductModal;
  $('modalCloseBottomBtn').onclick = closeProductModal;
  
  $('modalDecreaseBtn').onclick = () => {
    if (!state.currentModalProduct) return;
    const productId = generateProductId(state.currentModalProduct);
    state.quantityPicks[productId] = Math.max(0, (state.quantityPicks[productId] || 0) - 1);
    updateModalQuantity();
  };
  
  $('modalIncreaseBtn').onclick = () => {
    if (!state.currentModalProduct) return;
    const productId = generateProductId(state.currentModalProduct);
    const stockQuantity = getStockQuantity(state.currentModalProduct.code);
    const currentQuantity = state.quantityPicks[productId] || 0;
    
    if (currentQuantity + 1 > stockQuantity) {
      showToast(`‚ùå Stock insuffisant. Il reste ${stockQuantity} unit√©(s)`, 'error');
      return;
    }
    
    state.quantityPicks[productId] = currentQuantity + 1;
    updateModalQuantity();
  };
  
  $('modalAddToCartBtn').onclick = () => {
    if (!state.currentModalProduct) return;
    const productId = generateProductId(state.currentModalProduct);
    const quantity = state.quantityPicks[productId] || 0;
    
    if (quantity > 0) {
      addToCart(productId, state.currentModalProduct, quantity);
      closeProductModal();
    }
  };
  
  // Navigation entre produits dans le modal
  $('modalPrevImageBtn').onclick = navigateToPrevProduct;
  $('modalNextImageBtn').onclick = navigateToNextProduct;
  
  // Modal commande - MODIFI√â pour ajouter aux statistiques
  $('closeOrderModalBtn').onclick = closeOrderModal;
  $('copyOrderBtn').onclick = copyOrderToClipboard;
  $('downloadOrderBtn').onclick = downloadOrder;
  $('whatsappOrderBtn').onclick = sendOrderViaWhatsApp;
  
  // Gestionnaire d'√©v√©nements clavier
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if ($('productModal').classList.contains('open')) {
        closeProductModal();
      } else if ($('qrModal').classList.contains('open')) {
        closeQrModal();
      } else if ($('editTextModal').classList.contains('open')) {
        closeEditTextModal();
      } else if ($('mapModal').classList.contains('open')) {
        closeMapModal();
      } else if ($('orderModal').classList.contains('open')) {
        closeOrderModal();
      } else if ($('drawer').classList.contains('open')) {
        closeDrawer();
      }
      // NOUVEAU: Fermer les nouveaux modals
      const promoModal = document.getElementById('promoManagementModal');
      if (promoModal && promoModal.classList.contains('open')) {
        closePromoManagementModal();
      }
      const statsModal = document.getElementById('statsModal');
      if (statsModal && statsModal.classList.contains('open')) {
        closeStatsModal();
      }
      const stockModal = document.getElementById('stockManagementModal');
      if (stockModal && stockModal.classList.contains('open')) {
        closeStockManagementModal();
      }
    }
    
    if ($('productModal').classList.contains('open')) {
      if (e.key === 'ArrowLeft') {
        $('modalPrevImageBtn').click();
      } else if (e.key === 'ArrowRight') {
        $('modalNextImageBtn').click();
      } else if (e.key === 'Enter' && !$('modalAddToCartBtn').disabled) {
        $('modalAddToCartBtn').click();
      }
    }
  });
  
  // NOUVEAU: Syst√®me de synchronisation en temps r√©el
  setupRealTimeSync();
  
  // Charger les produits
  loadAllProducts();
  
  updateUserUI();
  updateCartUI();
  
  if (!state.user) {
    setTimeout(() => {
      showToast('üëã Bienvenue ! Veuillez cr√©er votre compte pour commander');
    }, 1000);
  }
  
  // Enregistrer Service Worker pour PWA
  registerServiceWorker();
}

// NOUVELLE FONCTION: Synchronisation en temps r√©el
function setupRealTimeSync() {
  // Utiliser BroadcastChannel pour la communication entre onglets
  if (typeof BroadcastChannel !== 'undefined') {
    try {
      const channel = new BroadcastChannel('maxi_jdc_updates');
      
      channel.onmessage = (event) => {
        const data = event.data;
        
        switch (data.type) {
          case 'promotions_updated':
            console.log('Promotions mises √† jour depuis un autre onglet');
            loadGlobalPromotions();
            applyGlobalPromotions();
            showToast('üîÑ Promotions mises √† jour', 'warning');
            break;
            
          case 'stock_updated':
            console.log('Stock mis √† jour depuis un autre onglet');
            loadGlobalStock();
            renderProducts();
            showToast('üîÑ Stock mis √† jour', 'warning');
            break;
        }
      };
      
      // Synchronisation p√©riodique (toutes les 30 secondes)
      state.syncInterval = setInterval(() => {
        // Recharger les donn√©es pour synchronisation
        loadGlobalPromotions();
        loadGlobalStock();
      }, 30000);
      
    } catch (e) {
      console.log('BroadcastChannel non support√©, synchronisation limit√©e');
    }
  }
}

// MODIFIER: Fonction openOrderModal pour inclure les statistiques
function openOrderModal() {
  if (!state.user) {
    showToast('Veuillez d\'abord enregistrer votre compte', 'warning');
    openDrawer();
    return;
  }
  
  const cartItems = Object.values(state.cart);
  if (cartItems.length === 0) {
    showToast('Votre panier est vide', 'warning');
    return;
  }
  
  const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const shipping = subtotal >= CONFIG.freeShipping ? 0 : CONFIG.shippingFee;
  const total = subtotal + shipping;
  
  if (subtotal < CONFIG.minOrder) {
    showToast(`Minimum commande: ${formatPrice(CONFIG.minOrder)}`, 'warning');
    return;
  }
  
  const displayPhone = state.user.displayPhone || formatPhoneNumber(state.user.phone);
  
  let summary = `=== COMMANDE MAXI JDC MARKET ===\n\n`;
  summary += `üìÖ Date: ${new Date().toLocaleString('fr-FR')}\n`;
  summary += `üë§ Client: ${state.user.name}\n`;
  summary += `üìû T√©l√©phone: +216 ${displayPhone}\n`;
  summary += `üìç Adresse: ${state.user.address}\n`;
  if (state.user.lat && state.user.lng) {
    summary += `üó∫Ô∏è Coordonn√©es: ${state.user.lat}, ${state.user.lng}\n`;
  }
  summary += `\n=== ARTICLES ===\n\n`;
  
  cartItems.forEach(item => {
    const lineTotal = item.price * item.quantity;
    summary += `‚Ä¢ ${item.name}\n`;
    summary += `  Code: ${item.code} | Qt√©: ${item.quantity} | Prix: ${formatPrice(item.price)}\n`;
    summary += `  Total: ${formatPrice(lineTotal)}\n\n`;
  });
  
  summary += `=== TOTAUX ===\n\n`;
  summary += `Sous-total: ${formatPrice(subtotal)}\n`;
  summary += `Livraison: ${shipping === 0 ? 'GRATUITE' : formatPrice(shipping)}\n`;
  summary += `TOTAL: ${formatPrice(total)}\n\n`;
  summary += `=== INFORMATIONS ===\n\n`;
  summary += `üìç Jardins de Carthage\n`;
  summary += `üïí 7am ‚Äì 1am\n`;
  summary += `üì± WhatsApp: +216 25 600 978\n`;
  summary += `üí≥ Paiement √† la livraison\n`;
  
  $('orderDetails').textContent = summary;
  $('orderModal').classList.add('open');
  document.body.style.overflow = 'hidden';
  
  // NOUVEAU: Ajouter aux statistiques
  const orderData = {
    name: state.user.name,
    phone: state.user.phone,
    address: state.user.address,
    items: cartItems.map(item => ({
      name: item.name,
      code: item.code,
      price: item.price,
      quantity: item.quantity
    })),
    subtotal: subtotal,
    shipping: shipping,
    total: total,
    itemCount: cartItems.reduce((sum, item) => sum + item.quantity, 0)
  };
  
  addToOrderHistory(orderData);
  addSaleToStats(orderData); // <-- NOUVEAU: Ajouter aux statistiques
  
  state.cart = {};
  updateCartUI();
}

// MODIFIER: Fonction renderProducts pour am√©liorer la gestion des images
function renderProducts() {
  const products = getFilteredProducts();
  const totalPages = Math.ceil(products.length / CONFIG.itemsPerPage) || 1;
  
  if (state.currentPage > totalPages) {
    state.currentPage = totalPages || 1;
  }
  
  $('pageInfo').textContent = `Page ${state.currentPage}/${totalPages}`;
  $('pageInfoBottom').textContent = `Page ${state.currentPage}/${totalPages}`;
  $('itemCount').textContent = `${products.length} article(s)`;
  
  $('prevPageBtn').disabled = state.currentPage === 1;
  $('nextPageBtn').disabled = state.currentPage === totalPages;
  $('prevPageBottomBtn').disabled = state.currentPage === 1;
  $('nextPageBottomBtn').disabled = state.currentPage === totalPages;
  
  $('paginationBottom').style.display = totalPages > 1 ? 'flex' : 'none';
  
  const startIndex = (state.currentPage - 1) * CONFIG.itemsPerPage;
  const endIndex = startIndex + CONFIG.itemsPerPage;
  const productsToShow = products.slice(startIndex, endIndex);
  
  const grid = $('productsGrid');
  grid.innerHTML = '';
  
  if (productsToShow.length === 0) {
    grid.innerHTML = `
      <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);">
        <div style="font-size:48px;margin-bottom:15px;">üîç</div>
        <h3 style="margin-bottom:10px;color:var(--text);">Aucun produit trouv√©</h3>
        <p>Essayez de modifier votre recherche ou s√©lectionnez une autre cat√©gorie</p>
      </div>
    `;
    return;
  }
  
  productsToShow.forEach(product => {
    const productId = generateProductId(product);
    const inStock = isInStockGlobal(product.code);
    const stockQuantity = getStockQuantity(product.code);
    
    // NOUVEAU: Utiliser la fonction am√©lior√©e pour les images
    const imgSrc = getProductImageSrc(product.code, product.name);
    const hasImage = imgSrc && !state.missingImages.has(product.code);
    
    const card = document.createElement('div');
    card.className = `product-card ${product.isPromotion ? 'promo-card' : ''}`;
    
    // Calculer le pourcentage de r√©duction
    let discountPercent = 0;
    if (product.isPromotion && product.oldPrice) {
      discountPercent = Math.round((1 - product.price / product.oldPrice) * 100);
    }
    
    const imagePromoBadge = discountPercent > 0 
      ? `<div class="image-promo-badge">-${discountPercent}%</div>`
      : '';
    
    const oldPriceDisplay = product.isPromotion && product.oldPrice 
      ? `<div class="product-old-price">${formatPrice(product.oldPrice)}</div>`
      : '';
    
    card.innerHTML = `
      <div class="product-image">
        ${hasImage ? `
          <img src="${imgSrc}" 
               alt="${product.name}"
               onload="this.style.display='block'; this.parentElement.querySelector('.no-photo').style.display='none';"
               onerror="this.style.display='none'; this.parentElement.querySelector('.no-photo').style.display='flex'; state.missingImages.add('${product.code}');">
        ` : ''}
        <div class="no-photo" style="${hasImage ? 'display:none;' : 'display:flex;'}">
          ${product.code}<br>
          <span style="font-size:9px;margin-top:5px;">${product.name}</span>
        </div>
        ${imagePromoBadge}
      </div>
      
      <div class="product-info">
        <div class="product-name">${product.name}</div>
        <div class="product-meta">
          <div>Code: ${product.code}</div>
          <div>${product.category}</div>
        </div>
        <div class="product-price">
          ${oldPriceDisplay}
          ${formatPrice(product.price)}
        </div>
      </div>
      
      <div class="product-stock-tag ${inStock ? 'ok' : 'no'}">
        ${inStock ? `‚úì ${stockQuantity} en stock` : '‚úó Rupture'}
      </div>
    `;
    
    card.addEventListener('click', () => {
      openProductModal(product);
    });
    
    grid.appendChild(card);
  });
}

// D√©marrer l'application
document.addEventListener('DOMContentLoaded', init);

// NOUVELLE FONCTION: Pr√©charger les images au d√©marrage
window.addEventListener('load', () => {
  setTimeout(() => {
    preloadMissingImages();
  }, 2000);
});
</script>
</body>
</html>
