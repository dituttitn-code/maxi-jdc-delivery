<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAXI JDC MARKET ‚Äì Commande en ligne</title>

  <style>
    :root{
      --bg:#0b0f14; --panel:#111826; --panel2:#0f1520;
      --text:#e8eef7; --muted:#9bb0c6; --line:rgba(255,255,255,.10);
      --accent:#2bd576; --danger:#ff4d4d; --shadow:0 16px 40px rgba(0,0,0,.35);
      --r:14px; --r2:20px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(11,15,20,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 18px}
    .brand{display:flex;gap:10px;align-items:center}
    .logoMark{width:40px;height:40px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);display:grid;place-items:center;font-weight:900}
    .title b{display:block;font-size:15px}
    .title small{color:var(--muted);font-size:12px}
    .chips{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .chip{display:inline-flex;gap:8px;align-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);padding:8px 10px;border-radius:999px;font-size:12px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;padding:0 18px 14px 18px}
    .input{flex:1;min-width:260px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:999px;padding:10px 14px;color:var(--text);outline:none}
    .btn{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--text);padding:10px 12px;border-radius:999px;cursor:pointer;font-weight:900}
    .btn:hover{border-color:rgba(255,255,255,.22)}
    .btn.green{background:rgba(43,213,118,.16);border-color:rgba(43,213,118,.35)}
    .btn.gold{background:rgba(255,215,120,.12);border-color:rgba(255,215,120,.35)}
    .notice{margin:10px 18px 0 18px;padding:10px 12px;border:1px dashed rgba(255,255,255,.14);border-radius:var(--r);color:var(--muted);font-size:12px;background:rgba(17,24,38,.30)}
    main{padding:18px}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:14px;align-items:start}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(17,24,38,.70);border:1px solid rgba(255,255,255,.10);border-radius:var(--r2);box-shadow:var(--shadow)}
    .cardHead{padding:14px;border-bottom:1px solid rgba(255,255,255,.08)}
    .cardHead h3{margin:0;font-size:14px}
    .cardHead small{color:var(--muted)}
    .catList{padding:10px}
    .catItem{width:100%;text-align:left;background:transparent;border:1px solid rgba(255,255,255,.08);color:var(--text);padding:12px;border-radius:14px;margin-bottom:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .catItem.active{border-color:rgba(43,213,118,.45);background:rgba(43,213,118,.08)}
    .catItem .sub{color:var(--muted);font-size:12px;margin-top:3px}
    .pill{min-width:72px;text-align:center;font-weight:1000;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06)}
    .productsTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;padding:14px 14px 0 14px}
    .productsTop h2{margin:0;font-size:16px}
    .pager{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px}
    .iconBtn{width:34px;height:34px;border-radius:999px;display:grid;place-items:center;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);cursor:pointer}
    .iconBtn:hover{border-color:rgba(255,255,255,.22)}
    .productsMeta{color:var(--muted);font-size:12px;padding:0 14px 10px 14px}
    .productGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:14px}
    @media(max-width:1100px){.productGrid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:620px){.productGrid{grid-template-columns:1fr}}
    .pCard{border:1px solid rgba(255,255,255,.10);background:rgba(15,21,32,.65);border-radius:18px;padding:12px;display:flex;flex-direction:column;gap:10px;min-height:110px}
    .pTop{display:flex;justify-content:space-between;gap:10px}
    .pName{font-weight:1000;font-size:13px;line-height:1.2}
    .pCode{color:var(--muted);font-size:11px;margin-top:4px}
    .price{font-weight:1000;border:1px solid rgba(43,213,118,.35);background:rgba(43,213,118,.10);color:#d9ffe9;padding:6px 10px;border-radius:999px;height:max-content;min-width:70px;text-align:center}
    .pActions{display:flex;gap:8px;margin-top:auto}
    .qtyBtn{flex:1;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--text);border-radius:12px;padding:9px 10px;font-weight:1000;cursor:pointer}
    .qtyBtn.add{border-color:rgba(43,213,118,.35);background:rgba(43,213,118,.14)}

    /* ‚úÖ PANIER bouton haut √† droite */
    .cart-fab{
      position:fixed; right:16px; top:16px; left:auto; bottom:auto;
      z-index:9999; padding:10px 14px; border-radius:999px;
      border:1px solid rgba(255,255,255,.15); background:rgba(17,24,38,.95);
      color:#fff; cursor:pointer; font-weight:1000; box-shadow:var(--shadow);
      display:flex;gap:8px;align-items:center;
    }
    .cart-badge{display:inline-grid;place-items:center;min-width:22px;height:22px;padding:0 6px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(43,213,118,.18);font-weight:1000;font-size:12px}

    /* ‚úÖ PANIER drawer cach√© par d√©faut */
    .cart-drawer{
      position:fixed; top:0; right:0; height:100vh; width:min(420px,96vw);
      background:rgba(17,24,38,.98); border-left:1px solid rgba(255,255,255,.10);
      transform:translateX(110%); transition:.25s ease; z-index:9998;
      display:flex;flex-direction:column; box-shadow:var(--shadow);
    }
    .cart-drawer.open{transform:translateX(0)}
    .cart-header{display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid rgba(255,255,255,.10)}
    .cart-header h3{margin:0;font-size:15px}
    .cart-close{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text);border-radius:999px;padding:8px 10px;cursor:pointer;font-weight:1000}
    .cart-body{padding:12px;overflow:auto;flex:1;display:flex;flex-direction:column;gap:10px}
    .cart-row{border:1px solid rgba(255,255,255,.10);background:rgba(15,21,32,.55);border-radius:16px;padding:10px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .cart-row b{font-size:12px}
    .cart-row small{color:var(--muted)}
    .cart-qty{display:flex;gap:6px;align-items:center}
    .miniBtn{width:30px;height:30px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--text);font-weight:1000;cursor:pointer}
    .miniBtn.danger{border-color:rgba(255,77,77,.35);background:rgba(255,77,77,.12)}
    .cart-footer{border-top:1px solid rgba(255,255,255,.10);padding:12px 14px;display:flex;flex-direction:column;gap:10px}
    .cart-total{display:flex;justify-content:space-between;align-items:center}
    .cart-actions{display:flex;gap:10px}
    .cart-hint{color:var(--muted);font-size:12px}

    /* ‚úÖ MODAL cach√© par d√©faut */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999;padding:16px}
    .modal.open{display:flex}
    .modalCard{width:min(760px,96vw);background:rgba(17,24,38,.98);border:1px solid rgba(255,255,255,.12);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    .modalHead{padding:14px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;justify-content:space-between;align-items:center}
    .modalHead h3{margin:0;font-size:15px}
    .modalBody{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.modalBody{grid-template-columns:1fr}}
    .field label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    .field input,.field select,.field textarea{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
      color:var(--text); outline:none;
    }
    .field textarea{min-height:90px;resize:vertical}
    .modalFoot{padding:14px;border-top:1px solid rgba(255,255,255,.10);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .smallNote{color:var(--muted);font-size:12px;margin-top:-6px}

    /* Admin (cach√©) */
    .adminBox{display:none;margin-top:10px;padding:12px;border-top:1px solid rgba(255,255,255,.10)}
    .adminBox.open{display:block}
    .adminRow{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .adminRow .field{flex:1;min-width:180px}
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logoMark" title="M/JDC/M">M</div>
        <div class="title">
          <b>MAXI JDC MARKET</b>
          <small>Des prix mini ‚Äî Un MAXI choix</small>
        </div>
      </div>
      <div class="chips">
        <div class="chip">üìç Jardins de Carthage, derri√®re mosqu√©e Essalem</div>
        <div class="chip">üïò 7h ‚Äì 1h</div>
        <div class="chip">üí¨ WhatsApp: 00216 25 600 978</div>
      </div>
    </div>

    <div class="controls">
      <input id="q" class="input" placeholder="Rechercher un produit (nom, cat√©gorie, code)..." />
      <button id="clearBtn" class="btn">Effacer</button>
      <button id="globalBtn" class="btn green">Recherche globale</button>
    </div>

    <div class="notice" id="statusLine">‚úÖ Donn√©es charg√©es depuis /data/*.csv ‚Äî une cat√©gorie = un fichier CSV.</div>
  </header>

  <!-- ‚úÖ BOUTON PANIER (visible tout de suite) -->
  <button id="cartFab" class="cart-fab" type="button" title="Ouvrir le panier">
    üõí Panier <span id="cartBadge" class="cart-badge">0</span>
  </button>

  <!-- ‚úÖ PANIER (drawer) -->
  <aside id="cartDrawer" class="cart-drawer" aria-hidden="true">
    <div class="cart-header">
      <h3>üõí Votre panier</h3>
      <button id="cartClose" class="cart-close" type="button">Fermer ‚úñ</button>
    </div>

    <div id="cartItems" class="cart-body"></div>

    <div class="cart-footer">
      <div class="cart-total">
        <span>Total</span>
        <b id="cartTotal">0 dt</b>
      </div>
      <div class="cart-actions">
        <button id="cartClear" class="btn" type="button">Vider</button>
        <button id="openCheckout" class="btn gold" type="button">Valider commande</button>
      </div>
      <div class="cart-hint">
        Minimum livraison : <b>15 dt</b> ‚Ä¢ Livraison gratuite si total ‚â• <b>30 dt</b> sinon frais <b>5 dt</b> ‚Ä¢ Retrait magasin possible
      </div>
    </div>
  </aside>

  <main class="wrap">
    <div class="grid">
      <!-- Cat√©gories -->
      <div class="card">
        <div class="cardHead">
          <h3>Cat√©gories</h3>
          <small>Choisis une cat√©gorie CSV</small>
        </div>
        <div id="catList" class="catList"></div>
      </div>

      <!-- Produits -->
      <div class="card">
        <div class="productsTop">
          <h2 id="catTitle">Produits</h2>
          <div class="pager">
            <button id="prevPage" class="iconBtn" title="Page pr√©c√©dente">‚óÄ</button>
            <span id="pageInfo">Page 1/1</span>
            <button id="nextPage" class="iconBtn" title="Page suivante">‚ñ∂</button>
          </div>
        </div>
        <div class="productsMeta" id="catMeta">‚Äî</div>
        <div id="productGrid" class="productGrid"></div>

        <!-- Admin cach√© -->
        <div id="adminBox" class="adminBox">
          <div class="smallNote">üîí Admin invisible pour les clients. Pour l‚Äôouvrir : ajoute <b>#admin</b> √† la fin du lien.</div>
          <div class="adminRow">
            <div class="field">
              <label>Code article</label>
              <input id="adminCode" placeholder="Ex: 4124">
            </div>
            <div class="field">
              <label>Nouveau prix (dt)</label>
              <input id="adminPrice" placeholder="Ex: 6.5">
            </div>
            <button id="saveAdminPrice" class="btn green" type="button">Enregistrer prix</button>
            <button id="clearAdminPrices" class="btn" type="button">Effacer prix admin</button>
          </div>
          <div class="smallNote">Les prix admin sont enregistr√©s dans ce navigateur (localStorage).</div>
        </div>
      </div>
    </div>
  </main>

  <!-- ‚úÖ MODAL fiche client -->
  <div id="checkoutModal" class="modal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalHead">
        <h3>üë§ Informations client</h3>
        <button id="closeCheckout" class="cart-close" type="button">Fermer ‚úñ</button>
      </div>

      <div class="modalBody">
        <div class="field">
          <label>Nom & Pr√©nom *</label>
          <input id="cName" placeholder="Ex: Lotfi Khelifi">
        </div>
        <div class="field">
          <label>T√©l√©phone *</label>
          <input id="cPhone" placeholder="Ex: 25 600 978">
        </div>
        <div class="field">
          <label>Mode *</label>
          <select id="cMode">
            <option value="Livraison">Livraison</option>
            <option value="Retrait magasin">Retrait magasin</option>
          </select>
        </div>
        <div class="field">
          <label>Adresse livraison *</label>
          <input id="cAddr" placeholder="Ex: Jardins de Carthage, derri√®re mosqu√©e Essalem">
          <div class="smallNote">Si Retrait magasin : mets ‚ÄúRetrait‚Äù.</div>
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>Note (optionnel)</label>
          <textarea id="cNote" placeholder="Ex: Interphone, √©tage, heure souhait√©e..."></textarea>
          <div class="smallNote">* Champs obligatoires. (Aucun point fid√©lit√© ici.)</div>
        </div>
      </div>

      <div class="modalFoot">
        <button id="sendWhatsApp" class="btn green" type="button">Envoyer sur WhatsApp</button>
      </div>
    </div>
  </div>

  <script>
    // ===================== CONFIG =====================
    const WHATSAPP_NUMBER = "0021625600978";
    const MIN_DELIVERY = 15;
    const FREE_DELIVERY_FROM = 30;
    const DELIVERY_FEE = 5;
    const PAGE_SIZE = 24;

    const CATEGORIES = [
      { id:"fruits_legumes", name:"Fruits & L√©gumes", file:"data/fruits_legumes.csv" },
      { id:"lait_oeufs_produits_frais", name:"Lait, ≈íufs & Produits frais", file:"data/lait_oeufs_produits_frais.csv" },
      { id:"fromage_charcuterie", name:"Fromage & Charcuterie", file:"data/fromage_charcuterie.csv" },
      { id:"boulangerie_patisserie", name:"Boulangerie & P√¢tisserie", file:"data/boulangerie_patisserie.csv" },
      { id:"epicerie_salee", name:"√âpicerie Sal√©e", file:"data/epicerie_salee.csv" },
      { id:"epicerie_sucree", name:"√âpicerie Sucr√©e", file:"data/epicerie_sucree.csv" },
      { id:"pates", name:"P√¢tes", file:"data/pates.csv" },
      { id:"conserves", name:"Conserves", file:"data/conserves.csv" },
    ];

    // ===================== STATE =====================
    let currentCat = CATEGORIES[0];
    let products = [];
    let filtered = [];
    let currentPage = 1;
    let globalSearch = false;

    const cart = loadJSON("maxi_cart_v1", []);
    const adminPrices = loadJSON("maxi_admin_prices_v1", {}); // {code: price}

    // ===================== HELPERS =====================
    function $(id){ return document.getElementById(id); }
    function money(n){
      const x = Math.round((Number(n)||0)*100)/100;
      return (x % 1 === 0) ? String(x.toFixed(0)) : String(x.toFixed(2));
    }
    function loadJSON(key, fallback){
      try{ return JSON.parse(localStorage.getItem(key) || "") ?? fallback; }catch(e){ return fallback; }
    }
    function saveJSON(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }
    function normalize(s){
      return (s||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    }
    function parseCSV(text){
      const lines = text.replace(/\r/g,"").split("\n").filter(l => l.trim().length);
      if(!lines.length) return [];
      const header = lines[0].split(";").map(h => h.trim());
      const idxCode = header.findIndex(h => normalize(h).includes("code"));
      const idxName = header.findIndex(h => normalize(h).includes("design"));
      const idxPrice= header.findIndex(h => normalize(h).includes("price"));
      const out=[];
      for(let i=1;i<lines.length;i++){
        const cols = lines[i].split(";");
        const code = (cols[idxCode]||"").trim();
        const name = (cols[idxName]||"").trim();
        let price = (cols[idxPrice]||"").trim().replace(",",".");
        if(!code || !name) continue;
        out.push({
          code,
          name,
          price: Number(price||0),
          cat: currentCat.name
        });
      }
      return out;
    }

    // ===================== UI: Categories =====================
    async function buildCategories(){
      const box = $("catList");
      box.innerHTML = "";
      for(const c of CATEGORIES){
        const btn = document.createElement("button");
        btn.className = "catItem" + (c.id===currentCat.id ? " active" : "");
        btn.innerHTML = `
          <div>
            <div style="font-weight:1000">${c.name}</div>
            <div class="sub">CSV: ${c.file.replace("data/","")}</div>
          </div>
          <div class="pill" id="count_${c.id}">‚Ä¶</div>
        `;
        btn.onclick = () => { currentCat=c; globalSearch=false; currentPage=1; refreshAll(); };
        box.appendChild(btn);
      }
    }

    function setActiveCategory(){
      document.querySelectorAll(".catItem").forEach(el => el.classList.remove("active"));
      const idx = CATEGORIES.findIndex(x=>x.id===currentCat.id);
      if(idx>=0) document.querySelectorAll(".catItem")[idx].classList.add("active");
    }

    // ===================== DATA LOAD =====================
    async function loadCategory(cat){
      try{
        const res = await fetch(cat.file, {cache:"no-store"});
        if(!res.ok) throw new Error("CSV introuvable: "+cat.file);
        const text = await res.text();
        return parseCSV(text).map(p => ({...p, cat:cat.name}));
      }catch(e){
        return [];
      }
    }

    async function refreshAll(){
      setActiveCategory();
      $("catTitle").textContent = currentCat.name;
      $("catMeta").textContent = `Chargement‚Ä¶`;
      $("productGrid").innerHTML = "";

      if(globalSearch){
        // load all categories
        let all=[];
        for(const c of CATEGORIES){
          const arr = await loadCategory(c);
          all = all.concat(arr);
          $("count_"+c.id).textContent = arr.length+" article(s)";
        }
        products = all;
        $("catTitle").textContent = "Recherche globale";
        $("catMeta").textContent = `Total: ${products.length} article(s) ‚Äî toutes cat√©gories`;
      }else{
        products = await loadCategory(currentCat);
        $("catMeta").textContent = `Source: ${currentCat.file} ‚Ä¢ Mise √† jour rapide (prix + nouveaux articles)`;
        // update counts for current only (others unknown if not loaded)
        $("count_"+currentCat.id).textContent = products.length+" article(s)";
      }

      applyFilter();
      renderProducts();
      renderCart();
      updateAdminVisibility();
    }

    // ===================== SEARCH / FILTER =====================
    function applyFilter(){
      const q = normalize($("q").value.trim());
      if(!q){
        filtered = products.slice();
      }else{
        filtered = products.filter(p => {
          const hay = normalize(p.name + " " + p.code + " " + p.cat);
          return hay.includes(q);
        });
      }
      currentPage = 1;
    }

    // ===================== PRODUCTS RENDER =====================
    function getPrice(p){
      const ap = adminPrices[p.code];
      return (ap!=null && ap!=="" && !Number.isNaN(Number(ap))) ? Number(ap) : Number(p.price||0);
    }

    function renderProducts(){
      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      currentPage = Math.min(currentPage, pages);

      $("pageInfo").textContent = `Page ${currentPage}/${pages}`;

      const start = (currentPage-1)*PAGE_SIZE;
      const slice = filtered.slice(start, start+PAGE_SIZE);

      const grid = $("productGrid");
      grid.innerHTML = "";

      for(const p of slice){
        const price = getPrice(p);
        const card = document.createElement("div");
        card.className = "pCard";
        card.innerHTML = `
          <div class="pTop">
            <div>
              <div class="pName">${escapeHtml(p.name)}</div>
              <div class="pCode">Code: ${escapeHtml(p.code)} ‚Ä¢ ${escapeHtml(p.cat)}</div>
            </div>
            <div class="price">${money(price)} dt</div>
          </div>
          <div class="pActions">
            <button class="qtyBtn add" type="button">Ajouter</button>
          </div>
        `;
        card.querySelector(".add").onclick = () => addToCart(p.code, p.name, price);
        grid.appendChild(card);
      }

      // pager buttons
      $("prevPage").disabled = (currentPage<=1);
      $("nextPage").disabled = (currentPage>=pages);
      $("prevPage").onclick = () => { if(currentPage>1){ currentPage--; renderProducts(); } };
      $("nextPage").onclick = () => { if(currentPage<pages){ currentPage++; renderProducts(); } };
    }

    function escapeHtml(s){
      return (s??"").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ===================== CART =====================
    function addToCart(code, name, price){
      const i = cart.findIndex(x => x.code===code);
      if(i>=0) cart[i].qty += 1;
      else cart.push({code, name, price, qty:1});
      saveJSON("maxi_cart_v1", cart);
      renderCart();
      // open cart for feedback
      openCart();
    }

    function cartTotal(){
      return cart.reduce((s,x)=> s + (Number(x.price||0)*Number(x.qty||0)), 0);
    }

    function renderCart(){
      const badge = $("cartBadge");
      const itemsBox = $("cartItems");
      const totalBox = $("cartTotal");

      const count = cart.reduce((s,x)=> s + (Number(x.qty||0)), 0);
      badge.textContent = String(count);

      itemsBox.innerHTML = "";
      if(!cart.length){
        itemsBox.innerHTML = `<div style="color:var(--muted);font-size:13px;padding:10px">Panier vide.</div>`;
      }else{
        for(const it of cart){
          const row = document.createElement("div");
          row.className = "cart-row";
          row.innerHTML = `
            <div>
              <b>${escapeHtml(it.name)}</b><br/>
              <small>Code: ${escapeHtml(it.code)} ‚Ä¢ ${money(it.price)} dt</small>
            </div>
            <div class="cart-qty">
              <button class="miniBtn" type="button">-</button>
              <b style="min-width:18px;text-align:center">${it.qty}</b>
              <button class="miniBtn" type="button">+</button>
              <button class="miniBtn danger" title="Supprimer" type="button">‚úñ</button>
            </div>
          `;
          const [bMinus, , bPlus, bDel] = row.querySelectorAll("button");
          bMinus.onclick = () => { it.qty = Math.max(1, it.qty-1); saveJSON("maxi_cart_v1", cart); renderCart(); };
          bPlus.onclick  = () => { it.qty += 1; saveJSON("maxi_cart_v1", cart); renderCart(); };
          bDel.onclick   = () => { const idx = cart.indexOf(it); if(idx>=0) cart.splice(idx,1); saveJSON("maxi_cart_v1", cart); renderCart(); };
          itemsBox.appendChild(row);
        }
      }

      totalBox.textContent = money(cartTotal()) + " dt";
    }

    // ===================== CART OPEN/CLOSE =====================
    function openCart(){
      $("cartDrawer").classList.add("open");
      $("cartDrawer").setAttribute("aria-hidden","false");
    }
    function closeCart(){
      $("cartDrawer").classList.remove("open");
      $("cartDrawer").setAttribute("aria-hidden","true");
    }

    // ===================== CHECKOUT MODAL =====================
    function openCheckout(){
      if(!cart.length){
        alert("Votre panier est vide.");
        return;
      }
      $("checkoutModal").classList.add("open");
      $("checkoutModal").setAttribute("aria-hidden","false");
    }
    function closeCheckout(){
      $("checkoutModal").classList.remove("open");
      $("checkoutModal").setAttribute("aria-hidden","true");
    }

    function buildWhatsAppMessage(){
      const name = $("cName").value.trim();
      const phone= $("cPhone").value.trim();
      const mode = $("cMode").value;
      const addr = $("cAddr").value.trim();
      const note = $("cNote").value.trim();

      if(!name || !phone || !mode || !addr){
        alert("Merci de remplir les champs obligatoires (*).");
        return null;
      }

      const total = cartTotal();
      if(mode==="Livraison" && total < MIN_DELIVERY){
        alert("Minimum livraison : " + MIN_DELIVERY + " dt");
        return null;
      }

      let frais = 0;
      if(mode==="Livraison"){
        frais = (total >= FREE_DELIVERY_FROM) ? 0 : DELIVERY_FEE;
      }

      const lines = [];
      lines.push("üõí *Nouvelle commande ‚Äì MAXI JDC MARKET*");
      lines.push("");
      lines.push("üë§ Client: " + name);
      lines.push("üìû T√©l√©phone: " + phone);
      lines.push("üöö Mode: " + mode);
      lines.push("üìç Adresse: " + addr);
      if(note) lines.push("üìù Note: " + note);
      lines.push("");
      lines.push("üì¶ Articles:");
      cart.forEach((it,i)=>{
        lines.push(`${i+1}) ${it.name} (Code ${it.code}) √ó${it.qty} = ${money(it.price*it.qty)} dt`);
      });
      lines.push("");
      lines.push(`üí∞ Sous-total: ${money(total)} dt`);
      if(mode==="Livraison"){
        lines.push(`üöö Frais livraison: ${money(frais)} dt`);
      }
      lines.push(`‚úÖ Total √† payer: ${money(total+frais)} dt`);
      return lines.join("\n");
    }

    function sendToWhatsApp(){
      const msg = buildWhatsAppMessage();
      if(!msg) return;
      const url = "https://wa.me/" + WHATSAPP_NUMBER + "?text=" + encodeURIComponent(msg);
      window.open(url, "_blank");
    }

    // ===================== ADMIN (HIDDEN) =====================
    function updateAdminVisibility(){
      const isAdmin = (location.hash || "").toLowerCase().includes("admin");
      const box = $("adminBox");
      if(!isAdmin){
        box.classList.remove("open");
        return;
      }
      const pin = prompt("PIN Admin:");
      if(pin !== "2025"){
        alert("PIN incorrect.");
        location.hash = "";
        box.classList.remove("open");
        return;
      }
      box.classList.add("open");
    }

    function saveAdminPrice(){
      const code = $("adminCode").value.trim();
      const price = $("adminPrice").value.trim().replace(",",".");
      if(!code || !price){
        alert("Code et prix requis.");
        return;
      }
      const p = Number(price);
      if(Number.isNaN(p) || p<0){
        alert("Prix invalide.");
        return;
      }
      adminPrices[code] = p;
      saveJSON("maxi_admin_prices_v1", adminPrices);
      alert("Prix enregistr√© (local).");
      renderProducts();
    }
    function clearAdmin(){
      if(!confirm("Effacer tous les prix admin de ce navigateur ?")) return;
      for(const k of Object.keys(adminPrices)) delete adminPrices[k];
      saveJSON("maxi_admin_prices_v1", adminPrices);
      renderProducts();
    }

    // ===================== EVENTS =====================
    $("cartFab").addEventListener("click", openCart);
    $("cartClose").addEventListener("click", closeCart);
    $("cartClear").addEventListener("click", () => {
      if(!confirm("Vider le panier ?")) return;
      cart.length = 0;
      saveJSON("maxi_cart_v1", cart);
      renderCart();
    });
    $("openCheckout").addEventListener("click", openCheckout);
    $("closeCheckout").addEventListener("click", closeCheckout);
    $("sendWhatsApp").addEventListener("click", sendToWhatsApp);

    $("q").addEventListener("input", () => { applyFilter(); renderProducts(); });
    $("clearBtn").addEventListener("click", () => { $("q").value=""; applyFilter(); renderProducts(); });
    $("globalBtn").addEventListener("click", async () => { globalSearch=true; currentPage=1; await refreshAll(); });

    window.addEventListener("hashchange", () => updateAdminVisibility());
    $("saveAdminPrice").addEventListener("click", saveAdminPrice);
    $("clearAdminPrices").addEventListener("click", clearAdmin);

    // ===================== START =====================
    (async function start(){
      await buildCategories();
      await refreshAll();

      // service worker (si tu l'as)
      if("serviceWorker" in navigator){
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("./service-worker.js")
            .then(()=>console.log("Service Worker OK ‚úÖ"))
            .catch(err=>console.log("Service Worker erreur ‚ùå", err));
        });
      }
    })();
  </script>
</body>
</html>
