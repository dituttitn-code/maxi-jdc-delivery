<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAXI JDC MARKET ‚Äì Livraison</title>

  <style>
    :root{
      --bg:#0b0b0c;
      --card:#121214;
      --soft:#1b1b1e;
      --text:#f3f3f5;
      --muted:#a8a8b3;
      --accent:#00c853;
      --accent-soft:rgba(0,200,83,.25);
      --border:#2a2a2f;
      --radius:18px;
      --radius-sm:14px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 800px at 10% -10%, #1a1a1f 0%, var(--bg) 55%);
      color:var(--text);
    }

    .wrap{max-width:1100px;margin:0 auto;padding:14px 12px 48px}

    header{
      position:sticky;top:0;z-index:20;
      background:linear-gradient(180deg, rgba(11,11,12,.95) 0%, rgba(11,11,12,.78) 75%, rgba(11,11,12,.0) 100%);
      backdrop-filter: blur(8px);
      padding:10px 0 14px;
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(18,18,20,.72);
      border-radius:22px;
      padding:10px 12px;
    }

    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:42px;height:42px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:#111;
      overflow:hidden;
      display:grid;place-items:center;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{margin:0;font-size:15px;letter-spacing:.6px}
    .slogan{margin:2px 0 0;color:var(--muted);font-size:12px}

    .header-actions{display:flex;align-items:center;gap:10px}
    .header-info{display:flex;flex-direction:column;gap:3px;font-size:12px;color:var(--muted)}
    .header-info strong{color:var(--text)}
    .header-qr{display:flex;align-items:center;gap:8px}
    .qr-mini{
      width:44px;height:44px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;background:#fff;
    }
    .qr-mini img{width:100%;height:100%;object-fit:cover}

    .cart-button{
      display:flex;align-items:center;gap:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(18,18,20,.85);
      padding:8px 10px;border-radius:999px;
      user-select:none;
      min-width:140px;justify-content:space-between;
    }
    .cart-total-mini{font-size:12px;color:var(--muted)}
    .cart-count-badge{
      min-width:22px;height:22px;border-radius:999px;
      background:var(--accent);color:#021a0c;
      display:grid;place-items:center;
      font-weight:800;font-size:12px;
    }

    .section-title{
      margin:18px 0 10px;
      font-size:16px;
      color:var(--text);
    }

    .categories-list{
      display:flex;flex-wrap:wrap;gap:8px;
      margin-bottom:12px;
    }
    .category-pill{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(16,16,18,.7);
      color:var(--text);
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
    }
    .category-pill.active{
      background:var(--accent-soft);
      border-color:rgba(0,200,83,.45);
      color:#eafff2;
      font-weight:700;
    }

    .search-row{
      display:flex;
      gap:10px;
      align-items:center;
      margin:10px 0 12px;
      flex-wrap:wrap;
    }
    .search-bar{
      display:flex;gap:8px;align-items:center;
      flex:1;
      min-width:260px;
    }
    .search-bar input{
      flex:1;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(18,18,20,.8);
      color:var(--text);
      outline:none;
    }
    .icon-btn{
      border:none;
      background:rgba(18,18,20,.9);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.10);
      font-weight:800;
    }
    .icon-btn.green{
      background:var(--accent);
      color:#021a0c;
      border:none;
    }

    .pager-tools{
      display:flex;
      align-items:center;
      gap:8px;
      margin-left:auto;
    }
    .pager-tools label{
      font-size:12px;
      color:var(--muted);
    }
    select{
      background:rgba(18,18,20,.85);
      color:var(--text);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:8px 10px;
      outline:none;
      cursor:pointer;
      font-size:12px;
    }

    .products-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(190px, 1fr));
      gap:10px;
    }

    .product-card{
      border-radius:var(--radius-sm);
      border:1px solid rgba(255,255,255,.08);
      background:rgba(18,18,20,.92);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:320px;
    }

    /* ‚úÖ IMAGE: m√™me hauteur + centr√©e + jamais coup√©e */
    .product-media{
      width:100%;
      height:140px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:#0b0b0c;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      padding:8px;
    }
    .product-media img{
      width:100%;
      height:100%;
      object-fit:contain;
      object-position:center;
      display:block;
      filter: none;
    }

    .product-header{
      display:flex;justify-content:space-between;gap:8px;align-items:flex-start;
    }
    .product-name{font-weight:800;font-size:13px;line-height:1.15}
    .product-meta{font-size:12px;color:var(--muted);margin-top:2px}
    .product-price{
      font-weight:900;
      font-size:14px;
      text-align:right;
      white-space:nowrap;
    }

    .product-actions{
      margin-top:auto;
      display:flex;justify-content:space-between;align-items:center;gap:8px;
    }

    .qty-control{
      display:inline-flex;align-items:center;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background:rgba(16,16,18,.75);
    }
    .qty-control button{
      border:none;background:transparent;color:var(--text);
      padding:6px 10px;font-size:16px;cursor:pointer;
    }
    .qty-control span{padding:0 10px;color:var(--text);min-width:22px;text-align:center}

    .btn-add{
      flex:1;
      border:none;
      background:var(--accent);
      color:#021a0c;
      font-weight:900;
      padding:10px 10px;
      border-radius:999px;
      cursor:pointer;
      line-height:1.1;
    }

    .small-text{font-size:12px;color:var(--muted)}
    #loading{padding:12px;color:var(--muted)}
    #empty{padding:12px;color:var(--muted);display:none}

    /* Pagination bar */
    .pagination{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      margin:14px 0 0;
      flex-wrap:wrap;
    }
    .page-btn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(18,18,20,.85);
      color:var(--text);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      min-width:44px;
      text-align:center;
    }
    .page-btn.active{
      background:var(--accent-soft);
      border-color:rgba(0,200,83,.45);
      color:#eafff2;
    }
    .page-btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .page-info{
      font-size:12px;
      color:var(--muted);
      padding:0 6px;
    }

    @media (max-width:540px){
      .header-info{display:none}
      .product-card{min-height:310px}
      .product-media{height:130px}
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo">
            <img src="logo-maxi-jdc-market.jpg" alt="MAXI JDC MARKET">
          </div>
          <div>
            <h1>MAXI JDC MARKET</h1>
            <div class="slogan">Des prix mini ‚Äì Un MAXI choix</div>
          </div>
        </div>

        <div class="header-actions">
          <div class="header-info">
            <div>üìç Jardins de Carthage, derri√®re mosqu√©e Esselem</div>
            <div>‚è∞ 7h ‚Äì 1h du matin</div>
            <div>üì± WhatsApp : <strong>00216 25 600 978</strong></div>
          </div>

          <div class="header-qr">
            <div class="qr-mini" title="QR site">
              <img src="qr-maxi-jdc-site.jpg" alt="QR MAXI JDC MARKET">
            </div>
          </div>

          <div class="cart-button">
            <div>
              <div style="font-weight:800">üß∫ Panier</div>
              <div class="cart-total-mini"><span id="mini-cart-total">0,000</span> dt</div>
            </div>
            <div class="cart-count-badge" id="mini-cart-count">0</div>
          </div>
        </div>
      </div>

      <h3 class="section-title">Cat√©gories</h3>
      <div class="categories-list" id="categories-container"></div>

      <div class="search-row">
        <div class="search-bar">
          <input id="search" placeholder="Rechercher un produit‚Ä¶" />
          <button id="clear-search" class="icon-btn" type="button">X</button>
        </div>

        <div class="pager-tools">
          <label for="pageSize">Par page</label>
          <select id="pageSize">
            <option value="16">16</option>
            <option value="24" selected>24</option>
            <option value="36">36</option>
            <option value="60">60</option>
          </select>
        </div>
      </div>

      <h3 class="section-title">Produits</h3>
      <div id="loading">Chargement des produits‚Ä¶</div>
      <div id="empty">Aucun produit trouv√©.</div>
      <div class="products-grid" id="products-container"></div>

      <div class="pagination" id="pagination"></div>
    </div>
  </header>

  <script>
    // =========================
    // CONFIG
    // =========================
    const PRODUCTS_JSON_URL = "products.json";
    const PLACEHOLDER = "placeholder.jpg";

    // ‚úÖ Tes corrections (codes ‚Üí cat√©gorie)
    const CATEGORY_OVERRIDES_BY_CODE = {
      "2481": "Hygi√®ne et entretien",
      "3143": "Hygi√®ne et entretien",
      "2482": "Hygi√®ne et entretien",
      "4497": "Hygi√®ne et entretien",

      "4484": "√âpicerie sal√©e",
      "4485": "√âpicerie sal√©e",

      "2999": "Surgel√©s",
      "2639": "Surgel√©s",

      "1335": "Fruits secs & Graines",
      "4322": "Boissons"
    };

    // ‚úÖ R√®gles ‚Äúsmart‚Äù si d‚Äôautres erreurs arrivent
    function smartCategoryFix(name, currentCat){
      const n = (name || "").toUpperCase();

      // Nettoyage / entretien
      if (/(JUDY|LILAS|LESSIVE|LAVANT|SOL|SURFACES|JEL LAVANT|LIQUIDE VAISSELLE|NETTOYANT)/.test(n))
        return "Hygi√®ne et entretien";

      // Salades / conserves sal√©es
      if (/(SALADE|MECHWIA|HARISSA|THONA|MAKROUNA|CONSERVE|SAUCE|TOMATE|SANNEFA)/.test(n))
        return "√âpicerie sal√©e";

      // Glaces / bouza / surgel√©s
      if (/(GLACE|BOUZA|LONDON DAIRY|ICE|CORNET|FROZEN)/.test(n))
        return "Surgel√©s";

      // Boissons (ex: ‚Äú√† boire‚Äù, ‚Äújus‚Äù, etc.)
      if (/(A BOIRE|JUS|BOISSON|SODA|NECTAR)/.test(n))
        return "Boissons";

      return currentCat;
    }

    // =========================
    // IMAGE PATH
    // =========================
    // R√àGLE SIMPLE POUR TOI :
    // - Tu upload une photo nomm√©e 4731.jpg dans /images/products/
    // - Tu peux laisser "image":"placeholder.jpg" dans products.json
    // => le site met automatiquement images/products/4731.jpg
    function resolveImagePath(product){
      const code = String(product.code || product.CODE_ARTICLE || product.id || "").trim();
      const raw = String(product.image || product.imageUrl || product.IMAGE_URL || "").trim();

      // Si un chemin complet est fourni, on le garde
      if (raw && raw !== PLACEHOLDER && raw !== ("images/products/" + PLACEHOLDER) && raw !== ("images/" + PLACEHOLDER)){
        if (!raw.includes("/")) return "images/products/" + raw; // ex: "4731.jpg"
        return raw; // ex: "images/products/4731.jpg"
      }

      // Sinon: automatique via code
      if (code) return "images/products/" + code + ".jpg";

      return "images/products/" + PLACEHOLDER;
    }

    // Si l'image n'existe pas: fallback vers /images/<code>.jpg puis placeholder
    function attachImageFallback(imgEl, product){
      const code = String(product.code || product.CODE_ARTICLE || product.id || "").trim();
      let tried = 0;

      imgEl.addEventListener("error", () => {
        tried++;
        if (tried === 1 && code) {
          imgEl.src = "images/" + code + ".jpg";
          return;
        }
        imgEl.src = "images/products/" + PLACEHOLDER;
      });
    }

    // =========================
    // STATE
    // =========================
    let ALL = [];
    let activeCategory = "Tout";
    let searchTerm = "";

    // Pagination
    let pageSize = 24;
    let currentPage = 1;

    // =========================
    // HELPERS
    // =========================
    function fmtDt(n){
      const x = Number(n || 0);
      return x.toFixed(3).replace(".", ",");
    }

    function normalizeCategory(c){
      const s = String(c || "Divers").trim();
      return s ? s : "Divers";
    }

    function safeNum(v){
      const n = Number(String(v ?? "").replace(",", ".").trim());
      return Number.isFinite(n) ? n : 0;
    }

    function getProductsArray(data){
      // support: [..]  OR  {products:[..]} OR {items:[..]} OR {data:[..]}
      if (Array.isArray(data)) return data;
      if (data && Array.isArray(data.products)) return data.products;
      if (data && Array.isArray(data.items)) return data.items;
      if (data && Array.isArray(data.data)) return data.data;
      return [];
    }

    function buildCategories(products){
      const set = new Set(["Tout"]);
      products.forEach(p => set.add(normalizeCategory(p.category)));
      return Array.from(set);
    }

    function renderCategories(cats){
      const wrap = document.getElementById("categories-container");
      wrap.innerHTML = "";
      cats.forEach(cat => {
        const b = document.createElement("button");
        b.className = "category-pill" + (cat === activeCategory ? " active" : "");
        b.textContent = cat;
        b.onclick = () => {
          activeCategory = cat;
          currentPage = 1; // reset page
          render();
        };
        wrap.appendChild(b);
      });
    }

    function productMatches(p){
      const catOk = (activeCategory === "Tout") || (p.category === activeCategory);
      if (!catOk) return false;

      if (!searchTerm) return true;
      const q = searchTerm.toLowerCase().trim();
      const hay = (p.name + " " + p.category + " " + (p.code||"")).toLowerCase();
      return hay.includes(q);
    }

    function paginate(list){
      const total = list.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      currentPage = Math.min(currentPage, totalPages);

      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      return {
        total,
        totalPages,
        slice: list.slice(start, end)
      };
    }

    function renderPagination(total, totalPages){
      const el = document.getElementById("pagination");
      el.innerHTML = "";

      if (total === 0) return;
      if (totalPages <= 1) {
        const info = document.createElement("div");
        info.className = "page-info";
        info.textContent = `${total} article(s)`;
        el.appendChild(info);
        return;
      }

      const prev = document.createElement("button");
      prev.className = "page-btn";
      prev.textContent = "‚óÄ";
      prev.disabled = (currentPage <= 1);
      prev.onclick = () => { currentPage--; render(); };
      el.appendChild(prev);

      // pages affich√©es (max 7 boutons)
      const maxBtns = 7;
      let start = Math.max(1, currentPage - 3);
      let end = Math.min(totalPages, start + maxBtns - 1);
      start = Math.max(1, end - maxBtns + 1);

      if (start > 1) {
        const b1 = document.createElement("button");
        b1.className = "page-btn";
        b1.textContent = "1";
        b1.onclick = () => { currentPage = 1; render(); };
        el.appendChild(b1);

        if (start > 2){
          const dots = document.createElement("div");
          dots.className = "page-info";
          dots.textContent = "‚Ä¶";
          el.appendChild(dots);
        }
      }

      for (let p = start; p <= end; p++){
        const b = document.createElement("button");
        b.className = "page-btn" + (p === currentPage ? " active" : "");
        b.textContent = String(p);
        b.onclick = () => { currentPage = p; render(); };
        el.appendChild(b);
      }

      if (end < totalPages) {
        if (end < totalPages - 1){
          const dots = document.createElement("div");
          dots.className = "page-info";
          dots.textContent = "‚Ä¶";
          el.appendChild(dots);
        }

        const bl = document.createElement("button");
        bl.className = "page-btn";
        bl.textContent = String(totalPages);
        bl.onclick = () => { currentPage = totalPages; render(); };
        el.appendChild(bl);
      }

      const next = document.createElement("button");
      next.className = "page-btn";
      next.textContent = "‚ñ∂";
      next.disabled = (currentPage >= totalPages);
      next.onclick = () => { currentPage++; render(); };
      el.appendChild(next);

      const info = document.createElement("div");
      info.className = "page-info";
      info.textContent = `Page ${currentPage}/${totalPages} ‚Ä¢ ${total} article(s)`;
      el.appendChild(info);
    }

    function makeCard(p){
      const card = document.createElement("div");
      card.className = "product-card";

      const media = document.createElement("div");
      media.className = "product-media";

      const img = document.createElement("img");
      img.alt = p.name || "Produit";
      img.src = resolveImagePath(p);
      attachImageFallback(img, p);

      media.appendChild(img);

      const header = document.createElement("div");
      header.className = "product-header";

      const left = document.createElement("div");

      const name = document.createElement("div");
      name.className = "product-name";
      name.textContent = p.name;

      const meta = document.createElement("div");
      meta.className = "product-meta";
      meta.textContent = `${p.category} ‚Ä¢ ${p.code || ""}`.trim();

      left.appendChild(name);
      left.appendChild(meta);

      const price = document.createElement("div");
      price.className = "product-price";
      price.innerHTML = `${fmtDt(p.price)} dt<br/><span class="small-text">/ ${p.unit || "pi√®ce"}</span>`;

      header.appendChild(left);
      header.appendChild(price);

      const actions = document.createElement("div");
      actions.className = "product-actions";

      const qty = document.createElement("div");
      qty.className = "qty-control";
      const minus = document.createElement("button");
      minus.textContent = "‚àí";
      const qspan = document.createElement("span");
      qspan.textContent = "1";
      const plus = document.createElement("button");
      plus.textContent = "+";

      minus.onclick = () => qspan.textContent = String(Math.max(1, Number(qspan.textContent)-1));
      plus.onclick  = () => qspan.textContent = String(Number(qspan.textContent)+1);

      qty.appendChild(minus);
      qty.appendChild(qspan);
      qty.appendChild(plus);

      const add = document.createElement("button");
      add.className = "btn-add";
      add.textContent = "Ajouter au panier";
      add.onclick = () => {
        // mini panier simple (compteur + total) ‚Äì sans popup
        const countEl = document.getElementById("mini-cart-count");
        const totalEl = document.getElementById("mini-cart-total");
        const c = Number(countEl.textContent || 0) + Number(qspan.textContent || 1);
        const t = safeNum(totalEl.textContent.replace(",", ".")) + (safeNum(p.price) * Number(qspan.textContent || 1));
        countEl.textContent = String(c);
        totalEl.textContent = fmtDt(t);
      };

      actions.appendChild(qty);
      actions.appendChild(add);

      card.appendChild(media);
      card.appendChild(header);
      card.appendChild(actions);

      return card;
    }

    function render(){
      const cats = buildCategories(ALL);
      renderCategories(cats);

      const filtered = ALL.filter(productMatches);
      const { total, totalPages, slice } = paginate(filtered);

      const grid = document.getElementById("products-container");
      grid.innerHTML = "";

      document.getElementById("loading").style.display = "none";
      document.getElementById("empty").style.display = (total === 0) ? "block" : "none";

      slice.forEach(p => grid.appendChild(makeCard(p)));
      renderPagination(total, totalPages);
    }

    // =========================
    // LOAD
    // =========================
    async function init(){
      const res = await fetch(PRODUCTS_JSON_URL, { cache:"no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();

      const items = getProductsArray(data);

      ALL = items.map((r) => {
        const code = String(r.code || r.CODE_ARTICLE || r.id || r.Code || "").trim();
        const name = String(r.name || r.DESIGNATION || r.designation || r.NOM || "").trim();
        let category = normalizeCategory(r.category || r.CATEGORIE || r.categorie || "Divers");

        // override code
        if (CATEGORY_OVERRIDES_BY_CODE[code]) category = CATEGORY_OVERRIDES_BY_CODE[code];

        // smart fix
        category = smartCategoryFix(name, category);

        return {
          code,
          name: name || ("Article " + code),
          category,
          price: safeNum(r.price ?? r.PRX ?? r.PRIX ?? r.prix),
          unit: String(r.unit || r.UNITE || r.unite || "pi√®ce"),
          image: String(r.image || r.imageUrl || r.IMAGE_URL || PLACEHOLDER)
        };
      });

      // tri (optionnel): par cat√©gorie puis nom
      ALL.sort((a,b) => (a.category.localeCompare(b.category) || a.name.localeCompare(b.name)));

      renderCategories(buildCategories(ALL));
      render();
    }

    // events
    document.getElementById("search").addEventListener("input", (e)=>{
      searchTerm = e.target.value || "";
      currentPage = 1;
      render();
    });

    document.getElementById("clear-search").onclick = ()=>{
      document.getElementById("search").value = "";
      searchTerm = "";
      currentPage = 1;
      render();
    };

    document.getElementById("pageSize").addEventListener("change", (e)=>{
      pageSize = Number(e.target.value || 24);
      currentPage = 1;
      render();
    });

    init().catch(err=>{
      console.error(err);
      document.getElementById("loading").textContent =
        "Erreur de chargement (products.json). V√©rifie que products.json est √† la racine du d√©p√¥t.";
    });
  </script>
</body>
</html>
