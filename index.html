<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAXI JDC MARKET ‚Äì Livraison</title>

  <style>
    :root{
      --bg:#0b0b0c;
      --card:#121214;
      --soft:#1b1b1e;
      --text:#f3f3f5;
      --muted:#a8a8b3;
      --accent:#00c853;
      --accent-soft:rgba(0,200,83,.25);
      --border:#2a2a2f;
      --radius:18px;
      --radius-sm:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 800px at 10% -10%, #1a1a1f 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px 12px 48px}

    header{
      position:sticky;top:0;z-index:20;
      background:linear-gradient(180deg, rgba(11,11,12,.95) 0%, rgba(11,11,12,.78) 75%, rgba(11,11,12,.0) 100%);
      backdrop-filter: blur(8px);
      padding:10px 0 14px;
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(18,18,20,.72);
      border-radius:22px;
      padding:10px 12px;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:42px;height:42px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:#111;overflow:hidden;display:grid;place-items:center;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{margin:0;font-size:15px;letter-spacing:.6px}
    .slogan{margin:2px 0 0;color:var(--muted);font-size:12px}

    .header-actions{display:flex;align-items:center;gap:10px}
    .header-info{display:flex;flex-direction:column;gap:3px;font-size:12px;color:var(--muted)}
    .header-info strong{color:var(--text)}
    .qr-mini{
      width:44px;height:44px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;background:#fff;
    }
    .qr-mini img{width:100%;height:100%;object-fit:cover}

    .cart-button{
      display:flex;align-items:center;gap:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(18,18,20,.85);
      padding:8px 10px;border-radius:999px;
      cursor:pointer;user-select:none;
      min-width:140px;justify-content:space-between;
    }
    .cart-total-mini{font-size:12px;color:var(--muted)}
    .cart-count-badge{
      min-width:22px;height:22px;border-radius:999px;
      background:var(--accent);color:#021a0c;
      display:grid;place-items:center;
      font-weight:800;font-size:12px;
    }

    .section-title{margin:18px 0 10px;font-size:16px;color:var(--text)}

    .categories-list{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    .category-pill{
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(16,16,18,.7);
      color:var(--text);font-size:12px;cursor:pointer;white-space:nowrap;
    }
    .category-pill.active{
      background:var(--accent-soft);
      border-color:rgba(0,200,83,.45);
      color:#eafff2;font-weight:700;
    }

    .search-bar{display:flex;gap:8px;align-items:center;margin:10px 0 12px}
    .search-bar input{
      flex:1;padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(18,18,20,.8);
      color:var(--text);outline:none;
    }
    .search-bar button{
      border:none;background:var(--accent);color:#021a0c;
      padding:10px 14px;border-radius:999px;font-weight:800;cursor:pointer;
    }

    .products-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(190px, 1fr));
      gap:10px;
    }

    .product-card{
      border-radius:var(--radius-sm);
      border:1px solid rgba(255,255,255,.08);
      background:rgba(18,18,20,.92);
      padding:10px;
      display:flex;flex-direction:column;gap:8px;
      min-height:320px;
    }

    /* ‚úÖ IMAGES : toujours propres, pas coup√©es */
    .product-img{
      width:100%;
      height:140px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:#ffffff;
      object-fit:contain;
      object-position:center;
      display:block;
      padding:6px;
    }

    .product-header{display:flex;justify-content:space-between;gap:8px;align-items:flex-start}
    .product-name{font-weight:800;font-size:13px;line-height:1.15}
    .product-meta{font-size:12px;color:var(--muted);margin-top:2px}
    .product-price{font-weight:900;font-size:14px;text-align:right;white-space:nowrap}
    .small-text{font-size:12px;color:var(--muted)}

    .product-actions{
      margin-top:auto;
      display:flex;justify-content:space-between;align-items:center;gap:8px;
    }
    .qty-control{
      display:inline-flex;align-items:center;
      border-radius:999px;border:1px solid rgba(255,255,255,.10);
      overflow:hidden;background:rgba(16,16,18,.75);
    }
    .qty-control button{
      border:none;background:transparent;color:var(--text);
      padding:6px 10px;font-size:16px;cursor:pointer;
    }
    .qty-control span{padding:0 10px;color:var(--text);min-width:22px;text-align:center}

    .btn-add{
      flex:1;border:none;background:var(--accent);color:#021a0c;
      font-weight:900;padding:10px 10px;border-radius:999px;cursor:pointer;line-height:1.1;
    }

    #loading{padding:12px;color:var(--muted)}

    /* ‚úÖ Pagination */
    .pager{
      display:flex;flex-wrap:wrap;gap:8px;
      align-items:center;justify-content:center;
      margin:14px 0 4px;
    }
    .page-btn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(18,18,20,.85);
      color:var(--text);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
      user-select:none;
    }
    .page-btn.active{
      background:var(--accent-soft);
      border-color:rgba(0,200,83,.45);
      font-weight:800;
    }
    .page-btn:disabled{
      opacity:.45;cursor:not-allowed;
    }
    .pager-info{
      text-align:center;
      color:var(--muted);
      font-size:12px;
      margin-bottom:10px;
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo">
            <img src="logo-maxi-jdc-market.jpg" alt="MAXI JDC MARKET">
          </div>
          <div>
            <h1>MAXI JDC MARKET</h1>
            <div class="slogan">Des prix mini ‚Äì Un MAXI choix</div>
          </div>
        </div>

        <div class="header-actions">
          <div class="header-info">
            <div>üìç Jardins de Carthage, derri√®re mosqu√©e Esselem</div>
            <div>‚è∞ 7h ‚Äì 1h du matin</div>
            <div>üì± WhatsApp : <strong>00216 25 600 978</strong></div>
          </div>

          <div class="qr-mini" title="QR site">
            <img src="qr-maxi-jdc-site.jpg" alt="QR MAXI JDC MARKET">
          </div>

          <div class="cart-button" id="open-cart">
            <div>
              <div style="font-weight:800">üß∫ Panier</div>
              <div class="cart-total-mini"><span id="mini-cart-total">0,000</span> dt</div>
            </div>
            <div class="cart-count-badge" id="mini-cart-count">0</div>
          </div>
        </div>
      </div>

      <h3 class="section-title">Cat√©gories</h3>
      <div class="categories-list" id="categories-container"></div>

      <div class="search-bar">
        <input id="search" placeholder="Rechercher un produit‚Ä¶" />
        <button id="clear-search" type="button">X</button>
      </div>

      <h3 class="section-title">Produits</h3>
      <div id="loading">Chargement des produits‚Ä¶</div>
      <div class="products-grid" id="products-container"></div>

      <!-- Pagination -->
      <div class="pager" id="pager"></div>
      <div class="pager-info" id="pager-info"></div>
    </div>
  </header>

  <script>
    // =========================
    // CONFIG
    // =========================
    const PRODUCTS_JSON_URL = "products.json";

    // ‚úÖ Mets ici le nom de ton placeholder (le fichier doit √™tre dans /images/products/)
    const PLACEHOLDER = "placeholder.jpg";

    // ‚úÖ Nombre d'articles par page (tu peux changer)
    const PAGE_SIZE = 24;

    // ‚úÖ Corrections exactes par code (tes exemples)
    const CATEGORY_OVERRIDES_BY_CODE = {
      "2481": "Hygi√®ne et entretien",
      "3143": "Hygi√®ne et entretien",
      "2482": "Hygi√®ne et entretien",
      "4497": "Hygi√®ne et entretien",

      "4484": "√âpicerie sal√©e",
      "4485": "√âpicerie sal√©e",

      "2999": "Surgel√©s",
      "2639": "Surgel√©s",

      "1335": "Fruits secs & Graines",
      "4322": "Boissons",

      // Exemple ‚Äúpomme‚Äù dans produit m√©nage
      "4202": "Hygi√®ne et entretien"
    };

    // ‚úÖ R√®gles intelligentes (corrige les erreurs de classement)
    function smartCategoryFix(name, currentCat){
      const n = (name || "").toUpperCase();

      // Nettoyage / entretien
      if (/(JUDY|LILAS|LESSIVE|LAVANT|SOL|SURFACES|JEL LAVANT|LIQUIDE VAISSELLE|ASSOUPLISSANT|DETERGENT|NETTOYANT)/.test(n))
        return "Hygi√®ne et entretien";

      // Sal√© / conserves / sauces
      if (/(SALADE|MECHWIA|HARISSA|THONA|MAKROUNA|CONSERVE|SAUCE|TOMATE|OLIVE|CORNICHON)/.test(n))
        return "√âpicerie sal√©e";

      // Glaces / bouza / frozen
      if (/(GLACE|BOUZA|LONDON DAIRY|ICE|CORNET|SORBET)/.test(n))
        return "Surgel√©s";

      // Lait √† boire / boissons lact√©es
      if (/(A BOIRE|NATILAIT|LAIT|MILK)/.test(n))
        return "Boissons";

      return currentCat;
    }

    // ‚úÖ Chemin image automatique : images/products/<CODE>.jpg
    function resolveImagePath(product){
      const code = String(product.code || product.CODE_ARTICLE || product.id || "").trim();
      const raw  = String(product.image || product.imageUrl || product.IMAGE_URL || "").trim();

      // si raw est un chemin complet -> on le garde
      if (raw && raw !== PLACEHOLDER && !raw.endsWith("/"+PLACEHOLDER)){
        if (!raw.includes("/")) return "images/products/" + raw; // raw = "4731.jpg"
        return raw;
      }

      // sinon on force images/products/<code>.jpg
      if (code) return "images/products/" + code + ".jpg";

      // fallback
      return "images/products/" + PLACEHOLDER;
    }

    // fallback si l‚Äôimage n‚Äôexiste pas
    function attachImageFallback(imgEl){
      imgEl.addEventListener("error", () => {
        imgEl.src = "images/products/" + PLACEHOLDER;
      });
    }

    // =========================
    // PANIER (simple)
    // =========================
    const CART_KEY = "maxi_cart_v1";
    function loadCart(){
      try { return JSON.parse(localStorage.getItem(CART_KEY) || "{}"); }
      catch(e){ return {}; }
    }
    function saveCart(cart){
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      updateCartMini();
    }
    function cartAdd(p, qty){
      const cart = loadCart();
      const key = String(p.code || p.id || p.name);
      if (!cart[key]) cart[key] = { code:p.code, name:p.name, price:p.price, unit:p.unit, qty:0 };
      cart[key].qty += qty;
      saveCart(cart);
    }
    function updateCartMini(){
      const cart = loadCart();
      let count = 0;
      let total = 0;
      Object.values(cart).forEach(it=>{
        count += Number(it.qty || 0);
        total += Number(it.qty || 0) * Number(it.price || 0);
      });
      document.getElementById("mini-cart-count").textContent = String(count);
      document.getElementById("mini-cart-total").textContent = fmtDt(total);
    }

    // =========================
    // APP STATE
    // =========================
    let ALL = [];
    let activeCategory = "Tout";
    let searchTerm = "";
    let currentPage = 1;

    // =========================
    // UI HELPERS
    // =========================
    function fmtDt(n){
      const x = Number(n || 0);
      return x.toFixed(3).replace(".", ",");
    }
    function normalizeCategory(c){
      const s = String(c || "Divers").trim();
      return s || "Divers";
    }

    function buildCategories(products){
      const set = new Set(["Tout"]);
      products.forEach(p => set.add(normalizeCategory(p.category)));
      return Array.from(set);
    }

    function renderCategories(cats){
      const wrap = document.getElementById("categories-container");
      wrap.innerHTML = "";
      cats.forEach(cat => {
        const b = document.createElement("button");
        b.className = "category-pill" + (cat === activeCategory ? " active" : "");
        b.textContent = cat;
        b.onclick = () => {
          activeCategory = cat;
          currentPage = 1; // reset page √† chaque changement cat√©gorie
          render();
        };
        wrap.appendChild(b);
      });
    }

    function productMatches(p){
      const catOk = (activeCategory === "Tout") || (p.category === activeCategory);
      if (!catOk) return false;

      if (!searchTerm) return true;
      const q = searchTerm.toLowerCase().trim();
      const hay = (p.name + " " + p.category + " " + (p.code||"")).toLowerCase();
      return hay.includes(q);
    }

    function paginate(list){
      const total = list.length;
      const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      currentPage = Math.min(currentPage, pages);

      const start = (currentPage - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      return { pageItems: list.slice(start, end), total, pages };
    }

    function renderPager(total, pages){
      const pager = document.getElementById("pager");
      const info  = document.getElementById("pager-info");

      pager.innerHTML = "";
      info.textContent = "";

      if (pages <= 1){
        return;
      }

      const prev = document.createElement("button");
      prev.className = "page-btn";
      prev.textContent = "‚óÄ Pr√©c√©dent";
      prev.disabled = currentPage === 1;
      prev.onclick = ()=>{ currentPage--; render(); };
      pager.appendChild(prev);

      // Afficher quelques pages autour (1 ... x x x ... last)
      const windowSize = 5;
      const half = Math.floor(windowSize/2);
      let start = Math.max(1, currentPage - half);
      let end = Math.min(pages, start + windowSize - 1);
      start = Math.max(1, end - windowSize + 1);

      function addPageBtn(p){
        const b = document.createElement("button");
        b.className = "page-btn" + (p === currentPage ? " active" : "");
        b.textContent = String(p);
        b.onclick = ()=>{ currentPage = p; render(); };
        pager.appendChild(b);
      }

      if (start > 1){
        addPageBtn(1);
        if (start > 2){
          const dots = document.createElement("span");
          dots.style.color = "var(--muted)";
          dots.textContent = "‚Ä¶";
          pager.appendChild(dots);
        }
      }

      for (let p=start; p<=end; p++) addPageBtn(p);

      if (end < pages){
        if (end < pages-1){
          const dots2 = document.createElement("span");
          dots2.style.color = "var(--muted)";
          dots2.textContent = "‚Ä¶";
          pager.appendChild(dots2);
        }
        addPageBtn(pages);
      }

      const next = document.createElement("button");
      next.className = "page-btn";
      next.textContent = "Suivant ‚ñ∂";
      next.disabled = currentPage === pages;
      next.onclick = ()=>{ currentPage++; render(); };
      pager.appendChild(next);

      info.textContent = `Page ${currentPage} / ${pages} ‚Äî ${total} article(s)`;
    }

    function render(){
      // refresh style cat√©gories
      renderCategories(buildCategories(ALL));

      const filtered = ALL.filter(productMatches);
      const { pageItems, total, pages } = paginate(filtered);

      const grid = document.getElementById("products-container");
      grid.innerHTML = "";

      pageItems.forEach(p => {
        const card = document.createElement("div");
        card.className = "product-card";

        const img = document.createElement("img");
        img.className = "product-img";
        img.alt = p.name || "Produit";
        img.src = resolveImagePath(p);
        attachImageFallback(img);

        const header = document.createElement("div");
        header.className = "product-header";

        const left = document.createElement("div");

        const name = document.createElement("div");
        name.className = "product-name";
        name.textContent = p.name;

        const meta = document.createElement("div");
        meta.className = "product-meta";
        meta.textContent = `${p.category} ‚Ä¢ ${p.code || ""}`.trim();

        left.appendChild(name);
        left.appendChild(meta);

        const price = document.createElement("div");
        price.className = "product-price";
        price.innerHTML = `${fmtDt(p.price)} dt<br/><span class="small-text">/ ${p.unit || "pi√®ce"}</span>`;

        header.appendChild(left);
        header.appendChild(price);

        const actions = document.createElement("div");
        actions.className = "product-actions";

        const qty = document.createElement("div");
        qty.className = "qty-control";

        const minus = document.createElement("button");
        minus.textContent = "‚àí";

        const qspan = document.createElement("span");
        qspan.textContent = "1";

        const plus = document.createElement("button");
        plus.textContent = "+";

        minus.onclick = () => qspan.textContent = String(Math.max(1, Number(qspan.textContent)-1));
        plus.onclick  = () => qspan.textContent = String(Number(qspan.textContent)+1);

        qty.appendChild(minus);
        qty.appendChild(qspan);
        qty.appendChild(plus);

        const add = document.createElement("button");
        add.className = "btn-add";
        add.textContent = "Ajouter au panier";
        add.onclick = () => {
          cartAdd(p, Number(qspan.textContent || 1));
        };

        actions.appendChild(qty);
        actions.appendChild(add);

        card.appendChild(img);
        card.appendChild(header);
        card.appendChild(actions);

        grid.appendChild(card);
      });

      document.getElementById("loading").style.display = "none";
      renderPager(total, pages);
      updateCartMini();
    }

    // =========================
    // LOAD
    // =========================
    async function init(){
      const res = await fetch(PRODUCTS_JSON_URL, { cache:"no-store" });
      const data = await res.json();

      const items = Array.isArray(data) ? data : (data.products || []);

      ALL = items.map((r) => {
        const code = String(r.code || r.CODE_ARTICLE || r.id || "").trim();
        const name = String(r.name || r.DESIGNATION || "").trim();
        let category = normalizeCategory(r.category || "Divers");

        // 1) Override par code
        if (CATEGORY_OVERRIDES_BY_CODE[code]) category = CATEGORY_OVERRIDES_BY_CODE[code];

        // 2) Correction automatique par mots
        category = smartCategoryFix(name, category);

        return {
          code,
          name,
          category,
          price: Number(r.price || r.PRX || r.PRIX || 0),
          unit: String(r.unit || "pi√®ce"),
          image: String(r.image || PLACEHOLDER)
        };
      });

      renderCategories(buildCategories(ALL));
      render();
    }

    // Search
    document.getElementById("search").addEventListener("input", (e)=>{
      searchTerm = e.target.value || "";
      currentPage = 1;
      render();
    });
    document.getElementById("clear-search").onclick = ()=>{
      document.getElementById("search").value = "";
      searchTerm = "";
      currentPage = 1;
      render();
    };

    // click panier (simple)
    document.getElementById("open-cart").onclick = ()=>{
      const cart = loadCart();
      const lines = Object.values(cart).map(it => `${it.name} x${it.qty} = ${fmtDt(it.qty*it.price)} dt`);
      alert(lines.length ? lines.join("\n") : "Panier vide.");
    };

    init().catch(err=>{
      console.error(err);
      document.getElementById("loading").textContent = "Erreur de chargement (products.json).";
    });
  </script>
</body>
</html>
