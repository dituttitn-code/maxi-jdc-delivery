<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAXI JDC MARKET ‚Äì Commande</title>

  <style>
    :root{
      --bg:#0f1115;
      --panel:#151923;
      --panel2:#0f131b;
      --text:#e9eef7;
      --muted:#a7b0c0;
      --accent:#38d66b;
      --accent2:#2bbd5b;
      --danger:#ff5c5c;
      --border:rgba(255,255,255,.08);
      --shadow:0 8px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 30% 0%, rgba(56,214,107,.18), transparent 60%),
                  radial-gradient(1000px 700px at 100% 20%, rgba(56,214,107,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    header{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      background:rgba(21,25,35,.75); border:1px solid var(--border);
      border-radius:var(--radius); padding:14px 16px; box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:40px;height:40px;border-radius:50%;
      background:linear-gradient(135deg, rgba(56,214,107,.9), rgba(56,214,107,.2));
      display:grid;place-items:center;font-weight:800;color:#07110a;
    }
    .title{line-height:1.15}
    .title b{display:block;font-size:15px}
    .title small{color:var(--muted)}
    .topRight{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(15,19,27,.7);
      color:var(--muted); font-size:12px;
    }
    .btn{
      border:0; cursor:pointer;
      padding:10px 14px;border-radius:999px;
      background:var(--accent); color:#06120a; font-weight:700;
      transition: transform .05s ease;
    }
    .btn:active{transform:scale(.98)}
    .btn.secondary{
      background:transparent; color:var(--text);
      border:1px solid var(--border);
    }

    .panel{
      margin-top:14px;
      background:rgba(21,25,35,.65);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }

    .controls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }
    .searchRow{
      display:flex;gap:10px;align-items:center;flex:1;min-width:260px;
    }
    input[type="search"]{
      width:100%;
      background:rgba(15,19,27,.75);
      border:1px solid var(--border);
      border-radius:999px;
      padding:12px 14px;
      color:var(--text);
      outline:none;
    }
    .cats{
      display:flex;gap:8px;flex-wrap:wrap;margin-top:12px
    }
    .cat{
      cursor:pointer;
      border:1px solid var(--border);
      background:rgba(15,19,27,.70);
      color:var(--text);
      padding:8px 12px;border-radius:999px;
      font-size:12px;
      user-select:none;
    }
    .cat.active{
      border-color: rgba(56,214,107,.55);
      background: rgba(56,214,107,.16);
    }

    .metaRow{
      margin-top:10px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      color:var(--muted);font-size:12px;
    }
    .pager{
      display:flex;gap:8px;align-items:center;
    }
    .iconBtn{
      width:36px;height:36px;border-radius:12px;
      background:rgba(15,19,27,.75);
      border:1px solid var(--border);
      color:var(--text);
      cursor:pointer;
      display:grid;place-items:center;
    }
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width:1100px){ .grid{grid-template-columns: repeat(4,1fr);} }
    @media (max-width:900px){ .grid{grid-template-columns: repeat(3,1fr);} }
    @media (max-width:650px){ .grid{grid-template-columns: repeat(2,1fr);} }
    @media (max-width:420px){ .grid{grid-template-columns: 1fr;} }

    .card{
      background:rgba(15,19,27,.72);
      border:1px solid var(--border);
      border-radius:18px;
      padding:10px;
      overflow:hidden;
      /* IMPORTANT: pas d‚Äôanimation => pas de clignotement */
    }
    .thumb{
      width:100%;
      height:150px;
      border-radius:14px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .thumb img{
      width:100%;height:100%;
      object-fit:cover;   /* ‚úÖ photos bien ajust√©es */
      display:block;
    }
    .pname{margin:10px 0 2px;font-weight:800;font-size:13px}
    .pmeta{color:var(--muted);font-size:12px}
    .row{
      margin-top:10px;
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }
    .price{font-weight:900}
    .qty{
      display:flex;align-items:center;gap:6px;
      background:rgba(255,255,255,.05);
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 8px;
    }
    .qbtn{
      width:28px;height:28px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,19,27,.6);
      color:var(--text);
      cursor:pointer;
      display:grid;place-items:center;
      font-weight:900;
    }
    .qnum{min-width:18px;text-align:center;font-weight:800}
    .add{
      padding:10px 12px;border-radius:999px;border:0;
      background:var(--accent);color:#07130a;font-weight:900;cursor:pointer;
    }
    .empty{
      padding:18px;color:var(--muted);text-align:center;
      border:1px dashed rgba(255,255,255,.15);
      border-radius:16px;
      grid-column:1/-1;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">M</div>
        <div class="title">
          <b>MAXI JDC MARKET</b>
          <small>Des prix mini ‚Äî Un MAXI choix</small>
        </div>
      </div>
      <div class="topRight">
        <span class="pill">üìç Jardins de Carthage, derri√®re mosqu√©e Esselem</span>
        <span class="pill">üïí 7h ‚Äì 1h</span>
        <span class="pill">üí¨ WhatsApp: <b>00216 25 600 978</b></span>
        <button id="btnWhats" class="btn">Panier WhatsApp</button>
      </div>
    </header>

    <div class="panel">
      <div class="controls">
        <div class="searchRow">
          <input id="q" type="search" placeholder="Rechercher un produit (nom, cat√©gorie, code)..." />
          <button id="btnClear" class="btn secondary">Effacer</button>
        </div>
        <div class="pager">
          <span id="counter" class="pill">0 article(s)</span>
          <span id="pageInfo" class="pill">Page 1/1</span>
          <button id="prev" class="iconBtn" title="Pr√©c√©dent">‚óÄ</button>
          <button id="next" class="iconBtn" title="Suivant">‚ñ∂</button>
        </div>
      </div>

      <div id="cats" class="cats"></div>

      <div class="metaRow">
        <div class="pill">
          Conditions: minimum livraison 15 dt ‚Ä¢ Livraison gratuite si total ‚â• 30 dt ‚Ä¢ Sinon frais 5 dt ‚Ä¢ Retrait magasin possible
        </div>
        <div class="pill" id="cartInfo">Panier: 0.000 dt</div>
      </div>

      <div id="grid" class="grid"></div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const JSON_URL = 'products.json';  // ‚úÖ doit rester √† la racine

    const state = {
      data: null,
      selectedCategory: '__ALL__',
      query: '',
      page: 1,
      perPage: 20,
      cart: new Map(), // code/id -> qty
    };

    // ========= UTILS =========
    const $ = (id) => document.getElementById(id);

    function money(dt){
      const n = Number(dt || 0);
      return n.toFixed(3) + ' dt';
    }

    function normalize(s){
      return (s ?? '').toString().trim().toLowerCase();
    }

    function productKey(p){
      // priorit√© au code article si existant, sinon id
      return (p.code ?? p.id ?? p.name);
    }

    function imgPath(p){
      // si ton json met "images/products/4275.jpg" => ok
      // si ton json met juste "4275.jpg" => on corrige
      const img = (p.image ?? '').toString().trim();
      if(!img) return 'images/products/placeholder.jpg';
      if(img.startsWith('images/')) return img;
      if(img.startsWith('img/')) return img; // au cas o√π
      return 'images/products/' + img;
    }

    // ========= LOAD =========
    async function loadData(){
      // cache busting pour GitHub pages
      const url = JSON_URL + '?v=' + Date.now();
      const res = await fetch(url);
      if(!res.ok) throw new Error('Impossible de charger ' + JSON_URL);
      const data = await res.json();

      // s√©curit√© : si pas de categories, on les d√©duit des products
      if(!Array.isArray(data.categories)){
        const set = new Set((data.products||[]).map(p => p.category).filter(Boolean));
        data.categories = Array.from(set);
      }
      data.products = Array.isArray(data.products) ? data.products : [];

      state.data = data;
      buildCategories();
      render();
    }

    // ========= UI: CATEGORIES =========
    function buildCategories(){
      const box = $('cats');
      box.innerHTML = '';

      const makeBtn = (label, value) => {
        const b = document.createElement('div');
        b.className = 'cat' + (state.selectedCategory === value ? ' active' : '');
        b.textContent = label;
        b.onclick = () => {
          state.selectedCategory = value;
          state.page = 1;
          // refresh active style
          [...box.children].forEach(x => x.classList.remove('active'));
          b.classList.add('active');
          render();
        };
        box.appendChild(b);
      };

      makeBtn('Toutes cat√©gories', '__ALL__');
      state.data.categories.forEach(cat => makeBtn(cat, cat));
    }

    // ========= FILTER =========
    function getFiltered(){
      const products = state.data.products;

      let out = products;

      // cat√©gorie (√©galit√© stricte => z√©ro m√©lange)
      if(state.selectedCategory !== '__ALL__'){
        out = out.filter(p => (p.category || '') === state.selectedCategory);
      }

      // recherche globale
      const q = normalize(state.query);
      if(q){
        out = out.filter(p => {
          const blob = [
            p.name, p.designation, p.category,
            p.code, p.id
          ].map(x => normalize(x)).join(' | ');
          return blob.includes(q);
        });
      }

      return out;
    }

    // ========= CART =========
    function cartTotal(){
      let total = 0;
      const byKey = new Map(state.data.products.map(p => [String(productKey(p)), p]));
      for(const [k, qty] of state.cart.entries()){
        const p = byKey.get(String(k));
        if(p) total += (Number(p.price)||0) * qty;
      }
      return total;
    }

    function buildWhatsAppMessage(){
      const byKey = new Map(state.data.products.map(p => [String(productKey(p)), p]));
      const lines = [];
      lines.push('Bonjour MAXI JDC MARKET, je veux commander:');
      for(const [k, qty] of state.cart.entries()){
        const p = byKey.get(String(k));
        if(!p) continue;
        const codeTxt = p.code ? ` (Code: ${p.code})` : '';
        lines.push(`- ${qty} x ${p.name}${codeTxt} ‚Äî ${money(p.price)}`);
      }
      lines.push('Total produits: ' + money(cartTotal()));
      return lines.join('\n');
    }

    function openWhatsApp(){
      const phone = '0021625600978';
      const text = encodeURIComponent(buildWhatsAppMessage());
      const url = `https://wa.me/${phone}?text=${text}`;
      window.open(url, '_blank');
    }

    // ========= RENDER =========
    function render(){
      // rendu stable (pas de setInterval => pas de clignotement)
      const all = getFiltered();
      const total = all.length;

      const totalPages = Math.max(1, Math.ceil(total / state.perPage));
      state.page = Math.min(state.page, totalPages);

      const start = (state.page - 1) * state.perPage;
      const pageItems = all.slice(start, start + state.perPage);

      $('counter').textContent = `${total} article(s)`;
      $('pageInfo').textContent = `Page ${state.page}/${totalPages}`;
      $('cartInfo').textContent = `Panier: ${money(cartTotal())}`;

      $('prev').disabled = state.page <= 1;
      $('next').disabled = state.page >= totalPages;

      const grid = $('grid');
      grid.innerHTML = '';

      if(pageItems.length === 0){
        const e = document.createElement('div');
        e.className = 'empty';
        e.textContent = 'Aucun produit trouv√© (v√©rifie la cat√©gorie ou la recherche).';
        grid.appendChild(e);
        return;
      }

      pageItems.forEach(p => {
        const key = String(productKey(p));
        const qty = state.cart.get(key) || 0;

        const card = document.createElement('div');
        card.className = 'card';

        const thumb = document.createElement('div');
        thumb.className = 'thumb';

        const img = document.createElement('img');
        img.loading = 'lazy';
        img.src = imgPath(p);
        img.alt = p.name || 'Produit';
        img.onerror = () => { img.src = 'images/products/placeholder.jpg'; };
        thumb.appendChild(img);

        const name = document.createElement('div');
        name.className = 'pname';
        name.textContent = p.name || p.designation || 'Sans nom';

        const meta = document.createElement('div');
        meta.className = 'pmeta';
        const codeTxt = p.code ? ` ‚Ä¢ Code: ${p.code}` : '';
        meta.textContent = `${p.category || ''}${codeTxt}`;

        const row = document.createElement('div');
        row.className = 'row';

        const price = document.createElement('div');
        price.className = 'price';
        price.textContent = money(p.price);

        const qtyBox = document.createElement('div');
        qtyBox.className = 'qty';

        const minus = document.createElement('button');
        minus.className = 'qbtn';
        minus.textContent = '‚àí';
        minus.onclick = () => {
          const cur = state.cart.get(key) || 0;
          const n = Math.max(0, cur - 1);
          if(n === 0) state.cart.delete(key);
          else state.cart.set(key, n);
          render();
        };

        const num = document.createElement('div');
        num.className = 'qnum';
        num.textContent = qty;

        const plus = document.createElement('button');
        plus.className = 'qbtn';
        plus.textContent = '+';
        plus.onclick = () => {
          const cur = state.cart.get(key) || 0;
          state.cart.set(key, cur + 1);
          render();
        };

        qtyBox.appendChild(minus);
        qtyBox.appendChild(num);
        qtyBox.appendChild(plus);

        const add = document.createElement('button');
        add.className = 'add';
        add.textContent = 'Ajouter';
        add.onclick = () => {
          const cur = state.cart.get(key) || 0;
          state.cart.set(key, cur + 1);
          render();
        };

        row.appendChild(price);
        row.appendChild(qtyBox);
        row.appendChild(add);

        card.appendChild(thumb);
        card.appendChild(name);
        card.appendChild(meta);
        card.appendChild(row);

        grid.appendChild(card);
      });
    }

    // ========= EVENTS =========
    $('q').addEventListener('input', (e) => {
      state.query = e.target.value || '';
      state.page = 1;
      render();
    });

    $('btnClear').onclick = () => {
      $('q').value = '';
      state.query = '';
      state.page = 1;
      render();
    };

    $('prev').onclick = () => { state.page = Math.max(1, state.page - 1); render(); };
    $('next').onclick = () => { state.page = state.page + 1; render(); };

    $('btnWhats').onclick = () => {
      if(state.cart.size === 0){
        alert('Panier vide. Ajoute des produits avant.');
        return;
      }
      openWhatsApp();
    };

    // ========= START =========
    loadData().catch(err => {
      console.error(err);
      document.body.innerHTML = '<div style="padding:20px;color:#fff;font-family:Arial">Erreur: ' + err.message + '<br>V√©rifie que <b>products.json</b> est √† la racine du d√©p√¥t.</div>';
    });
  </script>
</body>
</html>
