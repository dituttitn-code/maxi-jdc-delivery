<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi des Commandes - MAXI JDC MARKET</title>
    <style>
        :root { --primary: #0a1929; --secondary: #00ff88; --accent: #00d4ff; --light: #f0f6fc; --dark: #1a365d; }
        body { background: linear-gradient(135deg, var(--primary) 0%, #112240 100%); color: var(--light); min-height: 100vh; margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; }
        h1 { color: var(--secondary); }
        .filtres { background: var(--dark); padding: 20px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; }
        .filtres input, .filtres select, .filtres button { padding: 10px; border-radius: 6px; border: 1px solid var(--accent); background: rgba(255,255,255,0.1); color: white; }
        .filtres button { background: var(--secondary); color: var(--primary); font-weight: bold; cursor: pointer; border: none; }
        table { width: 100%; border-collapse: collapse; background: var(--dark); border-radius: 10px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: rgba(0, 255, 136, 0.1); color: var(--secondary); }
        tr:hover { background: rgba(255,255,255,0.05); }
        .statut { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .statut-nouvelle { background: #ff6b6b; color: white; }
        .statut-preparation { background: #ffd93d; color: #000; }
        .statut-pret { background: #6bcf7f; color: white; }
        .statut-livree { background: #4d96ff; color: white; }
        .btn-action { padding: 5px 10px; margin: 0 3px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-edit { background: var(--accent); color: white; }
        .btn-delete { background: #ff6b6b; color: white; }
        .nav { text-align: center; margin-top: 30px; }
        .nav a { color: var(--accent); margin: 0 15px; }
        .empty { text-align: center; padding: 50px; color: #ccc; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“‹ Suivi DÃ©taillÃ© des Commandes</h1>
        <div style="display: flex; gap: 10px;">
            <a href="index.html" style="color: var(--light); text-decoration: none; background: rgba(0,255,136,0.1); padding: 10px 15px; border-radius: 6px;">ğŸ  Accueil</a>
            <a href="tableau-de-bord.html" style="color: var(--light); text-decoration: none; background: rgba(0,212,255,0.1); padding: 10px 15px; border-radius: 6px;">ğŸ“Š Tableau de Bord</a>
        </div>
    </div>

    <div class="filtres">
        <select id="filterStatut" onchange="loadCommandes()">
            <option value="all">Tous les statuts</option>
            <option value="nouvelle">Nouvelles</option>
            <option value="preparation">En prÃ©paration</option>
            <option value="pret">PrÃªtes</option>
            <option value="livree">LivrÃ©es</option>
        </select>
        <input type="text" id="filterSearch" placeholder="Rechercher client ou tÃ©lÃ©phone..." oninput="loadCommandes()">
        <input type="date" id="filterDate" onchange="loadCommandes()">
        <button onclick="exporterCSV()">ğŸ“¥ Exporter CSV</button>
        <button onclick="loadCommandes()" style="background: var(--accent);">ğŸ”„ Actualiser</button>
    </div>

    <table>
        <thead>
            <tr>
                <th width="80">ID</th>
                <th width="150">Date</th>
                <th>Client</th>
                <th width="120">TÃ©lÃ©phone</th>
                <th width="100">Articles</th>
                <th width="100">Total</th>
                <th width="120">Statut</th>
                <th width="120">Source</th>
                <th width="150">Actions</th>
            </tr>
        </thead>
        <tbody id="commandesBody">
            <!-- Rempli dynamiquement -->
        </tbody>
    </table>

    <div id="emptyState" class="empty" style="display: none;">
        <h3>Aucune commande enregistrÃ©e</h3>
        <p>Les commandes apparaÃ®tront ici automatiquement lorsqu'elles seront passÃ©es sur le site ou en caisse.</p>
    </div>

    <div class="nav">
        <a href="commander.html">â• Ajouter une vente en caisse</a>
        <a href="index.html">ğŸ›’ Passer une commande en ligne</a>
    </div>

    <script>
        function loadCommandes() {
            const commandes = JSON.parse(localStorage.getItem('commandesMaxiJDC')) || [];
            const filterStatut = document.getElementById('filterStatut').value;
            const search = document.getElementById('filterSearch').value.toLowerCase();
            const filterDate = document.getElementById('filterDate').value;
            
            const filtered = commandes.filter(cmd => {
                if (filterStatut !== 'all' && cmd.statut !== filterStatut) return false;
                if (search && !cmd.client.toLowerCase().includes(search) && !cmd.telephone.toLowerCase().includes(search)) return false;
                if (filterDate && !cmd.date.includes(filterDate)) return false;
                return true;
            }).sort((a, b) => b.id - a.id);
            
            const tbody = document.getElementById('commandesBody');
            const empty = document.getElementById('emptyState');
            
            if (filtered.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';
            
            tbody.innerHTML = filtered.map(cmd => {
                const statutClass = `statut-${cmd.statut}`;
                return `
                    <tr>
                        <td>${cmd.id}</td>
                        <td>${cmd.date}</td>
                        <td>${cmd.client}</td>
                        <td>${cmd.telephone}</td>
                        <td>${cmd.articles.length} article(s)</td>
                        <td><strong>${cmd.total.toFixed(2)} DT</strong></td>
                        <td><span class="statut ${statutClass}">${cmd.statutLabel}</span></td>
                        <td>${cmd.source === 'application_web' ? 'ğŸŒ En ligne' : 'ğŸ’µ Caisse'}</td>
                        <td>
                            <button class="btn-action btn-edit" onclick="changerStatut(${cmd.id})">ğŸ”„</button>
                            <button class="btn-action btn-delete" onclick="supprimerCommande(${cmd.id})">ğŸ—‘</button>
                            <button class="btn-action" onclick="voirDetails(${cmd.id})" style="background:#9b59b6;">ğŸ‘</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function changerStatut(id) {
            const commandes = JSON.parse(localStorage.getItem('commandesMaxiJDC')) || [];
            const index = commandes.findIndex(c => c.id === id);
            if (index === -1) return;
            
            const statuts = ['nouvelle', 'preparation', 'pret', 'livree'];
            const labels = ['ğŸ†• Nouvelle', 'ğŸ‘¨â€ğŸ³ En prÃ©paration', 'âœ… PrÃªte', 'ğŸšš LivrÃ©e'];
            const current = statuts.indexOf(commandes[index].statut);
            const next = (current + 1) % statuts.length;
            
            commandes[index].statut = statuts[next];
            commandes[index].statutLabel = labels[next];
            localStorage.setItem('commandesMaxiJDC', JSON.stringify(commandes));
            loadCommandes();
            alert(`Statut de la commande #${id} mis Ã  jour : ${labels[next]}`);
        }

        function supprimerCommande(id) {
            if (!confirm(`Supprimer la commande #${id} ?`)) return;
            let commandes = JSON.parse(localStorage.getItem('commandesMaxiJDC')) || [];
            commandes = commandes.filter(c => c.id !== id);
            localStorage.setItem('commandesMaxiJDC', JSON.stringify(commandes));
            loadCommandes();
        }

        function voirDetails(id) {
            const commandes = JSON.parse(localStorage.getItem('commandesMaxiJDC')) || [];
            const cmd = commandes.find(c => c.id === id);
            if (!cmd) return;
            
            let details = `DÃ©tails Commande #${id}\n\n`;
            details += `Client: ${cmd.client}\n`;
            details += `TÃ©lÃ©phone: ${cmd.telephone}\n`;
            details += `Date: ${cmd.date}\n`;
            details += `Statut: ${cmd.statutLabel}\n`;
            details += `Source: ${cmd.source}\n\n`;
            details += `Articles:\n`;
            cmd.articles.forEach(a => {
                details += `- ${a.qte}x ${a.nom} @ ${a.prix} DT = ${(a.qte * a.prix).toFixed(2)} DT\n`;
            });
            details += `\nTotal: ${cmd.total.toFixed(2)} DT`;
            alert(details);
        }

        function exporterCSV() {
            const commandes = JSON.parse(localStorage.getItem('commandesMaxiJDC')) || [];
            if (commandes.length === 0) return alert("Aucune donnÃ©e Ã  exporter.");
            
            let csv = "ID;Date;Client;Telephone;Articles;Total;Statut;Source\n";
            commandes.forEach(cmd => {
                const articles = cmd.articles.map(a => `${a.qte}x ${a.nom}`).join(', ');
                csv += `${cmd.id};"${cmd.date}";"${cmd.client}";"${cmd.telephone}";"${articles}";${cmd.total};"${cmd.statutLabel}";"${cmd.source}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `commandes-maxi-jdc-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            alert(`âœ… ${commandes.length} commande(s) exportÃ©es en CSV`);
        }

        // Actualiser automatiquement toutes les 10 secondes
        window.onload = loadCommandes;
        setInterval(loadCommandes, 10000);
    </script>
</body>
</html>
